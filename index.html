<script>
// 入力: @handle / UC… / /channel/… / /c/… / /user/… / 動画URL / shorts URL / プレイリストURL / 11桁ID など
// 出力: チャンネルID（UCから始まる文字列） or null
async function resolveChannelIdSmart(input, key) {
  const raw = (input || '').trim();

  // 1) すでに UC… なら即返す
  if (/^UC[0-9A-Za-z_-]{22}$/.test(raw)) return raw;

  // 2) 11桁の動画IDだけ来た場合
  if (/^[0-9A-Za-z_-]{11}$/.test(raw)) {
    const cid = await getChannelIdFromVideo(raw, key);
    if (cid) return cid;
  }

  // 3) URLとして解釈してみる
  try {
    const u = new URL(raw);
    const host = u.hostname.replace(/^www\./,'');
    const path = u.pathname.replace(/\/+$/,'');
    const parts = path.split('/').filter(Boolean);

    // watch?v=VIDEO, shorts/VIDEO, embed/VIDEO, live/VIDEO → 動画IDから逆引き
    const vid = u.searchParams.get('v') || (['shorts','embed','live'].includes(parts[0]) ? parts[1] : null);
    if (vid) {
      const cid = await getChannelIdFromVideo(vid.slice(0,11), key);
      if (cid) return cid;
    }

    // playlist?list=PLAYLIST → プレイリストから逆引き
    const list = u.searchParams.get('list');
    if (list) {
      const cid = await getChannelIdFromPlaylist(list, key);
      if (cid) return cid;
    }

    // /channel/UC... → 直接取得
    const mCh = path.match(/\/channel\/(UC[0-9A-Za-z_-]{22})$/);
    if (mCh) return mCh[1];

    // /@handle → 検索で解決
    const mHandle = path.match(/\/@([^/]+)$/);
    if (mHandle) {
      const cid = await searchChannelIdByHandle(mHandle[1], key);
      if (cid) return cid;
    }

    // /c/custom や /user/legacy → 検索で解決（旧URL）
    const mCustom = path.match(/\/(c|user)\/([^/]+)$/);
    if (mCustom) {
      const cid = await searchChannelIdByQuery(mCustom[2], key);
      if (cid) return cid;
    }

    // youtu.be/VIDEO → 動画IDから逆引き
    if (host === 'youtu.be' && parts[0]) {
      const cid = await getChannelIdFromVideo(parts[0].slice(0,11), key);
      if (cid) return cid;
    }
  } catch(_) { /* URLでない → 次へ */ }

  // 4) @handle 文字列
  if (raw.startsWith('@')) {
    const cid = await searchChannelIdByHandle(raw.slice(1), key);
    if (cid) return cid;
  }

  // 5) 最後の手段：キーワード検索
  return await searchChannelIdByQuery(raw, key);
}

// ---- 補助API呼び出し ----
async function getChannelIdFromVideo(videoId, key) {
  const ep = new URL('https://www.googleapis.com/youtube/v3/videos');
  ep.searchParams.set('part','snippet');
  ep.searchParams.set('id', videoId);
  ep.searchParams.set('key', key);
  const r = await fetch(ep);
  if (!r.ok) return null;
  const j = await r.json();
  return j.items?.[0]?.snippet?.channelId || null;
}

async function getChannelIdFromPlaylist(playlistId, key) {
  const ep = new URL('https://www.googleapis.com/youtube/v3/playlists');
  ep.searchParams.set('part','snippet');
  ep.searchParams.set('id', playlistId);
  ep.searchParams.set('key', key);
  const r = await fetch(ep);
  if (!r.ok) return null;
  const j = await r.json();
  return j.items?.[0]?.snippet?.channelId || null;
}

async function searchChannelIdByHandle(handle, key) {
  // シンプルに検索（type=channel）。必要なら厳密化のため後段で channels.list を当てて customUrl を照合する実装にも変更可
  const ep = new URL('https://www.googleapis.com/youtube/v3/search');
  ep.searchParams.set('part','snippet');
  ep.searchParams.set('type','channel');
  ep.searchParams.set('q', handle);
  ep.searchParams.set('maxResults','1');
  ep.searchParams.set('key', key);
  const r = await fetch(ep);
  if (!r.ok) return null;
  const j = await r.json();
  return j.items?.[0]?.id?.channelId || null;
}

async function searchChannelIdByQuery(query, key) {
  const ep = new URL('https://www.googleapis.com/youtube/v3/search');
  ep.searchParams.set('part','snippet');
  ep.searchParams.set('type','channel');
  ep.searchParams.set('q', query);
  ep.searchParams.set('maxResults','1');
  ep.searchParams.set('key', key);
  const r = await fetch(ep);
  if (!r.ok) return null;
  const j = await r.json();
  return j.items?.[0]?.id?.channelId || null;
}
</script>
