<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>YouTube 一括取得・整形（モバイル最適）</title>

<style>
  :root{
    --bg:#0b0b0c; --panel:#121316; --text:#f2f3f5; --muted:#9aa0a6; --bd:#1f2126;
    --accent:#4f8cff; --accent-2:#2962ff; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f7f7fb; --panel:#ffffff; --text:#0a0a0b; --muted:#60656b; --bd:#e7e8ee;
           --accent:#1e88e5; --accent-2:#1565c0; }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif;
    line-height:1.65;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    font-size:clamp(14px, 2.8vw, 16px);
  }
  .wrap{max-width:980px; margin:0 auto; padding:16px;}
  h1{font-size:clamp(18px,4.8vw,22px); margin:0 0 12px;}
  .panel{
    background:var(--panel); border:1px solid var(--bd); border-radius:14px; padding:12px; margin:12px 0;
    box-shadow: 0 1px 2px rgba(0,0,0,.06);
  }
  .muted{color:var(--muted)}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .grid{
    display:grid; gap:10px;
    grid-template-columns: 1fr;
  }
  @media (min-width:720px){ .grid.grid-2{ grid-template-columns: 1fr 1fr; } }
  input,button,select,textarea{
    width:100%; padding:12px 12px; border-radius:10px; border:1px solid var(--bd);
    background:transparent; color:var(--text); outline:none;
  }
  input::placeholder, textarea::placeholder{ color:color-mix(in oklab, var(--muted) 80%, transparent); }
  textarea{ min-height:260px; }
  label{font-weight:600}
  .btn{
    background:var(--accent); border-color:transparent; color:#fff; font-weight:700; cursor:pointer;
    transition: transform .02s ease, background .15s ease;
    text-align:center;
  }
  .btn:active{ transform: translateY(1px); }
  .btn.secondary{ background:transparent; color:var(--accent); border:1px solid var(--accent); }
  .btn.ghost{ background:transparent; color:var(--text); border:1px dashed var(--bd); }
  .chip{
    display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px;
    border:1px solid var(--bd); background:transparent; color:var(--text); font-weight:600;
  }
  .toggle{
    display:flex; border:1px solid var(--bd); border-radius:12px; overflow:hidden; width:100%;
  }
  .toggle > button{
    flex:1 1 0; padding:10px; border:0; background:transparent; color:var(--muted); font-weight:700; cursor:pointer;
  }
  .toggle > button.active{ background:var(--accent); color:#fff; }
  .section-title{font-weight:800; margin:6px 0 10px; font-size:1rem}
  .pill{display:inline-block; padding:.35em .7em; border:1px solid var(--bd); border-radius:999px}
  .kpi{
    display:flex; gap:10px; flex-wrap:wrap; align-items:center;
  }
  .kpi .box{
    flex:1 1 110px; min-width:110px;
    background:transparent; border:1px solid var(--bd); border-radius:12px; padding:10px;
  }
  .kpi .label{color:var(--muted); font-size:.85em}
  .kpi .value{font-weight:900; font-size:1.1em}
  .cards{ display:grid; gap:10px; grid-template-columns: 1fr; }
  @media (min-width:580px){ .cards{ grid-template-columns: 1fr 1fr; } }
  .card{ border:1px solid var(--bd); border-radius:12px; padding:12px; }
  .card .no{ color:var(--muted); font-weight:700 }
  .card .title a{ color:inherit; text-decoration:none; font-weight:800 }
  .stickybar{
    position:sticky; bottom:0; z-index:10; padding:10px; margin-top:10px;
    background:linear-gradient(180deg, color-mix(in oklab, var(--panel) 70%, transparent), var(--panel));
    border:1px solid var(--bd); border-radius:14px;
    display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
  }
  .stickybar .left{ display:flex; gap:10px; flex-wrap:wrap; }
  .count{ font-weight:800; }
  details.preview{ border:1px dashed var(--bd); border-radius:12px; padding:10px; }
  details.preview > summary{ cursor:pointer; font-weight:800 }
  a{ color:var(--accent-2) }
</style>

<div class="wrap">
  <h1>YouTube 一括取得・整形（スマホ最適）</h1>

  <!-- モード切替 -->
  <div class="panel">
    <div class="toggle" id="workToggle" role="tablist" aria-label="作業モード">
      <button type="button" data-mode="collect" class="active" aria-selected="true">取得モード</button>
      <button type="button" data-mode="format" aria-selected="false">整形モード</button>
    </div>
    <p class="muted" style="margin:.6em 0 0">取得：チャンネル/プレイリスト/URLから動画を収集 → 整形まで実行。整形：貼り付けたURL群を整形。</p>
  </div>

  <!-- API/GAS 設定 -->
  <div class="panel">
    <div class="section-title">接続設定</div>
    <div class="toggle" id="apiToggle" role="tablist" aria-label="接続先">
      <button type="button" data-api="client" class="active" aria-selected="true">直接API</button>
      <button type="button" data-api="gas" aria-selected="false">GASバックエンド</button>
    </div>

    <div id="apiRow" class="grid" style="margin-top:10px">
      <div>
        <label>APIキー</label>
        <input id="apiKey" placeholder="YouTube Data API v3 の APIキー" inputmode="text" autocomplete="off" />
      </div>
      <div class="row">
        <button id="saveKey" class="btn" style="flex:1 1 140px">保存</button>
        <span class="muted">（この端末にのみ保存）</span>
      </div>
    </div>

    <div id="gasRow" class="grid hide" style="margin-top:10px">
      <div>
        <label>GAS APP_URL（/exec）</label>
        <input id="appUrl" placeholder="https://script.google.com/macros/s/xxxxxxxx/exec" inputmode="url" />
      </div>
      <div class="muted">※ /dev ではなく /exec を指定してください</div>
    </div>
  </div>

  <!-- 取得モード -->
  <div id="collectBox" class="panel">
    <div class="section-title">取得</div>
    <div class="grid grid-2">
      <div>
        <label>チャンネル / プレイリスト / URL</label>
        <input id="channel" placeholder="@handle / UCxxxxxxxx... / https://.../@handle / 動画URL / プレイリストURL" />
      </div>
      <div>
        <label>最大件数</label>
        <input id="limit" type="number" value="200" min="1" max="5000" />
      </div>
      <div>
        <label>公開日 since</label>
        <input id="since" type="date" />
      </div>
      <div>
        <label>取得時の並び</label>
        <select id="sort">
          <option value="newest" selected>新しい順（公開日）</option>
          <option value="oldest">古い順（公開日）</option>
          <option value="none">そのまま</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="runCollect" class="btn" style="flex:1">取得 → 整形</button>
      <span id="status" class="muted" style="flex:2 1 160px"></span>
    </div>
  </div>

  <!-- 整形モード -->
  <div id="formatBox" class="panel hide">
    <div class="section-title">整形</div>
    <div>
      <label class="muted">動画URLを改行/スペース区切りで貼り付け</label>
      <textarea id="rawUrls" placeholder="例）https://www.youtube.com/watch?v=dQw4w9WgXcQ&#10;https://youtu.be/XXXXXXXXXXX"></textarea>
    </div>
    <div class="grid grid-2">
      <div>
        <label>公開日 since</label>
        <input id="since2" type="date" />
      </div>
      <div>
        <label>取得時の並び</label>
        <select id="sort2">
          <option value="none" selected>入力順のまま</option>
          <option value="newest">新しい順（公開日）</option>
          <option value="oldest">古い順（公開日）</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="runFormat" class="btn" style="flex:1">整形する</button>
    </div>
  </div>

  <!-- 出力設定 -->
  <div class="panel">
    <div class="section-title">出力設定</div>
    <div class="grid grid-2">
      <div>
        <label>出力テンプレ</label>
        <select id="format">
          <option value="html-list" selected>HTML：連番リスト（統計付き）</option>
          <option value="html-cards">HTML：カード型（統計付き）</option>
          <option value="md">Markdown（統計＋連番）</option>
          <option value="tsv">TSV（表）</option>
          <option value="csv">CSV（表）</option>
        </select>
      </div>
      <div>
        <label>整形後の並び替え</label>
        <select id="postSort">
          <option value="none" selected>入力順のまま</option>
          <option value="viewsDesc">視聴回数 多い順</option>
          <option value="viewsAsc">視聴回数 少ない順</option>
          <option value="likesDesc">高評価 多い順</option>
          <option value="likesAsc">高評価 少ない順</option>
          <option value="commentsDesc">コメント 多い順</option>
          <option value="commentsAsc">コメント 少ない順</option>
          <option value="avgDesc">平均/日 多い順</option>
          <option value="avgAsc">平均/日 少ない順</option>
          <option value="growthDesc">推定増分(N日) 多い順</option>
          <option value="growthAsc">推定増分(N日) 少ない順</option>
        </select>
      </div>
      <div>
        <label>推定N日</label>
        <input id="windowDays" type="number" value="28" min="1" />
      </div>
      <div>
        <label>開始番号</label>
        <input id="startNum" type="number" value="1" min="1" />
      </div>
    </div>

    <p class="muted" style="margin:.6em 0 0">行形式（HTML/MD/TSV/CSV）は <strong>連番. タイトル(リンク) — 視聴回数(リンク) — 👍高評価 — 💬コメント — 平均/日 — 推定増分 — 公開日</strong> を出力。</p>

    <textarea id="out" placeholder="ここに結果が出ます"></textarea>

    <details class="preview" id="previewWrap">
      <summary>HTMLプレビュー（タップで開閉）</summary>
      <div id="preview" style="margin-top:10px"></div>
    </details>

    <div class="stickybar">
      <div class="left">
        <button id="copy" class="btn" style="min-width:120px">コピー</button>
        <button id="dlCsv" class="btn secondary" style="min-width:140px">CSVダウンロード</button>
      </div>
      <div class="count"><span id="count">0</span> 件</div>
    </div>
  </div>
</div>

<script>
/* ========= 初期設定 ========= */
const DEFAULT_API_KEY = ''; // 公開配布時は空推奨
const apiKeyInput = document.getElementById('apiKey');
const appUrlInput = document.getElementById('appUrl');
const apiRow = document.getElementById('apiRow');
const gasRow = document.getElementById('gasRow');

const workToggle = document.getElementById('workToggle');
const apiToggle  = document.getElementById('apiToggle');

const collectBox = document.getElementById('collectBox');
const formatBox  = document.getElementById('formatBox');

const channelInput = document.getElementById('channel');
const limitInput   = document.getElementById('limit');
const sinceInput   = document.getElementById('since');
const sortSelect   = document.getElementById('sort');
const runCollect   = document.getElementById('runCollect');

const rawUrlsTA   = document.getElementById('rawUrls');
const since2Input = document.getElementById('since2');
const sort2Select = document.getElementById('sort2');
const runFormat   = document.getElementById('runFormat');

const fmtSelect   = document.getElementById('format');
const postSortSel = document.getElementById('postSort');
const windowDays  = document.getElementById('windowDays');
const startNumInp = document.getElementById('startNum');

const outTA     = document.getElementById('out');
const copyBtn   = document.getElementById('copy');
const dlCsvBtn  = document.getElementById('dlCsv');
const statusEl  = document.getElementById('status');
const countEl   = document.getElementById('count');
const previewWrap= document.getElementById('previewWrap');
const previewDiv = document.getElementById('preview');

/* ========= ローカル保存 ========= */
apiKeyInput.value = localStorage.getItem('yt_api_key') || DEFAULT_API_KEY || '';
appUrlInput.value = localStorage.getItem('yt_app_url') || '';
document.getElementById('saveKey').onclick = () => {
  localStorage.setItem('yt_api_key', apiKeyInput.value.trim());
  toast('APIキーを保存しました');
};
appUrlInput.addEventListener('change', ()=> localStorage.setItem('yt_app_url', appUrlInput.value.trim()));

/* ========= トグルUI ========= */
workToggle.addEventListener('click', (e)=>{
  if (e.target.tagName !== 'BUTTON') return;
  for (const b of workToggle.children) b.classList.remove('active'), b.setAttribute('aria-selected','false');
  e.target.classList.add('active'); e.target.setAttribute('aria-selected','true');
  const mode = e.target.dataset.mode;
  collectBox.classList.toggle('hide', mode!=='collect');
  formatBox.classList.toggle('hide',  mode!=='format');
  clearOutput();
});
apiToggle.addEventListener('click', (e)=>{
  if (e.target.tagName !== 'BUTTON') return;
  for (const b of apiToggle.children) b.classList.remove('active'), b.setAttribute('aria-selected','false');
  e.target.classList.add('active'); e.target.setAttribute('aria-selected','true');
  const api = e.target.dataset.api;
  apiRow.classList.toggle('hide', api!=='client');
  gasRow.classList.toggle('hide', api!=='gas');
});
function getApiMode(){ return apiToggle.querySelector('.active').dataset.api; }

/* ========= 状態 ========= */
let lastRows = [];
let lastChannel = null;

/* ========= 取得モード ========= */
runCollect.onclick = async ()=>{
  const apiMode = getApiMode();
  const raw  = channelInput.value.trim();
  const max  = clampInt(Number(limitInput.value)||200,1,5000);
  const since= sinceInput.value;
  const sort = sortSelect.value;
  if (!raw) return alert('チャンネル/プレイリスト/URLを入力してください');
  try{
    busy(true); setCount('—');
    if (apiMode==='gas'){
      const app = validateExecUrlOrThrow(appUrlInput.value.trim());
      const payload = await runViaGAS(app, raw, {max,since,sort});
      lastRows = payload.rows.map((r,i)=>({...r,__idx:i}));
      lastChannel = payload.channel || null;
    }else{
      const key = getKeyOrThrow();
      const {rows,channel} = await runViaClient(key, raw, {max,since,sort});
      lastRows = rows.map((r,i)=>({...r,__idx:i}));
      lastChannel = channel;
    }
    rerender();
    toast(`${lastRows.length}件を整形しました`);
  }catch(err){
    console.error(err);
    clearOutput();
    alert('エラー: ' + (err.message||err));
  }finally{ busy(false); }
};

/* ========= 整形モード ========= */
runFormat.onclick = async ()=>{
  const ids = extractVideoIds(rawUrlsTA.value);
  if (!ids.length) return alert('動画URLが見つかりませんでした');
  const key   = getKeyOrThrow();
  const since = since2Input.value;
  const sort  = sort2Select.value;
  try{
    busy(true); setCount('—');
    const details = await fetchVideosDetails(ids, key);
    let rows = ids.map((id,i)=>{
      const d = details.get(id)||{};
      return {
        url:`https://www.youtube.com/watch?v=${id}`,
        viewCount:d.viewCount ?? null,
        likeCount:d.likeCount ?? null,
        commentCount:d.commentCount ?? null,
        title:d.title ?? '',
        publishedAt:d.publishedAt ?? '',
        channelId:d.channelId || '',
        __idx:i
      };
    });
    rows = applySinceAndSort(rows,{since,sort});
    // 同一チャンネルなら統計を補完
    let channel = null;
    const uniq = new Set(rows.map(r=>r.channelId).filter(Boolean));
    if (uniq.size===1) channel = await fetchChannelInfo(Array.from(uniq)[0], key);
    lastRows = rows;
    lastChannel = channel;
    rerender();
    toast(`${lastRows.length}件を整形しました`);
  }catch(err){
    console.error(err);
    clearOutput();
    alert('エラー: ' + (err.message||err));
  }finally{ busy(false); }
};

/* ========= 整形後の並び替えや設定変更で即再描画 ========= */
for (const el of [postSortSel, fmtSelect, windowDays, startNumInp]) {
  el.addEventListener('input', rerender);
}

/* ========= 再描画 ========= */
function rerender(){
  const startNo = clampInt(Number(startNumInp.value)||1,1,999999);
  const postSort = postSortSel.value;
  const win = clampInt(Number(windowDays.value)||28,1,3650);

  let rows = lastRows.map(r=>({...r}));
  rows = addDerived(rows, win);
  rows = sortAfter(rows, postSort);

  const text = renderText(rows, fmtSelect.value, startNo, lastChannel, win);
  outTA.value = text;
  setCount(rows.length);
  renderPreviewIfHtml(text);
}

/* ========= プレビュー ========= */
function renderPreviewIfHtml(text){
  if (!/^html-/.test(fmtSelect.value)){ previewDiv.innerHTML=''; previewWrap.open=false; return; }
  previewDiv.innerHTML = text;
}

/* ========= 並び替え ========= */
function sortAfter(rows, key){
  const byNum = (field, asc=true)=>(a,b)=>{
    const av=Number(a[field]), bv=Number(b[field]);
    const aNaN=isNaN(av), bNaN=isNaN(bv);
    if (aNaN && bNaN) return a.__idx-b.__idx;
    if (aNaN) return 1; if (bNaN) return -1;
    return asc? (av-bv) : (bv-av);
  };
  switch(key){
    case 'viewsDesc': return rows.sort(byNum('viewCount', false));
    case 'viewsAsc' : return rows.sort(byNum('viewCount', true));
    case 'likesDesc': return rows.sort(byNum('likeCount', false));
    case 'likesAsc' : return rows.sort(byNum('likeCount', true));
    case 'commentsDesc': return rows.sort(byNum('commentCount', false));
    case 'commentsAsc' : return rows.sort(byNum('commentCount', true));
    case 'avgDesc' : return rows.sort(byNum('__avgPerDay', false));
    case 'avgAsc'  : return rows.sort(byNum('__avgPerDay', true));
    case 'growthDesc': return rows.sort(byNum('__growthWin', false));
    case 'growthAsc' : return rows.sort(byNum('__growthWin', true));
    default: return rows.sort((a,b)=>a.__idx - b.__idx);
  }
}

/* ========= 派生指標 ========= */
function addDerived(rows, winDays){
  const now = Date.now();
  return rows.map(r=>{
    const t = new Date(r.publishedAt||0).getTime();
    const age = isFinite(t)? Math.max((now - t)/86400000, 1/24): NaN;
    const views = (r.viewCount==null||isNaN(r.viewCount))? NaN: Number(r.viewCount);
    const avg = (isNaN(views)||isNaN(age))? NaN: (views/age);
    const growth = isNaN(avg)? NaN : (avg * Math.min(winDays, Math.max(age,0)));
    return {...r, __ageDays:age, __avgPerDay:avg, __growthWin:growth};
  });
}

/* ========= 整形本文生成（ヘッダに統計） ========= */
function renderText(rows, fmt, startNo, channel, winDays){
  const num=(i)=> String(startNo + i);
  const fmtNum=(n,u='')=> (n==null||isNaN(n))? '' : Number(n).toLocaleString('ja-JP')+u;
  const fmtFloat=(n)=> (n==null||isNaN(n))? '' : (Math.round(n*10)/10).toLocaleString('ja-JP');
  const escHtml = (s)=> String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const headHtml = channel?(()=>{
    const url = channel.url || (channel.id?`https://www.youtube.com/channel/${channel.id}`:'');
    return `<section style="margin:0 0 10px;padding:10px;border:1px solid var(--bd);border-radius:10px">
      <div style="display:flex;gap:8px;align-items:center">
        ${channel.avatar? `<img src="${channel.avatar}" alt="" style="width:44px;height:44px;border-radius:999px">`:''}
        <div>
          <div style="font-weight:800"><a href="${url}" target="_blank" rel="noopener">${escHtml(channel.title||'')}</a></div>
          <div style="color:var(--muted);font-size:.95em">
            登録者数：${fmtNum(channel.subscriberCount,'人')}　総再生回数：${fmtNum(channel.viewCount,'回')}　動画数：${fmtNum(channel.videoCount,'本')}
          </div>
        </div>
      </div>
    </section>`;
  })() : '';

  const viewLine = (r)=>{
    const views = (r.viewCount!=null)? Number(r.viewCount).toLocaleString('ja-JP')+'回' : '-';
    const likes = (r.likeCount!=null)? Number(r.likeCount).toLocaleString('ja-JP') : '-';
    const comms = (r.commentCount!=null)? Number(r.commentCount).toLocaleString('ja-JP') : '-';
    const avg   = isNaN(r.__avgPerDay)? '-': `${fmtFloat(r.__avgPerDay)}/日`;
    const grow  = isNaN(r.__growthWin)? '-': `${Math.round(r.__growthWin).toLocaleString('ja-JP')}回/推定${winDays}日`;
    const date  = r.publishedAt? r.publishedAt.slice(0,10) : '';
    return {views, likes, comms, avg, grow, date};
  };

  if (fmt==='html-list' || fmt==='html-cards'){
    if (fmt==='html-list'){
      const items = rows.map((r,i)=>{
        const v=viewLine(r);
        return `<li style="margin:.4em 0">
          <span style="font-weight:700;color:var(--muted)">#${num(i)}</span>
          <a href="${r.url}" target="_blank" rel="noopener" style="font-weight:800"> ${escHtml(r.title)}</a>
          — <a href="${r.url}" target="_blank" rel="noopener">${v.views}</a>
          — 👍 ${v.likes} — 💬 ${v.comms} — ${v.avg} — ${v.grow}
          — <span style="color:var(--muted)">${escHtml(v.date)}</span>
        </li>`;
      }).join('');
      return `${headHtml}<ol start="${startNo}" style="padding-left:1.2em">${items}</ol>`;
    }else{
      const cards = rows.map((r,i)=>{
        const v=viewLine(r);
        return `<div class="card">
          <div class="no">#${num(i)}</div>
          <div class="title"><a href="${r.url}" target="_blank" rel="noopener">${escHtml(r.title)}</a></div>
          <div><a href="${r.url}" target="_blank" rel="noopener">${v.views}</a> ｜ 👍 ${v.likes} ｜ 💬 ${v.comms}</div>
          <div>平均/日：${v.avg} ｜ 推定増分：${v.grow}</div>
          <div class="muted">${escHtml(v.date)}</div>
        </div>`;
      }).join('');
      return `${headHtml}<div class="cards">${cards}</div>`;
    }
  }

  if (fmt==='md'){
    const header = channel? `## [${channel.title||''}](${channel.url || (channel.id?`https://www.youtube.com/channel/${channel.id}`:'')})
登録者数：${fmtNum(channel.subscriberCount)}　総再生回数：${fmtNum(channel.viewCount)}　動画数：${fmtNum(channel.videoCount)}
` : '';
    const lines = rows.map((r,i)=>{
      const v=viewLine(r);
      return `${num(i)}. [${r.title}](${r.url}) — [${v.views}](${r.url}) — 👍 ${v.likes} — 💬 ${v.comms} — 平均/日 ${v.avg} — 推定増分 ${v.grow} — ${v.date}`;
    }).join('\n');
    return header + lines;
  }

  // TSV / CSV
  const sep = (fmt==='csv')? ',' : '\t';
  const esc = (s)=> {
    s=String(s??'');
    if (fmt==='csv' && /[",\n]/.test(s)) s = `"${s.replace(/"/g,'""')}"`;
    return s;
  };
  const head = ['No','URL','視聴回数','高評価','コメント','平均/日','推定増分(N日)','公開日','タイトル'];
  const lines = [];
  if (channel){
    lines.push(
      ['Channel Title', channel.title||''].map(esc).join(sep),
      ['Channel URL', channel.url || (channel.id?`https://www.youtube.com/channel/${channel.id}`:'')].map(esc).join(sep),
      ['Subscribers', fmtNum(channel.subscriberCount)].map(esc).join(sep),
      ['Total Views', fmtNum(channel.viewCount)].map(esc).join(sep),
      ['Video Count', fmtNum(channel.videoCount)].map(esc).join(sep),
      ['', ''].map(esc).join(sep)
    );
  }
  lines.push(head.map(esc).join(sep));
  rows.forEach((r,i)=>{
    const v=viewLine(r);
    lines.push([num(i), r.url, v.views.replace('回',''), v.likes, v.comms, v.avg.replace('/日',''), v.grow.replace('回/推定'+winDays+'日',''), v.date, r.title].map(esc).join(sep));
  });
  return lines.join('\n');
}

/* ========= 取得ヘルパ ========= */
function getKeyOrThrow(){ const k=apiKeyInput.value.trim(); if(!k) throw new Error('APIキーを入力してください'); return k; }
function busy(b,msg){ statusEl.textContent = b ? (msg||'処理中…') : ''; }
function setCount(n){ countEl.textContent = (n==='—')?'—':String(Number(n)||0); }
function toast(msg){ statusEl.textContent = msg; setTimeout(()=> statusEl.textContent='', 1600); }
function clearOutput(){ outTA.value=''; setCount(0); renderPreviewIfHtml(''); }
function clampInt(v,min,max){ v=Math.floor(v); return Math.max(min, Math.min(max, v)); }

/* ========= YouTube API（ブラウザ直） ========= */
async function runViaClient(key, raw, {max,since,sort}){
  const channelId = await resolveChannelIdSmart(raw, key);
  if (!channelId) throw new Error('チャンネルIDを解決できませんでした');
  const [uploads, channel] = await Promise.all([ getUploadsPlaylistId(channelId, key), fetchChannelInfo(channelId, key) ]);
  if (!uploads) throw new Error('アップロード済みプレイリストが見つかりませんでした');
  const videoIds = await listPlaylistVideoIds(uploads, key, max);
  const details  = await fetchVideosDetails(videoIds, key);
  let rows = videoIds.map((id,i)=>{
    const d=details.get(id)||{};
    return { url:`https://www.youtube.com/watch?v=${id}`, viewCount:d.viewCount??null, likeCount:d.likeCount??null, commentCount:d.commentCount??null, title:d.title??'', publishedAt:d.publishedAt??'', channelId:d.channelId||'', __idx:i };
  });
  rows = applySinceAndSort(rows,{since,sort});
  return { rows, channel };
}
function applySinceAndSort(rows,{since,sort}){
  if (since){
    const t0 = new Date(`${since}T00:00:00Z`).getTime();
    if (isFinite(t0)) rows = rows.filter(r=>{ const t=new Date(r.publishedAt||0).getTime(); return isFinite(t)&&t>=t0; });
  }
  if (sort==='newest'||sort==='oldest'){
    rows.sort((a,b)=>{ const ta=new Date(a.publishedAt||0).getTime(); const tb=new Date(b.publishedAt||0).getTime(); return sort==='newest'? (tb-ta):(ta-tb); });
  }
  return rows;
}

/* ========= GAS経由 ========= */
async function runViaGAS(appUrl, channelInput, {max,since,sort}){
  const url = new URL(appUrl);
  url.searchParams.set('max', String(max));
  if (since) url.searchParams.set('since', since);
  if (/^UC[0-9A-Za-z_-]{22}$/.test(channelInput)) url.searchParams.set('channelId', channelInput);
  else url.searchParams.set('channel', channelInput);

  try{
    const json = await fetchJson(url.toString());
    return normalizeFromBackend(json, sort, since);
  }catch(_){
    const json = await jsonpFetch(url);
    return normalizeFromBackend(json, sort, since);
  }
}
function normalizeFromBackend(json, sort, since){
  if (!json || json.ok===false) throw new Error(json?.error || 'GAS応答エラー');
  let rows = (json.items||[]).map((it,i)=>({
    url: it.url||'', viewCount: it.viewCount!=null?Number(it.viewCount):null, likeCount: it.likeCount!=null?Number(it.likeCount):null, commentCount: it.commentCount!=null?Number(it.commentCount):null,
    title: it.title||'', publishedAt: it.publishedAt||'', channelId: it.channelId||'', __idx:i
  }));
  rows = applySinceAndSort(rows,{since,sort});
  const channel = json.channel ? {
    id: json.channel.id||'', title: json.channel.title||'', url: json.channel.url||'', avatar: json.channel.avatar||'',
    subscriberCount: json.channel.subscriberCount!=null?Number(json.channel.subscriberCount):null,
    viewCount: json.channel.viewCount!=null?Number(json.channel.viewCount):null,
    videoCount: json.channel.videoCount!=null?Number(json.channel.videoCount):null
  } : null;
  return { rows, channel };
}

/* ========= API 呼び出し群 ========= */
function looksLikeUrl(s){ return /^https?:\/\//i.test(String(s||'')); }
async function resolveChannelIdSmart(input, key){
  const raw=String(input||'').trim(); if(!raw) return null;
  if (/^UC[0-9A-Za-z_-]{22}$/.test(raw)) return raw;
  if (/^[0-9A-Za-z_-]{11}$/.test(raw)){ const cid=await getChannelIdFromVideo(raw,key); if (cid) return cid; }
  if (raw.startsWith('@')){ const cid=await searchChannelIdByHandle(raw.slice(1),key); if (cid) return cid; }
  if (looksLikeUrl(raw)){
    try{
      const u=new URL(raw); const host=u.hostname.replace(/^www\./,''); const parts=u.pathname.replace(/\/+$/,'').split('/').filter(Boolean);
      const vid=u.searchParams.get('v') || (['shorts','embed','live'].includes(parts[0])? parts[1] : null);
      if (host==='youtu.be' && parts[0]){ const cid=await getChannelIdFromVideo(parts[0].slice(0,11),key); if (cid) return cid; }
      if (vid){ const cid=await getChannelIdFromVideo(vid.slice(0,11),key); if (cid) return cid; }
      const list=u.searchParams.get('list'); if (list){ const cid=await getChannelIdFromPlaylist(list,key); if (cid) return cid; }
      const mCh=u.pathname.match(/\/channel\/(UC[0-9A-Za-z_-]{22})$/); if (mCh) return mCh[1];
      const mHandle=u.pathname.match(/\/@([^/]+)$/); if (mHandle){ const cid=await searchChannelIdByHandle(mHandle[1],key); if (cid) return cid; }
      const mCustom=u.pathname.match(/\/(c|user)\/([^/]+)$/); if (mCustom){ const cid=await searchChannelIdByQuery(mCustom[2],key); if (cid) return cid; }
    }catch{}
  }
  return await searchChannelIdByQuery(raw,key);
}

async function fetchJson(u){
  const res=await fetch(u,{cache:'no-store',mode:'cors',credentials:'omit'});
  const ct=(res.headers.get('content-type')||'').toLowerCase(); const txt=await res.text();
  if(!res.ok) throw new Error(`HTTP ${res.status} / ${txt.slice(0,200)}`);
  if(!ct.includes('application/json')) throw new Error(`JSON以外の応答: ${ct} / ${txt.slice(0,160)}`);
  return JSON.parse(txt);
}
function jsonpFetch(urlObj){
  return new Promise((resolve,reject)=>{
    const u=new URL(urlObj.toString());
    const cb='__jsonp_cb_'+Date.now()+'_'+Math.floor(Math.random()*1e6);
    u.searchParams.set('callback', cb);
    const timer=setTimeout(()=>{cleanup();reject(new Error('JSONPタイムアウト'));},15000);
    function cleanup(){ clearTimeout(timer); try{ delete window[cb]; }catch{} if(script&&script.parentNode) script.parentNode.removeChild(script); }
    window[cb]=data=>{ cleanup(); resolve(data); };
    const script=document.createElement('script'); script.src=u.toString();
    script.onerror=()=>{ cleanup(); reject(new Error('JSONP読込失敗')); };
    document.head.appendChild(script);
  });
}

async function fetchChannelInfo(channelId, key){
  const ep=new URL('https://www.googleapis.com/youtube/v3/channels');
  ep.searchParams.set('part','snippet,statistics'); ep.searchParams.set('id',channelId); ep.searchParams.set('key',key);
  const r=await fetch(ep); await assertOk(r,'channels(stats) API'); const j=await r.json();
  const it=j.items?.[0]; if(!it) return null; const sn=it.snippet||{}, st=it.statistics||{};
  return { id:it.id, title:sn.title||'', url:`https://www.youtube.com/channel/${it.id}`, avatar:sn.thumbnails?.default?.url||'',
    subscriberCount: st.subscriberCount!=null? Number(st.subscriberCount):null,
    viewCount: st.viewCount!=null? Number(st.viewCount):null,
    videoCount: st.videoCount!=null? Number(st.videoCount):null };
}

async function getChannelIdFromVideo(videoId,key){
  const ep=new URL('https://www.googleapis.com/youtube/v3/videos');
  ep.searchParams.set('part','snippet'); ep.searchParams.set('id',videoId); ep.searchParams.set('key',key);
  const r=await fetch(ep); await assertOk(r,'videos API'); const j=await r.json();
  return j.items?.[0]?.snippet?.channelId || null;
}
async function getChannelIdFromPlaylist(playlistId,key){
  const ep=new URL('https://www.googleapis.com/youtube/v3/playlists');
  ep.searchParams.set('part','snippet'); ep.searchParams.set('id',playlistId); ep.searchParams.set('key',key);
  const r=await fetch(ep); await assertOk(r,'playlists API'); const j=await r.json();
  return j.items?.[0]?.snippet?.channelId || null;
}
async function searchChannelIdByHandle(handle,key){
  const ep=new URL('https://www.googleapis.com/youtube/v3/search');
  ep.searchParams.set('part','snippet'); ep.searchParams.set('type','channel'); ep.searchParams.set('q',handle);
  ep.searchParams.set('maxResults','1'); ep.searchParams.set('key',key);
  const r=await fetch(ep); await assertOk(r,'search(handle) API'); const j=await r.json();
  return j.items?.[0]?.id?.channelId || null;
}
async function searchChannelIdByQuery(query,key){
  const ep=new URL('https://www.googleapis.com/youtube/v3/search');
  ep.searchParams.set('part','snippet'); ep.searchParams.set('type','channel'); ep.searchParams.set('q',query);
  ep.searchParams.set('maxResults','1'); ep.searchParams.set('key',key);
  const r=await fetch(ep); await assertOk(r,'search(query) API'); const j=await r.json();
  return j.items?.[0]?.id?.channelId || null;
}
async function getUploadsPlaylistId(channelId,key){
  const ep=new URL('https://www.googleapis.com/youtube/v3/channels');
  ep.searchParams.set('part','contentDetails'); ep.searchParams.set('id',channelId); ep.searchParams.set('key',key);
  const r=await fetch(ep); await assertOk(r,'channels API'); const j=await r.json();
  return j.items?.[0]?.contentDetails?.relatedPlaylists?.uploads || null;
}
async function listPlaylistVideoIds(playlistId,key,maxCount){
  let ids=[]; let pageToken='';
  while(ids.length<maxCount){
    const ep=new URL('https://www.googleapis.com/youtube/v3/playlistItems');
    ep.searchParams.set('part','contentDetails'); ep.searchParams.set('playlistId',playlistId);
    ep.searchParams.set('maxResults','50'); if(pageToken) ep.searchParams.set('pageToken',pageToken); ep.searchParams.set('key',key);
    const r=await fetch(ep); await assertOk(r,'playlistItems API'); const j=await r.json();
    for (const it of (j.items||[])){ const id=it.contentDetails?.videoId; if(id) ids.push(id); if(ids.length>=maxCount) break; }
    pageToken=j.nextPageToken||''; if(!pageToken) break;
    busy(true, `取得中… ${ids.length}件`);
  }
  return ids;
}
async function fetchVideosDetails(videoIds,key){
  const map=new Map();
  for(let i=0;i<videoIds.length;i+=50){
    const chunk=videoIds.slice(i,i+50);
    const ep=new URL('https://www.googleapis.com/youtube/v3/videos');
    ep.searchParams.set('part','snippet,statistics'); ep.searchParams.set('id',chunk.join(',')); ep.searchParams.set('key',key);
    const r=await fetch(ep); await assertOk(r,'videos(details) API'); const j=await r.json();
    for (const it of (j.items||[])){
      map.set(it.id,{
        title: it.snippet?.title ?? '',
        viewCount: it.statistics?.viewCount!=null? Number(it.statistics.viewCount):null,
        likeCount: it.statistics?.likeCount!=null? Number(it.statistics.likeCount):null,
        commentCount: it.statistics?.commentCount!=null? Number(it.statistics.commentCount):null,
        publishedAt: it.snippet?.publishedAt ?? '',
        channelId: it.snippet?.channelId || ''
      });
    }
  }
  return map;
}

/* ========= 小物 ========= */
async function assertOk(res,label){
  if(res.ok) return;
  let detail=''; try{ detail=' / '+(await res.text()).slice(0,200);}catch{}
  throw new Error(`${label} エラー: ${res.status}${detail}`);
}
function validateExecUrlOrThrow(s){
  const m=String(s||'').match(/https?:\/\/script\.google\.com\/macros\/s\/[A-Za-z0-9_-]+\/exec/);
  if(!m) throw new Error('GASの APP_URL（/exec）を正しく入力してください');
  return m[0];
}

/* ========= 整形モード：URL→id抽出 ========= */
function extractVideoIds(text){
  const set=new Set(); const tokens=String(text||'').split(/[\s\n\r\t]+/).filter(Boolean);
  const re=/(?:v=|vi=|v%3D|youtu\.be\/|shorts\/|embed\/)([0-9A-Za-z_-]{11})/;
  for (const tk of tokens){
    if(/^https?:\/\//i.test(tk)){
      try{
        const u=new URL(tk); const host=u.hostname.replace(/^www\./,''); const parts=u.pathname.replace(/\/+$/,'').split('/').filter(Boolean);
        let id=u.searchParams.get('v'); if(!id && host==='youtu.be') id=parts[0]; if(!id && ['shorts','embed','live'].includes(parts[0])) id=parts[1];
        if(id && /^[0-9A-Za-z_-]{11}$/.test(id)){ set.add(id); continue; }
      }catch{}
      const m=tk.match(re); if(m&&m[1]){ set.add(m[1]); continue; }
    }
    if(/^[0-9A-Za-z_-]{11}$/.test(tk)) set.add(tk);
    else { const m=tk.match(re); if(m&&m[1]) set.add(m[1]); }
  }
  return Array.from(set);
}

/* ========= 便利ボタン ========= */
copyBtn.onclick = async () => {
  try{ await navigator.clipboard.writeText(outTA.value); toast('コピーしました'); }
  catch{ alert('コピーに失敗しました'); }
};
dlCsvBtn.onclick = ()=>{
  const text=outTA.value||'';
  const blob=new Blob([new Uint8Array([0xEF,0xBB,0xBF]), text.replace(/\t/g, ',')],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`youtube_${Date.now()}.csv`; document.body.appendChild(a); a.click(); a.remove();
};
</script>
