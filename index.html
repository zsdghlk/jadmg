<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>YouTube 一括取得・整形（連番＋リンク）</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;margin:24px;line-height:1.7}
  h1{font-size:1.2rem;margin:0 0 12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0}
  input,button,select,textarea{font-size:14px}
  input,button,select{padding:8px}
  input[type="number"]{width:120px}
  input[type="date"]{width:auto}
  textarea{width:100%;min-height:260px;padding:10px}
  .muted{color:#6b7280}
  .pill{border:1px solid #d1d5db;border-radius:999px;padding:6px 10px}
  .section{border:1px solid #e5e7eb;border-radius:10px;padding:12px;margin:12px 0}
  .hide{display:none}
</style>

<h1>YouTube 一括取得・整形（連番＋リンク）</h1>

<script>
// 公開環境では空が安全。ローカル用途のみ埋めてもOK
const DEFAULT_API_KEY = '';
</script>

<!-- 動作モード -->
<div class="row">
  <span class="pill">
    <label><input type="radio" name="work" value="collect" checked> 取得モード（チャンネル/PLから取得）</label>
  </span>
  <span class="pill">
    <label><input type="radio" name="work" value="format"> 整形モード（貼り付けた動画URLを整形）</label>
  </span>
</div>

<!-- API/GAS 設定 -->
<div class="section">
  <div class="row">
    <span class="pill">
      <label><input type="radio" name="mode" value="client" checked> 直接API</label>
    </span>
    <span class="pill">
      <label><input type="radio" name="mode" value="gas"> GASバックエンド</label>
    </span>
    <span class="muted">※ 整形モードはAPIキーを使います（GASは不要）</span>
  </div>

  <div class="row" id="apiRow">
    <label>APIキー：</label>
    <input id="apiKey" placeholder="YouTube Data API v3 の APIキー" style="min-width:260px;flex:1">
    <button id="saveKey">保存</button>
    <span class="muted">（ブラウザにローカル保存）</span>
  </div>

  <div class="row hide" id="gasRow">
    <label>GAS APP_URL（/exec）：</label>
    <input id="appUrl" placeholder="https://script.google.com/macros/s/xxxxxxxxxxxxxxxx/exec" style="min-width:360px;flex:1">
    <span class="muted">※ /dev ではなく /exec を指定</span>
  </div>
</div>

<!-- 入力UI（取得モード） -->
<div class="section" id="collectBox">
  <div class="row">
    <label>チャンネル/PL/URL：</label>
    <input id="channel" placeholder="@handle / UCxxxxxxxx... / https://.../@handle / 動画URL / プレイリストURL" style="min-width:320px;flex:1">
  </div>
  <div class="row">
    <label>最大件数：</label>
    <input id="limit" type="number" value="200" min="1" max="5000">
    <label>公開日 since：</label>
    <input id="since" type="date">
    <label>並び順：</label>
    <select id="sort">
      <option value="newest" selected>新しい順</option>
      <option value="oldest">古い順</option>
      <option value="none">そのまま</option>
    </select>
  </div>
  <div class="row">
    <button id="runCollect">取得 → 整形</button>
  </div>
</div>

<!-- 入力UI（整形モード） -->
<div class="section hide" id="formatBox">
  <div class="row">
    <label class="muted">動画URLを改行/スペース区切りで貼り付け</label>
  </div>
  <textarea id="rawUrls" placeholder="例）https://www.youtube.com/watch?v=dQw4w9WgXcQ&#10;https://youtu.be/XXXXXXXXXXX&#10;..."></textarea>
  <div class="row">
    <label>公開日 since：</label>
    <input id="since2" type="date">
    <label>並び順：</label>
    <select id="sort2">
      <option value="none" selected>入力順のまま</option>
      <option value="newest">新しい順</option>
      <option value="oldest">古い順</option>
    </select>
  </div>
  <div class="row">
    <button id="runFormat">整形する</button>
  </div>
</div>

<!-- 出力設定 -->
<div class="section">
  <div class="row">
    <label>出力形式：</label>
    <select id="format">
      <option value="html" selected>HTML（aタグ）</option>
      <option value="md">Markdown</option>
      <option value="tsv">TSV（タブ区切り）</option>
      <option value="csv">CSV（カンマ区切り）</option>
    </select>
    <label>開始番号：</label>
    <input id="startNum" type="number" value="1" min="1">
    <span class="muted">件数：</span><span id="count" class="pill">0 件</span>
    <span id="status" class="muted"></span>
  </div>
  <p class="muted">各行は <strong>連番. タイトル(リンク) — 視聴回数(リンク) — 公開日</strong> で出力します（形式により表現は最適化）。</p>
  <textarea id="out" placeholder="ここに結果が出ます"></textarea>
  <div class="row">
    <button id="copy">コピー</button>
    <button id="dlCsv">CSVダウンロード</button>
  </div>
</div>

<script>
/* ================== 要素参照 ================== */
const apiKeyInput = document.getElementById('apiKey');
const appUrlInput = document.getElementById('appUrl');
const apiRow      = document.getElementById('apiRow');
const gasRow      = document.getElementById('gasRow');

const collectBox  = document.getElementById('collectBox');
const formatBox   = document.getElementById('formatBox');

const channelInput= document.getElementById('channel');
const limitInput  = document.getElementById('limit');
const sinceInput  = document.getElementById('since');
const sortSelect  = document.getElementById('sort');
const runCollect  = document.getElementById('runCollect');

const rawUrlsTA   = document.getElementById('rawUrls');
const since2Input = document.getElementById('since2');
const sort2Select = document.getElementById('sort2');
const runFormat   = document.getElementById('runFormat');

const fmtSelect   = document.getElementById('format');
const startNumInp = document.getElementById('startNum');

const outTA       = document.getElementById('out');
const copyBtn     = document.getElementById('copy');
const dlCsvBtn    = document.getElementById('dlCsv');
const statusEl    = document.getElementById('status');
const countEl     = document.getElementById('count');

/* ================== 保存/復元 ================== */
apiKeyInput.value = localStorage.getItem('yt_api_key') || DEFAULT_API_KEY || '';
appUrlInput.value = localStorage.getItem('yt_app_url') || '';
document.getElementById('saveKey').onclick = () => {
  localStorage.setItem('yt_api_key', apiKeyInput.value.trim());
  flash('APIキーを保存しました');
};
appUrlInput.addEventListener('change', () => {
  localStorage.setItem('yt_app_url', appUrlInput.value.trim());
});

/* ================== モード切替 ================== */
function getApiMode(){ return document.querySelector('input[name="mode"]:checked').value; }
function getWorkMode(){ return document.querySelector('input[name="work"]:checked').value; }

for (const r of document.querySelectorAll('input[name="mode"]')) {
  r.addEventListener('change', syncVisibility);
}
for (const r of document.querySelectorAll('input[name="work"]')) {
  r.addEventListener('change', () => {
    syncVisibility();
    outTA.value=''; setCount(0);
  });
}

function syncVisibility(){
  const apiMode  = getApiMode();  // client | gas
  const workMode = getWorkMode(); // collect | format
  apiRow.classList.toggle('hide', apiMode !== 'client');
  gasRow.classList.toggle('hide', apiMode !== 'gas');

  collectBox.classList.toggle('hide', workMode !== 'collect');
  formatBox.classList.toggle('hide', workMode !== 'format');
}
syncVisibility();

/* ================== 実行（取得モード） ================== */
runCollect.onclick = async () => {
  const apiMode = getApiMode();
  const raw  = channelInput.value.trim();
  const max  = Math.max(1, Math.min(5000, Number(limitInput.value) || 200));
  const since= sinceInput.value;
  const sort = sortSelect.value; // newest|oldest|none
  const startNo = Math.max(1, Number(startNumInp.value)||1);
  if (!raw) return alert('チャンネル/プレイリスト/URLを入力してください');

  try {
    setBusy(true); setCount('—');
    let rows = [];
    if (apiMode === 'gas') {
      const app = validateExecUrlOrThrow(appUrlInput.value.trim());
      rows = await runViaGAS(app, raw, { max, since, sort });
    } else {
      const key = getKeyOrThrow();
      rows = await runViaClient(key, raw, { max, since, sort });
    }
    renderOutput(rows, startNo);
  } catch (e) {
    console.error(e);
    setCount(0);
    alert('エラー: ' + (e.message || e));
  } finally {
    setBusy(false);
  }
};

/* ================== 実行（整形モード） ================== */
runFormat.onclick = async () => {
  const text = rawUrlsTA.value;
  const ids  = extractVideoIds(text);
  if (!ids.length) return alert('動画URLが見つかりませんでした');
  const key   = getKeyOrThrow();
  const since = since2Input.value;
  const sort  = sort2Select.value;
  const startNo = Math.max(1, Number(startNumInp.value)||1);

  try {
    setBusy(true); setCount('—');
    const details = await fetchVideosDetails(ids, key); // Map<id,{title,viewCount,publishedAt}>
    let rows = ids.map(id => {
      const d = details.get(id) || {};
      return { url:`https://www.youtube.com/watch?v=${id}`, viewCount:d.viewCount ?? null, title:d.title ?? '', publishedAt:d.publishedAt ?? '' };
    });
    rows = applySinceAndSort(rows, { since, sort });
    renderOutput(rows, startNo);
  } catch(e){
    console.error(e);
    setCount(0);
    alert('エラー: ' + (e.message || e));
  } finally {
    setBusy(false);
  }
};

/* ================== 出力レンダリング ================== */
function renderOutput(rows, startNo){
  const fmt = fmtSelect.value; // html|md|tsv|csv
  outTA.value = rowsToFormattedText(rows, fmt, startNo);
  setCount(rows.length);
  flash(`${rows.length}件を整形しました`);
}

/* ================== 共通ユーティリティ ================== */
function setBusy(b, msg){ 
  const t = b ? (msg || '処理中…') : '';
  statusEl.textContent = t;
}
function flash(msg){ statusEl.textContent = msg; setTimeout(()=> statusEl.textContent='', 1600); }
function setCount(n){ countEl.textContent = (n==='—') ? '—' : `${Number(n)||0} 件`; }
function getKeyOrThrow(){
  const key = apiKeyInput.value.trim();
  if (!key) throw new Error('APIキーを入力してください');
  return key;
}

/* ==== 直接API（ブラウザ） ==== */
async function runViaClient(key, raw, {max, since, sort}) {
  const channelId = await resolveChannelIdSmart(raw, key);
  if (!channelId) throw new Error('チャンネルIDを解決できませんでした');

  const uploads = await getUploadsPlaylistId(channelId, key);
  if (!uploads) throw new Error('アップロード済みプレイリストが見つかりませんでした');

  const videoIds = await listPlaylistVideoIds(uploads, key, max);
  const details = await fetchVideosDetails(videoIds, key);

  let rows = videoIds.map(id => {
    const d = details.get(id) || {};
    return { url:`https://www.youtube.com/watch?v=${id}`, viewCount:d.viewCount ?? null, title:d.title ?? '', publishedAt:d.publishedAt ?? '' };
  });

  rows = applySinceAndSort(rows, { since, sort });
  return rows;
}

/* ==== GAS経由（取得モード用） ==== */
async function runViaGAS(appUrl, channelInput, {max, since, sort}){
  const url = new URL(appUrl);
  url.searchParams.set('max', String(max));
  if (since) url.searchParams.set('since', since);
  if (/^UC[0-9A-Za-z_-]{22}$/.test(channelInput)) url.searchParams.set('channelId', channelInput);
  else url.searchParams.set('channel', channelInput);

  try {
    const json = await fetchJson(url.toString());
    return normalizeFromBackend(json, sort, since);
  } catch (_) {
    const json = await jsonpFetch(url);
    return normalizeFromBackend(json, sort, since);
  }
}
function normalizeFromBackend(json, sort, since){
  if (!json || json.ok === false) throw new Error(json?.error || 'GAS応答エラー');
  let rows =
