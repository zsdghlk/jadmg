<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>YouTube ä¸€æ‹¬å–å¾—ãƒ»æ•´å½¢ï¼ˆãƒ¢ãƒã‚¤ãƒ«æœ€é©ï¼‰</title>

<style>
  :root{
    --bg:#0b0b0c; --panel:#121316; --text:#f2f3f5; --muted:#9aa0a6; --bd:#1f2126;
    --accent:#4f8cff; --accent-2:#2962ff; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f7f7fb; --panel:#ffffff; --text:#0a0a0b; --muted:#60656b; --bd:#e7e8ee;
           --accent:#1e88e5; --accent-2:#1565c0; }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif;
    line-height:1.65;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    font-size:clamp(14px, 2.8vw, 16px);
  }
  .wrap{max-width:980px; margin:0 auto; padding:16px;}
  h1{font-size:clamp(18px,4.8vw,22px); margin:0 0 12px;}
  .panel{
    background:var(--panel); border:1px solid var(--bd); border-radius:14px; padding:12px; margin:12px 0;
    box-shadow: 0 1px 2px rgba(0,0,0,.06);
  }
  .muted{color:var(--muted)}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .grid{
    display:grid; gap:10px;
    grid-template-columns: 1fr;
  }
  @media (min-width:720px){ .grid.grid-2{ grid-template-columns: 1fr 1fr; } }
  input,button,select,textarea{
    width:100%; padding:12px 12px; border-radius:10px; border:1px solid var(--bd);
    background:transparent; color:var(--text); outline:none;
  }
  input::placeholder, textarea::placeholder{ color:color-mix(in oklab, var(--muted) 80%, transparent); }
  textarea{ min-height:260px; }
  label{font-weight:600}
  .btn{
    background:var(--accent); border-color:transparent; color:#fff; font-weight:700; cursor:pointer;
    transition: transform .02s ease, background .15s ease;
    text-align:center;
  }
  .btn:active{ transform: translateY(1px); }
  .btn.secondary{ background:transparent; color:var(--accent); border:1px solid var(--accent); }
  .btn.ghost{ background:transparent; color:var(--text); border:1px dashed var(--bd); }
  .chip{
    display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px;
    border:1px solid var(--bd); background:transparent; color:var(--text); font-weight:600;
  }
  .toggle{
    display:flex; border:1px solid var(--bd); border-radius:12px; overflow:hidden; width:100%;
  }
  .toggle > button{
    flex:1 1 0; padding:10px; border:0; background:transparent; color:var(--muted); font-weight:700; cursor:pointer;
  }
  .toggle > button.active{ background:var(--accent); color:#fff; }
  .section-title{font-weight:800; margin:6px 0 10px; font-size:1rem}
  .pill{display:inline-block; padding:.35em .7em; border:1px solid var(--bd); border-radius:999px}
  .kpi{
    display:flex; gap:10px; flex-wrap:wrap; align-items:center;
  }
  .kpi .box{
    flex:1 1 110px; min-width:110px;
    background:transparent; border:1px solid var(--bd); border-radius:12px; padding:10px;
  }
  .kpi .label{color:var(--muted); font-size:.85em}
  .kpi .value{font-weight:900; font-size:1.1em}
  .cards{ display:grid; gap:10px; grid-template-columns: 1fr; }
  @media (min-width:580px){ .cards{ grid-template-columns: 1fr 1fr; } }
  .card{ border:1px solid var(--bd); border-radius:12px; padding:12px; }
  .card .no{ color:var(--muted); font-weight:700 }
  .card .title a{ color:inherit; text-decoration:none; font-weight:800 }
  .stickybar{
    position:sticky; bottom:0; z-index:10; padding:10px; margin-top:10px;
    background:linear-gradient(180deg, color-mix(in oklab, var(--panel) 70%, transparent), var(--panel));
    border:1px solid var(--bd); border-radius:14px;
    display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
  }
  .stickybar .left{ display:flex; gap:10px; flex-wrap:wrap; }
  .count{ font-weight:800; }
  details.preview{ border:1px dashed var(--bd); border-radius:12px; padding:10px; }
  details.preview > summary{ cursor:pointer; font-weight:800 }
  a{ color:var(--accent-2) }
</style>

<div class="wrap">
  <h1>YouTube ä¸€æ‹¬å–å¾—ãƒ»æ•´å½¢ï¼ˆã‚¹ãƒãƒ›æœ€é©ï¼‰</h1>

  <!-- ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ -->
  <div class="panel">
    <div class="toggle" id="workToggle" role="tablist" aria-label="ä½œæ¥­ãƒ¢ãƒ¼ãƒ‰">
      <button type="button" data-mode="collect" class="active" aria-selected="true">å–å¾—ãƒ¢ãƒ¼ãƒ‰</button>
      <button type="button" data-mode="format" aria-selected="false">æ•´å½¢ãƒ¢ãƒ¼ãƒ‰</button>
    </div>
    <p class="muted" style="margin:.6em 0 0">å–å¾—ï¼šãƒãƒ£ãƒ³ãƒãƒ«/ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ/URLã‹ã‚‰å‹•ç”»ã‚’åé›† â†’ æ•´å½¢ã¾ã§å®Ÿè¡Œã€‚æ•´å½¢ï¼šè²¼ã‚Šä»˜ã‘ãŸURLç¾¤ã‚’æ•´å½¢ã€‚</p>
  </div>

  <!-- API/GAS è¨­å®š -->
  <div class="panel">
    <div class="section-title">æ¥ç¶šè¨­å®š</div>
    <div class="toggle" id="apiToggle" role="tablist" aria-label="æ¥ç¶šå…ˆ">
      <button type="button" data-api="client" class="active" aria-selected="true">ç›´æ¥API</button>
      <button type="button" data-api="gas" aria-selected="false">GASãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰</button>
    </div>

    <div id="apiRow" class="grid" style="margin-top:10px">
      <div>
        <label>APIã‚­ãƒ¼</label>
        <input id="apiKey" placeholder="YouTube Data API v3 ã® APIã‚­ãƒ¼" inputmode="text" autocomplete="off" />
      </div>
      <div class="row">
        <button id="saveKey" class="btn" style="flex:1 1 140px">ä¿å­˜</button>
        <span class="muted">ï¼ˆã“ã®ç«¯æœ«ã«ã®ã¿ä¿å­˜ï¼‰</span>
      </div>
    </div>

    <div id="gasRow" class="grid hide" style="margin-top:10px">
      <div>
        <label>GAS APP_URLï¼ˆ/execï¼‰</label>
        <input id="appUrl" placeholder="https://script.google.com/macros/s/xxxxxxxx/exec" inputmode="url" />
      </div>
      <div class="muted">â€» /dev ã§ã¯ãªã /exec ã‚’æŒ‡å®šã—ã¦ãã ã•ã„</div>
    </div>
  </div>

  <!-- å–å¾—ãƒ¢ãƒ¼ãƒ‰ -->
  <div id="collectBox" class="panel">
    <div class="section-title">å–å¾—</div>
    <div class="grid grid-2">
      <div>
        <label>ãƒãƒ£ãƒ³ãƒãƒ« / ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ / URL</label>
        <input id="channel" placeholder="@handle / UCxxxxxxxx... / https://.../@handle / å‹•ç”»URL / ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆURL" />
      </div>
      <div>
        <label>æœ€å¤§ä»¶æ•°</label>
        <input id="limit" type="number" value="200" min="1" max="5000" />
      </div>
      <div>
        <label>å…¬é–‹æ—¥ since</label>
        <input id="since" type="date" />
      </div>
      <div>
        <label>å–å¾—æ™‚ã®ä¸¦ã³</label>
        <select id="sort">
          <option value="newest" selected>æ–°ã—ã„é †ï¼ˆå…¬é–‹æ—¥ï¼‰</option>
          <option value="oldest">å¤ã„é †ï¼ˆå…¬é–‹æ—¥ï¼‰</option>
          <option value="none">ãã®ã¾ã¾</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="runCollect" class="btn" style="flex:1">å–å¾— â†’ æ•´å½¢</button>
      <span id="status" class="muted" style="flex:2 1 160px"></span>
    </div>
  </div>

  <!-- æ•´å½¢ãƒ¢ãƒ¼ãƒ‰ -->
  <div id="formatBox" class="panel hide">
    <div class="section-title">æ•´å½¢</div>
    <div>
      <label class="muted">å‹•ç”»URLã‚’æ”¹è¡Œ/ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã§è²¼ã‚Šä»˜ã‘</label>
      <textarea id="rawUrls" placeholder="ä¾‹ï¼‰https://www.youtube.com/watch?v=dQw4w9WgXcQ&#10;https://youtu.be/XXXXXXXXXXX"></textarea>
    </div>
    <div class="grid grid-2">
      <div>
        <label>å…¬é–‹æ—¥ since</label>
        <input id="since2" type="date" />
      </div>
      <div>
        <label>å–å¾—æ™‚ã®ä¸¦ã³</label>
        <select id="sort2">
          <option value="none" selected>å…¥åŠ›é †ã®ã¾ã¾</option>
          <option value="newest">æ–°ã—ã„é †ï¼ˆå…¬é–‹æ—¥ï¼‰</option>
          <option value="oldest">å¤ã„é †ï¼ˆå…¬é–‹æ—¥ï¼‰</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="runFormat" class="btn" style="flex:1">æ•´å½¢ã™ã‚‹</button>
    </div>
  </div>

  <!-- å‡ºåŠ›è¨­å®š -->
  <div class="panel">
    <div class="section-title">å‡ºåŠ›è¨­å®š</div>
    <div class="grid grid-2">
      <div>
        <label>å‡ºåŠ›ãƒ†ãƒ³ãƒ—ãƒ¬</label>
        <select id="format">
          <option value="html-list" selected>HTMLï¼šé€£ç•ªãƒªã‚¹ãƒˆï¼ˆçµ±è¨ˆä»˜ãï¼‰</option>
          <option value="html-cards">HTMLï¼šã‚«ãƒ¼ãƒ‰å‹ï¼ˆçµ±è¨ˆä»˜ãï¼‰</option>
          <option value="md">Markdownï¼ˆçµ±è¨ˆï¼‹é€£ç•ªï¼‰</option>
          <option value="tsv">TSVï¼ˆè¡¨ï¼‰</option>
          <option value="csv">CSVï¼ˆè¡¨ï¼‰</option>
        </select>
      </div>
      <div>
        <label>æ•´å½¢å¾Œã®ä¸¦ã³æ›¿ãˆ</label>
        <select id="postSort">
          <option value="none" selected>å…¥åŠ›é †ã®ã¾ã¾</option>
          <option value="viewsDesc">è¦–è´å›æ•° å¤šã„é †</option>
          <option value="viewsAsc">è¦–è´å›æ•° å°‘ãªã„é †</option>
          <option value="likesDesc">é«˜è©•ä¾¡ å¤šã„é †</option>
          <option value="likesAsc">é«˜è©•ä¾¡ å°‘ãªã„é †</option>
          <option value="commentsDesc">ã‚³ãƒ¡ãƒ³ãƒˆ å¤šã„é †</option>
          <option value="commentsAsc">ã‚³ãƒ¡ãƒ³ãƒˆ å°‘ãªã„é †</option>
          <option value="avgDesc">å¹³å‡/æ—¥ å¤šã„é †</option>
          <option value="avgAsc">å¹³å‡/æ—¥ å°‘ãªã„é †</option>
          <option value="growthDesc">æ¨å®šå¢—åˆ†(Næ—¥) å¤šã„é †</option>
          <option value="growthAsc">æ¨å®šå¢—åˆ†(Næ—¥) å°‘ãªã„é †</option>
        </select>
      </div>
      <div>
        <label>æ¨å®šNæ—¥</label>
        <input id="windowDays" type="number" value="28" min="1" />
      </div>
      <div>
        <label>é–‹å§‹ç•ªå·</label>
        <input id="startNum" type="number" value="1" min="1" />
      </div>
    </div>

    <p class="muted" style="margin:.6em 0 0">è¡Œå½¢å¼ï¼ˆHTML/MD/TSV/CSVï¼‰ã¯ <strong>é€£ç•ª. ã‚¿ã‚¤ãƒˆãƒ«(ãƒªãƒ³ã‚¯) â€” è¦–è´å›æ•°(ãƒªãƒ³ã‚¯) â€” ğŸ‘é«˜è©•ä¾¡ â€” ğŸ’¬ã‚³ãƒ¡ãƒ³ãƒˆ â€” å¹³å‡/æ—¥ â€” æ¨å®šå¢—åˆ† â€” å…¬é–‹æ—¥</strong> ã‚’å‡ºåŠ›ã€‚</p>

    <textarea id="out" placeholder="ã“ã“ã«çµæœãŒå‡ºã¾ã™"></textarea>

    <details class="preview" id="previewWrap">
      <summary>HTMLãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆã‚¿ãƒƒãƒ—ã§é–‹é–‰ï¼‰</summary>
      <div id="preview" style="margin-top:10px"></div>
    </details>

    <div class="stickybar">
      <div class="left">
        <button id="copy" class="btn" style="min-width:120px">ã‚³ãƒ”ãƒ¼</button>
        <button id="dlCsv" class="btn secondary" style="min-width:140px">CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      </div>
      <div class="count"><span id="count">0</span> ä»¶</div>
    </div>
  </div>
</div>

<script>
/* ========= åˆæœŸè¨­å®š ========= */
const DEFAULT_API_KEY = ''; // å…¬é–‹é…å¸ƒæ™‚ã¯ç©ºæ¨å¥¨
const apiKeyInput = document.getElementById('apiKey');
const appUrlInput = document.getElementById('appUrl');
const apiRow = document.getElementById('apiRow');
const gasRow = document.getElementById('gasRow');

const workToggle = document.getElementById('workToggle');
const apiToggle  = document.getElementById('apiToggle');

const collectBox = document.getElementById('collectBox');
const formatBox  = document.getElementById('formatBox');

const channelInput = document.getElementById('channel');
const limitInput   = document.getElementById('limit');
const sinceInput   = document.getElementById('since');
const sortSelect   = document.getElementById('sort');
const runCollect   = document.getElementById('runCollect');

const rawUrlsTA   = document.getElementById('rawUrls');
const since2Input = document.getElementById('since2');
const sort2Select = document.getElementById('sort2');
const runFormat   = document.getElementById('runFormat');

const fmtSelect   = document.getElementById('format');
const postSortSel = document.getElementById('postSort');
const windowDays  = document.getElementById('windowDays');
const startNumInp = document.getElementById('startNum');

const outTA     = document.getElementById('out');
const copyBtn   = document.getElementById('copy');
const dlCsvBtn  = document.getElementById('dlCsv');
const statusEl  = document.getElementById('status');
const countEl   = document.getElementById('count');
const previewWrap= document.getElementById('previewWrap');
const previewDiv = document.getElementById('preview');

/* ========= ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ ========= */
apiKeyInput.value = localStorage.getItem('yt_api_key') || DEFAULT_API_KEY || '';
appUrlInput.value = localStorage.getItem('yt_app_url') || '';
document.getElementById('saveKey').onclick = () => {
  localStorage.setItem('yt_api_key', apiKeyInput.value.trim());
  toast('APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
};
appUrlInput.addEventListener('change', ()=> localStorage.setItem('yt_app_url', appUrlInput.value.trim()));

/* ========= ãƒˆã‚°ãƒ«UI ========= */
workToggle.addEventListener('click', (e)=>{
  if (e.target.tagName !== 'BUTTON') return;
  for (const b of workToggle.children) b.classList.remove('active'), b.setAttribute('aria-selected','false');
  e.target.classList.add('active'); e.target.setAttribute('aria-selected','true');
  const mode = e.target.dataset.mode;
  collectBox.classList.toggle('hide', mode!=='collect');
  formatBox.classList.toggle('hide',  mode!=='format');
  clearOutput();
});
apiToggle.addEventListener('click', (e)=>{
  if (e.target.tagName !== 'BUTTON') return;
  for (const b of apiToggle.children) b.classList.remove('active'), b.setAttribute('aria-selected','false');
  e.target.classList.add('active'); e.target.setAttribute('aria-selected','true');
  const api = e.target.dataset.api;
  apiRow.classList.toggle('hide', api!=='client');
  gasRow.classList.toggle('hide', api!=='gas');
});
function getApiMode(){ return apiToggle.querySelector('.active').dataset.api; }

/* ========= çŠ¶æ…‹ ========= */
let lastRows = [];
let lastChannel = null;

/* ========= å–å¾—ãƒ¢ãƒ¼ãƒ‰ ========= */
runCollect.onclick = async ()=>{
  const apiMode = getApiMode();
  const raw  = channelInput.value.trim();
  const max  = clampInt(Number(limitInput.value)||200,1,5000);
  const since= sinceInput.value;
  const sort = sortSelect.value;
  if (!raw) return alert('ãƒãƒ£ãƒ³ãƒãƒ«/ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ/URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  try{
    busy(true); setCount('â€”');
    if (apiMode==='gas'){
      const app = validateExecUrlOrThrow(appUrlInput.value.trim());
      const payload = await runViaGAS(app, raw, {max,since,sort});
      lastRows = payload.rows.map((r,i)=>({...r,__idx:i}));
      lastChannel = payload.channel || null;
    }else{
      const key = getKeyOrThrow();
      const {rows,channel} = await runViaClient(key, raw, {max,since,sort});
      lastRows = rows.map((r,i)=>({...r,__idx:i}));
      lastChannel = channel;
    }
    rerender();
    toast(`${lastRows.length}ä»¶ã‚’æ•´å½¢ã—ã¾ã—ãŸ`);
  }catch(err){
    console.error(err);
    clearOutput();
    alert('ã‚¨ãƒ©ãƒ¼: ' + (err.message||err));
  }finally{ busy(false); }
};

/* ========= æ•´å½¢ãƒ¢ãƒ¼ãƒ‰ ========= */
runFormat.onclick = async ()=>{
  const ids = extractVideoIds(rawUrlsTA.value);
  if (!ids.length) return alert('å‹•ç”»URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
  const key   = getKeyOrThrow();
  const since = since2Input.value;
  const sort  = sort2Select.value;
  try{
    busy(true); setCount('â€”');
    const details = await fetchVideosDetails(ids, key);
    let rows = ids.map((id,i)=>{
      const d = details.get(id)||{};
      return {
        url:`https://www.youtube.com/watch?v=${id}`,
        viewCount:d.viewCount ?? null,
        likeCount:d.likeCount ?? null,
        commentCount:d.commentCount ?? null,
        title:d.title ?? '',
        publishedAt:d.publishedAt ?? '',
        channelId:d.channelId || '',
        __idx:i
      };
    });
    rows = applySinceAndSort(rows,{since,sort});
    // åŒä¸€ãƒãƒ£ãƒ³ãƒãƒ«ãªã‚‰çµ±è¨ˆã‚’è£œå®Œ
    let channel = null;
    const uniq = new Set(rows.map(r=>r.channelId).filter(Boolean));
    if (uniq.size===1) channel = await fetchChannelInfo(Array.from(uniq)[0], key);
    lastRows = rows;
    lastChannel = channel;
    rerender();
    toast(`${lastRows.length}ä»¶ã‚’æ•´å½¢ã—ã¾ã—ãŸ`);
  }catch(err){
    console.error(err);
    clearOutput();
    alert('ã‚¨ãƒ©ãƒ¼: ' + (err.message||err));
  }finally{ busy(false); }
};

/* ========= æ•´å½¢å¾Œã®ä¸¦ã³æ›¿ãˆã‚„è¨­å®šå¤‰æ›´ã§å³å†æç”» ========= */
for (const el of [postSortSel, fmtSelect, windowDays, startNumInp]) {
  el.addEventListener('input', rerender);
}

/* ========= å†æç”» ========= */
function rerender(){
  const startNo = clampInt(Number(startNumInp.value)||1,1,999999);
  const postSort = postSortSel.value;
  const win = clampInt(Number(windowDays.value)||28,1,3650);

  let rows = lastRows.map(r=>({...r}));
  rows = addDerived(rows, win);
  rows = sortAfter(rows, postSort);

  const text = renderText(rows, fmtSelect.value, startNo, lastChannel, win);
  outTA.value = text;
  setCount(rows.length);
  renderPreviewIfHtml(text);
}

/* ========= ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ========= */
function renderPreviewIfHtml(text){
  if (!/^html-/.test(fmtSelect.value)){ previewDiv.innerHTML=''; previewWrap.open=false; return; }
  previewDiv.innerHTML = text;
}

/* ========= ä¸¦ã³æ›¿ãˆ ========= */
function sortAfter(rows, key){
  const byNum = (field, asc=true)=>(a,b)=>{
    const av=Number(a[field]), bv=Number(b[field]);
    const aNaN=isNaN(av), bNaN=isNaN(bv);
    if (aNaN && bNaN) return a.__idx-b.__idx;
    if (aNaN) return 1; if (bNaN) return -1;
    return asc? (av-bv) : (bv-av);
  };
  switch(key){
    case 'viewsDesc': return rows.sort(byNum('viewCount', false));
    case 'viewsAsc' : return rows.sort(byNum('viewCount', true));
    case 'likesDesc': return rows.sort(byNum('likeCount', false));
    case 'likesAsc' : return rows.sort(byNum('likeCount', true));
    case 'commentsDesc': return rows.sort(byNum('commentCount', false));
    case 'commentsAsc' : return rows.sort(byNum('commentCount', true));
    case 'avgDesc' : return rows.sort(byNum('__avgPerDay', false));
    case 'avgAsc'  : return rows.sort(byNum('__avgPerDay', true));
    case 'growthDesc': return rows.sort(byNum('__growthWin', false));
    case 'growthAsc' : return rows.sort(byNum('__growthWin', true));
    default: return rows.sort((a,b)=>a.__idx - b.__idx);
  }
}

/* ========= æ´¾ç”ŸæŒ‡æ¨™ ========= */
function addDerived(rows, winDays){
  const now = Date.now();
  return rows.map(r=>{
    const t = new Date(r.publishedAt||0).getTime();
    const age = isFinite(t)? Math.max((now - t)/86400000, 1/24): NaN;
    const views = (r.viewCount==null||isNaN(r.viewCount))? NaN: Number(r.viewCount);
    const avg = (isNaN(views)||isNaN(age))? NaN: (views/age);
    const growth = isNaN(avg)? NaN : (avg * Math.min(winDays, Math.max(age,0)));
    return {...r, __ageDays:age, __avgPerDay:avg, __growthWin:growth};
  });
}

/* ========= æ•´å½¢æœ¬æ–‡ç”Ÿæˆï¼ˆãƒ˜ãƒƒãƒ€ã«çµ±è¨ˆï¼‰ ========= */
function renderText(rows, fmt, startNo, channel, winDays){
  const num=(i)=> String(startNo + i);
  const fmtNum=(n,u='')=> (n==null||isNaN(n))? '' : Number(n).toLocaleString('ja-JP')+u;
  const fmtFloat=(n)=> (n==null||isNaN(n))? '' : (Math.round(n*10)/10).toLocaleString('ja-JP');
  const escHtml = (s)=> String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const headHtml = channel?(()=>{
    const url = channel.url || (channel.id?`https://www.youtube.com/channel/${channel.id}`:'');
    return `<section style="margin:0 0 10px;padding:10px;border:1px solid var(--bd);border-radius:10px">
      <div style="display:flex;gap:8px;align-items:center">
        ${channel.avatar? `<img src="${channel.avatar}" alt="" style="width:44px;height:44px;border-radius:999px">`:''}
        <div>
          <div style="font-weight:800"><a href="${url}" target="_blank" rel="noopener">${escHtml(channel.title||'')}</a></div>
          <div style="color:var(--muted);font-size:.95em">
            ç™»éŒ²è€…æ•°ï¼š${fmtNum(channel.subscriberCount,'äºº')}ã€€ç·å†ç”Ÿå›æ•°ï¼š${fmtNum(channel.viewCount,'å›')}ã€€å‹•ç”»æ•°ï¼š${fmtNum(channel.videoCount,'æœ¬')}
          </div>
        </div>
      </div>
    </section>`;
  })() : '';

  const viewLine = (r)=>{
    const views = (r.viewCount!=null)? Number(r.viewCount).toLocaleString('ja-JP')+'å›' : '-';
    const likes = (r.likeCount!=null)? Number(r.likeCount).toLocaleString('ja-JP') : '-';
    const comms = (r.commentCount!=null)? Number(r.commentCount).toLocaleString('ja-JP') : '-';
    const avg   = isNaN(r.__avgPerDay)? '-': `${fmtFloat(r.__avgPerDay)}/æ—¥`;
    const grow  = isNaN(r.__growthWin)? '-': `${Math.round(r.__growthWin).toLocaleString('ja-JP')}å›/æ¨å®š${winDays}æ—¥`;
    const date  = r.publishedAt? r.publishedAt.slice(0,10) : '';
    return {views, likes, comms, avg, grow, date};
  };

  if (fmt==='html-list' || fmt==='html-cards'){
    if (fmt==='html-list'){
      const items = rows.map((r,i)=>{
        const v=viewLine(r);
        return `<li style="margin:.4em 0">
          <span style="font-weight:700;color:var(--muted)">#${num(i)}</span>
          <a href="${r.url}" target="_blank" rel="noopener" style="font-weight:800"> ${escHtml(r.title)}</a>
          â€” <a href="${r.url}" target="_blank" rel="noopener">${v.views}</a>
          â€” ğŸ‘ ${v.likes} â€” ğŸ’¬ ${v.comms} â€” ${v.avg} â€” ${v.grow}
          â€” <span style="color:var(--muted)">${escHtml(v.date)}</span>
        </li>`;
      }).join('');
      return `${headHtml}<ol start="${startNo}" style="padding-left:1.2em">${items}</ol>`;
    }else{
      const cards = rows.map((r,i)=>{
        const v=viewLine(r);
        return `<div class="card">
          <div class="no">#${num(i)}</div>
          <div class="title"><a href="${r.url}" target="_blank" rel="noopener">${escHtml(r.title)}</a></div>
          <div><a href="${r.url}" target="_blank" rel="noopener">${v.views}</a> ï½œ ğŸ‘ ${v.likes} ï½œ ğŸ’¬ ${v.comms}</div>
          <div>å¹³å‡/æ—¥ï¼š${v.avg} ï½œ æ¨å®šå¢—åˆ†ï¼š${v.grow}</div>
          <div class="muted">${escHtml(v.date)}</div>
        </div>`;
      }).join('');
      return `${headHtml}<div class="cards">${cards}</div>`;
    }
  }

  if (fmt==='md'){
    const header = channel? `## [${channel.title||''}](${channel.url || (channel.id?`https://www.youtube.com/channel/${channel.id}`:'')})
ç™»éŒ²è€…æ•°ï¼š${fmtNum(channel.subscriberCount)}ã€€ç·å†ç”Ÿå›æ•°ï¼š${fmtNum(channel.viewCount)}ã€€å‹•ç”»æ•°ï¼š${fmtNum(channel.videoCount)}
` : '';
    const lines = rows.map((r,i)=>{
      const v=viewLine(r);
      return `${num(i)}. [${r.title}](${r.url}) â€” [${v.views}](${r.url}) â€” ğŸ‘ ${v.likes} â€” ğŸ’¬ ${v.comms} â€” å¹³å‡/æ—¥ ${v.avg} â€” æ¨å®šå¢—åˆ† ${v.grow} â€” ${v.date}`;
    }).join('\n');
    return header + lines;
  }

  // TSV / CSV
  const sep = (fmt==='csv')? ',' : '\t';
  const esc = (s)=> {
    s=String(s??'');
    if (fmt==='csv' && /[",\n]/.test(s)) s = `"${s.replace(/"/g,'""')}"`;
    return s;
  };
  const head = ['No','URL','è¦–è´å›æ•°','é«˜è©•ä¾¡','ã‚³ãƒ¡ãƒ³ãƒˆ','å¹³å‡/æ—¥','æ¨å®šå¢—åˆ†(Næ—¥)','å…¬é–‹æ—¥','ã‚¿ã‚¤ãƒˆãƒ«'];
  const lines = [];
  if (channel){
    lines.push(
      ['Channel Title', channel.title||''].map(esc).join(sep),
      ['Channel URL', channel.url || (channel.id?`https://www.youtube.com/channel/${channel.id}`:'')].map(esc).join(sep),
      ['Subscribers', fmtNum(channel.subscriberCount)].map(esc).join(sep),
      ['Total Views', fmtNum(channel.viewCount)].map(esc).join(sep),
      ['Video Count', fmtNum(channel.videoCount)].map(esc).join(sep),
      ['', ''].map(esc).join(sep)
    );
  }
  lines.push(head.map(esc).join(sep));
  rows.forEach((r,i)=>{
    const v=viewLine(r);
    lines.push([num(i), r.url, v.views.replace('å›',''), v.likes, v.comms, v.avg.replace('/æ—¥',''), v.grow.replace('å›/æ¨å®š'+winDays+'æ—¥',''), v.date, r.title].map(esc).join(sep));
  });
  return lines.join('\n');
}

/* ========= å–å¾—ãƒ˜ãƒ«ãƒ‘ ========= */
function getKeyOrThrow(){ const k=apiKeyInput.value.trim(); if(!k) throw new Error('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return k; }
function busy(b,msg){ statusEl.textContent = b ? (msg||'å‡¦ç†ä¸­â€¦') : ''; }
function setCount(n){ countEl.textContent = (n==='â€”')?'â€”':String(Number(n)||0); }
function toast(msg){ statusEl.textContent = msg; setTimeout(()=> statusEl.textContent='', 1600); }
function clearOutput(){ outTA.value=''; setCount(0); renderPreviewIfHtml(''); }
function clampInt(v,min,max){ v=Math.floor(v); return Math.max(min, Math.min(max, v)); }

/* ========= YouTube APIï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ç›´ï¼‰ ========= */
async function runViaClient(key, raw, {max,since,sort}){
  const channelId = await resolveChannelIdSmart(raw, key);
  if (!channelId) throw new Error('ãƒãƒ£ãƒ³ãƒãƒ«IDã‚’è§£æ±ºã§ãã¾ã›ã‚“ã§ã—ãŸ');
  const [uploads, channel] = await Promise.all([ getUploadsPlaylistId(channelId, key), fetchChannelInfo(channelId, key) ]);
  if (!uploads) throw new Error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
  const videoIds = await listPlaylistVideoIds(uploads, key, max);
  const details  = await fetchVideosDetails(videoIds, key);
  let rows = videoIds.map((id,i)=>{
    const d=details.get(id)||{};
    return { url:`https://www.youtube.com/watch?v=${id}`, viewCount:d.viewCount??null, likeCount:d.likeCount??null, commentCount:d.commentCount??null, title:d.title??'', publishedAt:d.publishedAt??'', channelId:d.channelId||'', __idx:i };
  });
  rows = applySinceAndSort(rows,{since,sort});
  return { rows, channel };
}
function applySinceAndSort(rows,{since,sort}){
  if (since){
    const t0 = new Date(`${since}T00:00:00Z`).getTime();
    if (isFinite(t0)) rows = rows.filter(r=>{ const t=new Date(r.publishedAt||0).getTime(); return isFinite(t)&&t>=t0; });
  }
  if (sort==='newest'||sort==='oldest'){
    rows.sort((a,b)=>{ const ta=new Date(a.publishedAt||0).getTime(); const tb=new Date(b.publishedAt||0).getTime(); return sort==='newest'? (tb-ta):(ta-tb); });
  }
  return rows;
}

/* ========= GASçµŒç”± ========= */
async function runViaGAS(appUrl, channelInput, {max,since,sort}){
  const url = new URL(appUrl);
  url.searchParams.set('max', String(max));
  if (since) url.searchParams.set('since', since);
  if (/^UC[0-9A-Za-z_-]{22}$/.test(channelInput)) url.searchParams.set('channelId', channelInput);
  else url.searchParams.set('channel', channelInput);

  try{
    const json = await fetchJson(url.toString());
    return normalizeFromBackend(json, sort, since);
  }catch(_){
    const json = await jsonpFetch(url);
    return normalizeFromBackend(json, sort, since);
  }
}
function normalizeFromBackend(json, sort, since){
  if (!json || json.ok===false) throw new Error(json?.error || 'GASå¿œç­”ã‚¨ãƒ©ãƒ¼');
  let rows = (json.items||[]).map((it,i)=>({
    url: it.url||'', viewCount: it.viewCount!=null?Number(it.viewCount):null, likeCount: it.likeCount!=null?Number(it.likeCount):null, commentCount: it.commentCount!=null?Number(it.commentCount):null,
    title: it.title||'', publishedAt: it.publishedAt||'', channelId: it.channelId||'', __idx:i
  }));
  rows = applySinceAndSort(rows,{since,sort});
  const channel = json.channel ? {
    id: json.channel.id||'', title: json.channel.title||'', url: json.channel.url||'', avatar: json.channel.avatar||'',
    subscriberCount: json.channel.subscriberCount!=null?Number(json.channel.subscriberCount):null,
    viewCount: json.channel.viewCount!=null?Number(json.channel.viewCount):null,
    videoCount: json.channel.videoCount!=null?Number(json.channel.videoCount):null
  } : null;
  return { rows, channel };
}

/* ========= API å‘¼ã³å‡ºã—ç¾¤ ========= */
function looksLikeUrl(s){ return /^https?:\/\//i.test(String(s||'')); }
async function resolveChannelIdSmart(input, key){
  const raw=String(input||'').trim(); if(!raw) return null;
  if (/^UC[0-9A-Za-z_-]{22}$/.test(raw)) return raw;
  if (/^[0-9A-Za-z_-]{11}$/.test(raw)){ const cid=await getChannelIdFromVideo(raw,key); if (cid) return cid; }
  if (raw.startsWith('@')){ const cid=await searchChannelIdByHandle(raw.slice(1),key); if (cid) return cid; }
  if (looksLikeUrl(raw)){
    try{
      const u=new URL(raw); const host=u.hostname.replace(/^www\./,''); const parts=u.pathname.replace(/\/+$/,'').split('/').filter(Boolean);
      const vid=u.searchParams.get('v') || (['shorts','embed','live'].includes(parts[0])? parts[1] : null);
      if (host==='youtu.be' && parts[0]){ const cid=await getChannelIdFromVideo(parts[0].slice(0,11),key); if (cid) return cid; }
      if (vid){ const cid=await getChannelIdFromVideo(vid.slice(0,11),key); if (cid) return cid; }
      const list=u.searchParams.get('list'); if (list){ const cid=await getChannelIdFromPlaylist(list,key); if (cid) return cid; }
      const mCh=u.pathname.match(/\/channel\/(UC[0-9A-Za-z_-]{22})$/); if (mCh) return mCh[1];
      const mHandle=u.pathname.match(/\/@([^/]+)$/); if (mHandle){ const cid=await searchChannelIdByHandle(mHandle[1],key); if (cid) return cid; }
      const mCustom=u.pathname.match(/\/(c|user)\/([^/]+)$/); if (mCustom){ const cid=await searchChannelIdByQuery(mCustom[2],key); if (cid) return cid; }
    }catch{}
  }
  return await searchChannelIdByQuery(raw,key);
}

async function fetchJson(u){
  const res=await fetch(u,{cache:'no-store',mode:'cors',credentials:'omit'});
  const ct=(res.headers.get('content-type')||'').toLowerCase(); const txt=await res.text();
  if(!res.ok) throw new Error(`HTTP ${res.status} / ${txt.slice(0,200)}`);
  if(!ct.includes('application/json')) throw new Error(`JSONä»¥å¤–ã®å¿œç­”: ${ct} / ${txt.slice(0,160)}`);
  return JSON.parse(txt);
}
function jsonpFetch(urlObj){
  return new Promise((resolve,reject)=>{
    const u=new URL(urlObj.toString());
    const cb='__jsonp_cb_'+Date.now()+'_'+Math.floor(Math.random()*1e6);
    u.searchParams.set('callback', cb);
    const timer=setTimeout(()=>{cleanup();reject(new Error('JSONPã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ'));},15000);
    function cleanup(){ clearTimeout(timer); try{ delete window[cb]; }catch{} if(script&&script.parentNode) script.parentNode.removeChild(script); }
    window[cb]=data=>{ cleanup(); resolve(data); };
    const script=document.createElement('script'); script.src=u.toString();
    script.onerror=()=>{ cleanup(); reject(new Error('JSONPèª­è¾¼å¤±æ•—')); };
    document.head.appendChild(script);
  });
}

async function fetchChannelInfo(channelId, key){
  const ep=new URL('https://www.googleapis.com/youtube/v3/channels');
  ep.searchParams.set('part','snippet,statistics'); ep.searchParams.set('id',channelId); ep.searchParams.set('key',key);
  const r=await fetch(ep); await assertOk(r,'channels(stats) API'); const j=await r.json();
  const it=j.items?.[0]; if(!it) return null; const sn=it.snippet||{}, st=it.statistics||{};
  return { id:it.id, title:sn.title||'', url:`https://www.youtube.com/channel/${it.id}`, avatar:sn.thumbnails?.default?.url||'',
    subscriberCount: st.subscriberCount!=null? Number(st.subscriberCount):null,
    viewCount: st.viewCount!=null? Number(st.viewCount):null,
    videoCount: st.videoCount!=null? Number(st.videoCount):null };
}

async function getChannelIdFromVideo(videoId,key){
  const ep=new URL('https://www.googleapis.com/youtube/v3/videos');
  ep.searchParams.set('part','snippet'); ep.searchParams.set('id',videoId); ep.searchParams.set('key',key);
  const r=await fetch(ep); await assertOk(r,'videos API'); const j=await r.json();
  return j.items?.[0]?.snippet?.channelId || null;
}
async function getChannelIdFromPlaylist(playlistId,key){
  const ep=new URL('https://www.googleapis.com/youtube/v3/playlists');
  ep.searchParams.set('part','snippet'); ep.searchParams.set('id',playlistId); ep.searchParams.set('key',key);
  const r=await fetch(ep); await assertOk(r,'playlists API'); const j=await r.json();
  return j.items?.[0]?.snippet?.channelId || null;
}
async function searchChannelIdByHandle(handle,key){
  const ep=new URL('https://www.googleapis.com/youtube/v3/search');
  ep.searchParams.set('part','snippet'); ep.searchParams.set('type','channel'); ep.searchParams.set('q',handle);
  ep.searchParams.set('maxResults','1'); ep.searchParams.set('key',key);
  const r=await fetch(ep); await assertOk(r,'search(handle) API'); const j=await r.json();
  return j.items?.[0]?.id?.channelId || null;
}
async function searchChannelIdByQuery(query,key){
  const ep=new URL('https://www.googleapis.com/youtube/v3/search');
  ep.searchParams.set('part','snippet'); ep.searchParams.set('type','channel'); ep.searchParams.set('q',query);
  ep.searchParams.set('maxResults','1'); ep.searchParams.set('key',key);
  const r=await fetch(ep); await assertOk(r,'search(query) API'); const j=await r.json();
  return j.items?.[0]?.id?.channelId || null;
}
async function getUploadsPlaylistId(channelId,key){
  const ep=new URL('https://www.googleapis.com/youtube/v3/channels');
  ep.searchParams.set('part','contentDetails'); ep.searchParams.set('id',channelId); ep.searchParams.set('key',key);
  const r=await fetch(ep); await assertOk(r,'channels API'); const j=await r.json();
  return j.items?.[0]?.contentDetails?.relatedPlaylists?.uploads || null;
}
async function listPlaylistVideoIds(playlistId,key,maxCount){
  let ids=[]; let pageToken='';
  while(ids.length<maxCount){
    const ep=new URL('https://www.googleapis.com/youtube/v3/playlistItems');
    ep.searchParams.set('part','contentDetails'); ep.searchParams.set('playlistId',playlistId);
    ep.searchParams.set('maxResults','50'); if(pageToken) ep.searchParams.set('pageToken',pageToken); ep.searchParams.set('key',key);
    const r=await fetch(ep); await assertOk(r,'playlistItems API'); const j=await r.json();
    for (const it of (j.items||[])){ const id=it.contentDetails?.videoId; if(id) ids.push(id); if(ids.length>=maxCount) break; }
    pageToken=j.nextPageToken||''; if(!pageToken) break;
    busy(true, `å–å¾—ä¸­â€¦ ${ids.length}ä»¶`);
  }
  return ids;
}
async function fetchVideosDetails(videoIds,key){
  const map=new Map();
  for(let i=0;i<videoIds.length;i+=50){
    const chunk=videoIds.slice(i,i+50);
    const ep=new URL('https://www.googleapis.com/youtube/v3/videos');
    ep.searchParams.set('part','snippet,statistics'); ep.searchParams.set('id',chunk.join(',')); ep.searchParams.set('key',key);
    const r=await fetch(ep); await assertOk(r,'videos(details) API'); const j=await r.json();
    for (const it of (j.items||[])){
      map.set(it.id,{
        title: it.snippet?.title ?? '',
        viewCount: it.statistics?.viewCount!=null? Number(it.statistics.viewCount):null,
        likeCount: it.statistics?.likeCount!=null? Number(it.statistics.likeCount):null,
        commentCount: it.statistics?.commentCount!=null? Number(it.statistics.commentCount):null,
        publishedAt: it.snippet?.publishedAt ?? '',
        channelId: it.snippet?.channelId || ''
      });
    }
  }
  return map;
}

/* ========= å°ç‰© ========= */
async function assertOk(res,label){
  if(res.ok) return;
  let detail=''; try{ detail=' / '+(await res.text()).slice(0,200);}catch{}
  throw new Error(`${label} ã‚¨ãƒ©ãƒ¼: ${res.status}${detail}`);
}
function validateExecUrlOrThrow(s){
  const m=String(s||'').match(/https?:\/\/script\.google\.com\/macros\/s\/[A-Za-z0-9_-]+\/exec/);
  if(!m) throw new Error('GASã® APP_URLï¼ˆ/execï¼‰ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
  return m[0];
}

/* ========= æ•´å½¢ãƒ¢ãƒ¼ãƒ‰ï¼šURLâ†’idæŠ½å‡º ========= */
function extractVideoIds(text){
  const set=new Set(); const tokens=String(text||'').split(/[\s\n\r\t]+/).filter(Boolean);
  const re=/(?:v=|vi=|v%3D|youtu\.be\/|shorts\/|embed\/)([0-9A-Za-z_-]{11})/;
  for (const tk of tokens){
    if(/^https?:\/\//i.test(tk)){
      try{
        const u=new URL(tk); const host=u.hostname.replace(/^www\./,''); const parts=u.pathname.replace(/\/+$/,'').split('/').filter(Boolean);
        let id=u.searchParams.get('v'); if(!id && host==='youtu.be') id=parts[0]; if(!id && ['shorts','embed','live'].includes(parts[0])) id=parts[1];
        if(id && /^[0-9A-Za-z_-]{11}$/.test(id)){ set.add(id); continue; }
      }catch{}
      const m=tk.match(re); if(m&&m[1]){ set.add(m[1]); continue; }
    }
    if(/^[0-9A-Za-z_-]{11}$/.test(tk)) set.add(tk);
    else { const m=tk.match(re); if(m&&m[1]) set.add(m[1]); }
  }
  return Array.from(set);
}

/* ========= ä¾¿åˆ©ãƒœã‚¿ãƒ³ ========= */
copyBtn.onclick = async () => {
  try{ await navigator.clipboard.writeText(outTA.value); toast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); }
  catch{ alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
};
dlCsvBtn.onclick = ()=>{
  const text=outTA.value||'';
  const blob=new Blob([new Uint8Array([0xEF,0xBB,0xBF]), text.replace(/\t/g, ',')],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`youtube_${Date.now()}.csv`; document.body.appendChild(a); a.click(); a.remove();
};
</script>
