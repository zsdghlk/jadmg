<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>YouTube リンク収集（テキスト出力）</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;margin:24px;line-height:1.7}
  h1{font-size:1.2rem;margin:0 0 12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0}
  input,button{padding:8px}
  input[type="number"]{width:120px}
  textarea{width:100%;min-height:220px;padding:10px}
  .muted{color:#6b7280}
</style>

<h1>YouTube リンクをテキストで取得</h1>
<script>
// 追加
const DEFAULT_API_KEY = 'AIzaSyAsoGsbekSs5kfzjfIdxmuOdo44hwDqq3g';
</script>
<div class="row">
  <label>APIキー：</label>
  <input id="apiKey" placeholder="YouTube Data API v3 の APIキー" style="min-width:260px;flex:1">
  <button id="saveKey">保存</button>
  <span class="muted">（ローカル保存）</span>
</div>

<div class="row">
  <label>チャンネル：</label>
  <input id="channel" placeholder="@handle / UCxxxxxxxxxxxxxxxxxxxxxx / https://www.youtube.com/@handle など" style="min-width:320px;flex:1">
</div>

<div class="row">
  <label>最大件数：</label>
  <input id="limit" type="number" value="200" min="1" max="5000">
  <button id="run">取得</button>
  <span id="status" class="muted"></span>
</div>

<p class="muted">出力（1行=1リンク）</p>
<textarea id="out" placeholder="ここに動画URLが改行区切りで出ます"></textarea>

<script>
const apiKeyInput = document.getElementById('apiKey');
const channelInput = document.getElementById('channel');
const limitInput   = document.getElementById('limit');
const runBtn       = document.getElementById('run');
const outTA        = document.getElementById('out');
const statusEl     = document.getElementById('status');

// --- 保存/復元 ---
apiKeyInput.value = localStorage.getItem('yt_api_key') || '';
document.getElementById('saveKey').onclick = () => {
  localStorage.setItem('yt_api_key', apiKeyInput.value.trim());
  flash('APIキーを保存しました');
};

// --- 実行 ---
runBtn.onclick = async () => {
  const key = apiKeyInput.value.trim();
  const raw = channelInput.value.trim();
  const max = Math.max(1, Math.min(5000, Number(limitInput.value) || 200));
  if (!key) return alert('APIキーを入力してください');
  if (!raw) return alert('チャンネルを入力してください');

  try {
    setBusy(true);
    const channelId = await resolveChannelIdSmart(raw, key);
    if (!channelId) throw new Error('チャンネルIDを解決できませんでした');

    const uploads = await getUploadsPlaylistId(channelId, key);
    if (!uploads) throw new Error('アップロード済みプレイリストが見つかりませんでした');

    const videoIds = await listPlaylistVideoIds(uploads, key, max);

　　

    
    const urls = videoIds.map(id => `https://www.youtube.com/watch?v=${id}`);
    outTA.value = urls.join('\n');
    flash(`${urls.length}件のリンクを取得`);
  } catch (e) {
    console.error(e);
    // APIエラー本文があれば見せる
    alert('エラー: ' + (e.message || e));
  } finally {
    setBusy(false);
  }
};

// =======================================================
//  チャンネルID 解決（@/UC/URL/動画/shorts/PL 全対応 & URL時だけ new URL）
// =======================================================
function looksLikeUrl(s){ return /^https?:\/\//i.test(String(s||'')); }

async function resolveChannelIdSmart(input, key) {
  const raw = String(input||'').trim();
  if (!raw) return null;

  // 既にUC…なら即返す
  if (/^UC[0-9A-Za-z_-]{22}$/.test(raw)) return raw;

  // 11桁 → 動画IDの可能性
  if (/^[0-9A-Za-z_-]{11}$/.test(raw)) {
    const cid = await getChannelIdFromVideo(raw, key);
    if (cid) return cid;
  }

  // @handle
  if (raw.startsWith('@')) {
    const cid = await searchChannelIdByHandle(raw.slice(1), key);
    if (cid) return cid;
  }

  // URLのときだけ new URL を使う（Invalid URL を回避）
  if (looksLikeUrl(raw)) {
    try {
      const u = new URL(raw);
      const host = u.hostname.replace(/^www\./,'');
      const parts = u.pathname.replace(/\/+$/,'').split('/').filter(Boolean);

      // 動画URL群 → 動画IDから逆引き
      const vid =
        u.searchParams.get('v') ||
        (['shorts','embed','live'].includes(parts[0]) ? parts[1] : null);
      if (host === 'youtu.be' && parts[0]) {
        const cid = await getChannelIdFromVideo(parts[0].slice(0,11), key);
        if (cid) return cid;
      }
      if (vid) {
        const cid = await getChannelIdFromVideo(vid.slice(0,11), key);
        if (cid) return cid;
      }

      // プレイリスト → 逆引き
      const list = u.searchParams.get('list');
      if (list) {
        const cid = await getChannelIdFromPlaylist(list, key);
        if (cid) return cid;
      }

      // /channel/UC...
      const mCh = u.pathname.match(/\/channel\/(UC[0-9A-Za-z_-]{22})$/);
      if (mCh) return mCh[1];

      // /@handle
      const mHandle = u.pathname.match(/\/@([^/]+)$/);
      if (mHandle) {
        const cid = await searchChannelIdByHandle(mHandle[1], key);
        if (cid) return cid;
      }

      // /c/ や /user/ の旧URL → 検索で解決
      const mCustom = u.pathname.match(/\/(c|user)\/([^/]+)$/);
      if (mCustom) {
        const cid = await searchChannelIdByQuery(mCustom[2], key);
        if (cid) return cid;
      }
    } catch {
      // URLでなかった → 最後に検索へ
    }
  }

  // 最後の手段：キーワード検索
  return await searchChannelIdByQuery(raw, key);
}

// =======================================================
//  YouTube Data API 呼び出し
// =======================================================
async function getChannelIdFromVideo(videoId, key) {
  const ep = new URL('https://www.googleapis.com/youtube/v3/videos');
  ep.searchParams.set('part','snippet');
  ep.searchParams.set('id', videoId);
  ep.searchParams.set('key', key);
  const r = await fetch(ep);
  await assertOk_(r, 'videos API');
  const j = await r.json();
  return j.items?.[0]?.snippet?.channelId || null;
}

async function getChannelIdFromPlaylist(playlistId, key) {
  const ep = new URL('https://www.googleapis.com/youtube/v3/playlists');
  ep.searchParams.set('part','snippet');
  ep.searchParams.set('id', playlistId);
  ep.searchParams.set('key', key);
  const r = await fetch(ep);
  await assertOk_(r, 'playlists API');
  const j = await r.json();
  return j.items?.[0]?.snippet?.channelId || null;
}

async function searchChannelIdByHandle(handle, key) {
  const ep = new URL('https://www.googleapis.com/youtube/v3/search');
  ep.searchParams.set('part','snippet');
  ep.searchParams.set('type','channel');
  ep.searchParams.set('q', handle);
  ep.searchParams.set('maxResults','1');
  ep.searchParams.set('key', key);
  const r = await fetch(ep);
  await assertOk_(r, 'search(handle) API');
  const j = await r.json();
  return j.items?.[0]?.id?.channelId || null;
}

async function searchChannelIdByQuery(query, key) {
  const ep = new URL('https://www.googleapis.com/youtube/v3/search');
  ep.searchParams.set('part','snippet');
  ep.searchParams.set('type','channel');
  ep.searchParams.set('q', query);
  ep.searchParams.set('maxResults','1');
  ep.searchParams.set('key', key);
  const r = await fetch(ep);
  await assertOk_(r, 'search(query) API');
  const j = await r.json();
  return j.items?.[0]?.id?.channelId || null;
}

async function getUploadsPlaylistId(channelId, key) {
  const ep = new URL('https://www.googleapis.com/youtube/v3/channels');
  ep.searchParams.set('part', 'contentDetails');
  ep.searchParams.set('id', channelId);
  ep.searchParams.set('key', key);
  const r = await fetch(ep);
  await assertOk_(r, 'channels API');
  const j = await r.json();
  return j.items?.[0]?.contentDetails?.relatedPlaylists?.uploads || null;
}

async function listPlaylistVideoIds(playlistId, key, maxCount) {
  let ids = [];
  let pageToken = '';
  while (ids.length < maxCount) {
    const ep = new URL('https://www.googleapis.com/youtube/v3/playlistItems');
    ep.searchParams.set('part', 'contentDetails');
    ep.searchParams.set('playlistId', playlistId);
    ep.searchParams.set('maxResults', '50');
    if (pageToken) ep.searchParams.set('pageToken', pageToken);
    ep.searchParams.set('key', key);

    const r = await fetch(ep);
    await assertOk_(r, 'playlistItems API');
    const j = await r.json();

    for (const it of (j.items || [])) {
      const id = it.contentDetails?.videoId;
      if (id) ids.push(id);
      if (ids.length >= maxCount) break;
    }
    pageToken = j.nextPageToken || '';
    if (!pageToken) break;
    setBusy(true, `取得中… ${ids.length}件`);
  }
  return ids;
}
// 取得したIDで詳細情報をまとめ取り
const detailsMap = await fetchVideosDetails(videoIds, key);

// 出力：URL<TAB>視聴回数<TAB>タイトル（1行1本）
const lines = videoIds.map(id => {
  const d = detailsMap.get(id) || {};
  const url = `https://www.youtube.com/watch?v=${id}`;
  const views = (d.viewCount != null) ? Number(d.viewCount).toLocaleString('ja-JP') : '';
  const title = d.title || '';
  return `${url}\t${views}\t${title}`;
});
outTA.value = lines.join('\n');
flash(`${videoIds.length}件のリンク＋視聴回数＋タイトルを取得`);



  

// --- 共通: エラー本文を拾って見やすく ---
async function assertOk_(res, label){
  if (res.ok) return;
  let detail = '';
  try { detail = ' / ' + (await res.text()).slice(0,200); } catch {}
  throw new Error(`${label} エラー: ${res.status}${detail}`);
}

// --- UI helpers ---
function setBusy(b, msg){ runBtn.disabled = b; statusEl.textContent = b ? (msg || '取得中…') : '' }
function flash(msg){ statusEl.textContent = msg; setTimeout(()=> statusEl.textContent='', 1500) }
</script>
