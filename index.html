/*****************************************************
 * YouTube Data API v3 – Apps Script backend (simple)
 * - JSON / JSONP(callback=) 対応
 * - @handle / UC... / URL(動画/PL/旧URL) 解決
 * - Script Properties: YOUTUBE_API_KEY を優先
 * - items[]: videoId,url,title,publishedAt,viewCount,likeCount,commentCount,channelId
 * - channel: id,title,url,subscriberCount,viewCount,videoCount
 *****************************************************/
const API_KEY_FALLBACK = '';

function getApiKey_(){
  const prop = PropertiesService.getScriptProperties().getProperty('YOUTUBE_API_KEY');
  const key  = (prop || API_KEY_FALLBACK || '').trim();
  if (!key) throw new Error('APIキーが設定されていません（Script Properties に YOUTUBE_API_KEY を保存）');
  return key;
}

function doGet(e){
  const p = (e && e.parameter) || {};
  try{
    if (p.videoId){
      const txt = getVideoText_(String(p.videoId).trim());
      return textOut_(txt);
    }
    if (p.channelId || p.channel){
      const channelId = p.channelId ? String(p.channelId).trim() : resolveChannelId_(p.channel);
      if (!channelId) return jsonOut_({ ok:false, error:'channelId を解決できませんでした' }, p.callback);
      const max   = toInt_(p.max, 5000);
      const items = getUploadsItems_(channelId, max);
      const ch    = getChannelInfo_(channelId);
      return jsonOut_({ ok:true, type:'channel', channelId, count:items.length, channel:ch, items }, p.callback);
    }
    if (p.playlistId){
      const playlistId = String(p.playlistId).trim();
      const max   = toInt_(p.max, 5000);
      const items = getPlaylistItems_(playlistId, max);
      return jsonOut_({ ok:true, type:'playlist', playlistId, count:items.length, items }, p.callback);
    }
    const help = [
      '使い方:',
      '  ?videoId=XXXXXXXXXXX',
      '  ?channelId=UCxxxxxxxxxxxxxxxxxxxxxx [&max=5000]',
      '  ?channel=@handle  または  ?channel=https://www.youtube.com/@handle [&max=5000]',
      '  ?playlistId=PLxxxxxxxxxxxxxxxx [&max=5000]'
    ].join('\n');
    return textOut_(help);
  }catch(err){
    return jsonOut_({ ok:false, error: (err && err.message)||String(err) }, p.callback);
  }
}

/* ====== 出力ヘルパ ====== */
function textOut_(s){ return ContentService.createTextOutput(String(s)); }
function jsonOut_(obj, cb){
  const body = JSON.stringify(obj, null, 2);
  if (cb) return ContentService.createTextOutput(`${cb}(${body})`).setMimeType(ContentService.MimeType.JAVASCRIPT);
  return ContentService.createTextOutput(body).setMimeType(ContentService.MimeType.JSON);
}
function toInt_(v,d){ v=Number(v); if(!isFinite(v)||v<=0) return d; return Math.min(Math.floor(v),5000); }

/* ====== 動画1本：整形テキスト ====== */
function getVideoText_(videoId){
  const key=getApiKey_();
  const url='https://www.googleapis.com/youtube/v3/videos'
    +'?part=snippet,statistics'+'&id='+encodeURIComponent(videoId)+'&key='+encodeURIComponent(key);
  const j=httpGetJson_(url);
  if(!j.items||!j.items.length) throw new Error('動画情報が見つかりませんでした。videoIdを確認してください。');
  const v=j.items[0], sn=v.snippet||{}, st=v.statistics||{};
  const title=sn.title||'', ch=sn.channelTitle||'', published = sn.publishedAt ? new Date(sn.publishedAt).toLocaleString('ja-JP') : '-';
  const views=Number(st.viewCount||0).toLocaleString('ja-JP'), likes = st.likeCount!=null? Number(st.likeCount).toLocaleString('ja-JP'):'-';
  return ['--- YouTube動画情報 ---',`タイトル: ${title}`,`チャンネル名: ${ch}`,`公開日時: ${published}`,'--------------------------',`再生回数: ${views} 回`,`高評価数: ${likes}`,'--------------------------'].join('\n');
}

/* ====== チャンネル全件 ====== */
function getUploadsItems_(channelId, maxCount){
  const uploadsId = getUploadsPlaylistId_(channelId);
  if(!uploadsId) throw new Error('アップロード用プレイリストが見つかりませんでした');
  const ids = listPlaylistVideoIds_(uploadsId, maxCount);
  const vids = fetchVideosInfo_(ids);
  return vids.map(v=>({
    videoId:v.id,
    url:'https://www.youtube.com/watch?v='+v.id,
    title:(v.snippet&&v.snippet.title)||'',
    publishedAt:(v.snippet&&v.snippet.publishedAt)||'',
    viewCount:Number((v.statistics&&v.statistics.viewCount)||0),
    likeCount: v.statistics && v.statistics.likeCount!=null ? Number(v.statistics.likeCount) : null,
    commentCount: v.statistics && v.statistics.commentCount!=null ? Number(v.statistics.commentCount) : null,
    channelId:(v.snippet&&v.snippet.channelId)||''
  }));
}
function getUploadsPlaylistId_(channelId){
  const cache=CacheService.getScriptCache(); const ck='uploads:'+channelId; const hit=cache.get(ck); if(hit) return hit;
  const key=getApiKey_();
  const url='https://www.googleapis.com/youtube/v3/channels'
    +'?part=contentDetails'+'&id='+encodeURIComponent(channelId)+'&key='+encodeURIComponent(key);
  const j=httpGetJson_(url);
  const uploads=j.items && j.items[0]?.contentDetails?.relatedPlaylists?.uploads || null;
  if(uploads) cache.put(ck, uploads, 21600);
  return uploads;
}

/* ====== プレイリスト全件 ====== */
function getPlaylistItems_(playlistId, maxCount){
  const ids = listPlaylistVideoIds_(playlistId, maxCount);
  const vids = fetchVideosInfo_(ids);
  return vids.map(v=>({
    videoId:v.id,
    url:'https://www.youtube.com/watch?v='+v.id,
    title:(v.snippet&&v.snippet.title)||'',
    publishedAt:(v.snippet&&v.snippet.publishedAt)||'',
    viewCount:Number((v.statistics&&v.statistics.viewCount)||0),
    likeCount: v.statistics && v.statistics.likeCount!=null ? Number(v.statistics.likeCount) : null,
    commentCount: v.statistics && v.statistics.commentCount!=null ? Number(v.statistics.commentCount) : null,
    channelId:(v.snippet&&v.snippet.channelId)||''
  }));
}
function listPlaylistVideoIds_(playlistId, maxCount){
  const key=getApiKey_(); let ids=[], pageToken='';
  while(ids.length<maxCount){
    const url='https://www.googleapis.com/youtube/v3/playlistItems'
      +'?part=contentDetails'+'&playlistId='+encodeURIComponent(playlistId)
      +'&maxResults=50'+(pageToken? '&pageToken='+encodeURIComponent(pageToken):'')
      +'&key='+encodeURIComponent(key);
    const j=httpGetJson_(url);
    (j.items||[]).forEach(it=>{ const id=it?.contentDetails?.videoId; if(id) ids.push(id); });
    if(!j.nextPageToken || ids.length>=maxCount) break;
    pageToken=j.nextPageToken;
  }
  return ids.slice(0, maxCount);
}

/* ====== まとめて動画情報 ====== */
function fetchVideosInfo_(videoIds){
  if(!videoIds.length) return [];
  const key=getApiKey_(); const out=[];
  for(let i=0;i<videoIds.length;i+=50){
    const chunk=videoIds.slice(i,i+50);
    const url='https://www.googleapis.com/youtube/v3/videos'
      +'?part=snippet,statistics'+'&id='+encodeURIComponent(chunk.join(','))+'&key='+encodeURIComponent(key);
    const j=httpGetJson_(url); (j.items||[]).forEach(v=>out.push(v));
  }
  return out;
}

/* ====== チャンネル統計 ====== */
function getChannelInfo_(channelId){
  const key=getApiKey_();
  const url='https://www.googleapis.com/youtube/v3/channels'
    +'?part=snippet,statistics'+'&id='+encodeURIComponent(channelId)+'&key='+encodeURIComponent(key);
  const j=httpGetJson_(url);
  const it=j.items && j.items[0]; if(!it) return null;
  const sn=it.snippet||{}, st=it.statistics||{};
  return {
    id:it.id, title:sn.title||'', url:'https://www.youtube.com/channel/'+it.id,
    subscriberCount: st.subscriberCount!=null? Number(st.subscriberCount):null,
    viewCount: st.viewCount!=null? Number(st.viewCount):null,
    videoCount: st.videoCount!=null? Number(st.videoCount):null
  };
}

/* ====== 入力解決 ====== */
function resolveChannelId_(input){
  const raw=String(input||'').trim(); if(!raw) return null;
  if(/^UC[0-9A-Za-z_-]{22}$/.test(raw)) return raw;
  if(raw.startsWith('@')) return channelIdBySearch_(raw.slice(1));
  if(/^https?:\/\//i.test(raw)){
    try{
      const u=new URL(raw); const host=u.hostname.replace(/^www\./,''), path=u.pathname.replace(/\/+$/,''), parts=path.split('/').filter(Boolean);
      const vid=u.searchParams.get('v') || (['shorts','embed','live'].includes(parts[0])? parts[1] : null);
      if(host==='youtu.be' && parts[0]) return channelIdFromVideo_(parts[0].slice(0,11));
      if(vid) return channelIdFromVideo_(vid.slice(0,11));
      const list=u.searchParams.get('list'); if(list) return channelIdFromPlaylist_(list);
      const mCh=path.match(/\/channel\/(UC[0-9A-Za-z_-]{22})$/); if(mCh) return mCh[1];
      const mHandle=path.match(/\/@([^/]+)$/); if(mHandle) return channelIdBySearch_(mHandle[1]);
      const mCustom=path.match(/\/(c|user)\/([^/]+)$/); if(mCustom) return channelIdBySearch_(mCustom[2]);
    }catch(e){}
  }
  // 11桁は動画IDの可能性
  if(/^[0-9A-Za-z_-]{11}$/.test(raw)) return channelIdFromVideo_(raw);
  return channelIdBySearch_(raw);
}
function channelIdFromVideo_(videoId){
  const key=getApiKey_(); const url='https://www.googleapis.com/youtube/v3/videos'
    +'?part=snippet'+'&id='+encodeURIComponent(videoId)+'&key='+encodeURIComponent(key);
  const j=httpGetJson_(url); return j.items && j.items[0]?.snippet?.channelId || null;
}
function channelIdFromPlaylist_(playlistId){
  const key=getApiKey_(); const url='https://www.googleapis.com/youtube/v3/playlists'
    +'?part=snippet'+'&id='+encodeURIComponent(playlistId)+'&key='+encodeURIComponent(key);
  const j=httpGetJson_(url); return j.items && j.items[0]?.snippet?.channelId || null;
}
function channelIdBySearch_(query){
  const cache=CacheService.getScriptCache(); const ck='handle:'+query; const hit=cache.get(ck); if(hit) return hit;
  const key=getApiKey_(); const url='https://www.googleapis.com/youtube/v3/search'
    +'?part=snippet&type=channel&maxResults=1&q='+encodeURIComponent(query)+'&key='+encodeURIComponent(key);
  const j=httpGetJson_(url); const cid=j.items && j.items[0]?.id?.channelId || null;
  if(cid) cache.put(ck, cid, 21600);
  return cid;
}

/* ====== HTTP ====== */
function httpGetJson_(url){
  const res=UrlFetchApp.fetch(url,{muteHttpExceptions:true}); const code=res.getResponseCode(); const body=res.getContentText();
  if(code<200||code>=300) throw new Error('HTTP '+code+' / '+body.slice(0,300));
  return JSON.parse(body);
}
