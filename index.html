<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- CSP: インラインJSは nonce のみ許可。外部は self / Apps Script ドメインを許可 -->
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self';
               script-src 'self' https://script.google.com https://script.googleusercontent.com 'nonce-yttool123';
               connect-src 'self' https://script.google.com https://script.googleusercontent.com;
               img-src 'self' data:;
               style-src 'self' 'unsafe-inline'">

<title>YouTube 全件取得 — 見やすいテキスト出力（安全プロキシ版）</title>
<style>
  :root{ --bg:#0b0c10; --panel:#121317cc; --panel-strong:#161821; --text:#eef2f7; --muted:#9aa0a6; --bd:#1f2128; --accent:#6ea8fe; --accent-2:#4f8cff; --ok:#1db954; --warn:#ffb020 }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f6f7fb; --panel:#ffffffcc; --panel-strong:#ffffff; --text:#0a0b0f; --muted:#5d6269; --bd:#e6e8ee; --accent:#1e88e5; --accent-2:#1565c0; --ok:#0aa84f; --warn:#f5a623 }
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0;
    background:
      radial-gradient(1200px 500px at 20% -10%, #2a3345 0%, transparent 60%),
      radial-gradient(1200px 500px at 100% 0%, #1a2233 0%, transparent 50%),
      var(--bg);
    color:var(--text);
    font:16px/1.75 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .wrap{ max-width:1000px; margin:0 auto; padding:22px 18px 48px }
  header h1{ margin:6px 0 6px; font-size:clamp(18px,4.5vw,28px); letter-spacing:.2px }
  header p{ margin:6px 0 0; color:var(--muted); font-size:.95rem }
  .panel{ background:var(--panel); border:1px solid var(--bd); border-radius:16px; padding:16px; margin:14px 0 18px; backdrop-filter: blur(8px) saturate(1.2) }
  .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center }
  .grid{ display:grid; gap:12px; grid-template-columns:1fr }
  @media (min-width:760px){ .grid.cols-2{ grid-template-columns:1.4fr 1fr } }
  label{ display:block; font-weight:700; margin:2px 0 6px; font-size:.92rem }
  input,select,button{ width:100%; padding:12px 13px; border-radius:12px; outline:none; border:1px solid var(--bd); background:#0d0f14; color:var(--text) }
  @media (prefers-color-scheme: light){ input,select,button{ background:#fff } }
  input::placeholder{ color: color-mix(in oklab, var(--muted) 85%, transparent) }
  .btn{ background:linear-gradient(180deg, var(--accent), var(--accent-2)); color:#fff; border:none; cursor:pointer; font-weight:800; box-shadow:0 6px 18px color-mix(in oklab, var(--accent-2) 35%, transparent); transition: transform .06s ease, filter .15s ease }
  .btn:active{ transform: translateY(1px) scale(.998) }
  .btn:hover{ filter: brightness(1.03) }
  .status{ color:var(--muted); min-height:1.2em }
  .statbar{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; padding:12px; border-radius:14px; border:1px dashed var(--bd); background: color-mix(in oklab, var(--panel-strong) 70%, transparent) }
  .ch-title{ font-weight:900; font-size:clamp(16px,3.8vw,20px); display:flex; align-items:center; gap:10px }
  .ch-title a{ color:inherit; text-decoration:none; border-bottom:1px dotted color-mix(in oklab, var(--text) 30%, transparent) }
  .chips{ display:flex; flex-wrap:wrap; gap:8px }
  .chip{ border:1px solid var(--bd); border-radius:999px; padding:.4em .8em; background:transparent; font-weight:700; color:var(--muted) }
  .count{ background: color-mix(in oklab, var(--accent) 20%, transparent); color:#fff; border-color:transparent }
  ol.video-list{ list-style:none; margin:10px 0 0; padding:0; counter-reset:vid }
  .v{ position:relative; border:1px solid var(--bd); border-radius:14px; padding:12px 12px 10px; margin:12px 0; background: color-mix(in oklab, var(--panel-strong) 80%, transparent); display:grid; gap:6px }
  .v::before{ counter-increment:vid; content:counter(vid); position:absolute; inset:-12px auto auto -12px; background:var(--ok); color:#fff; height:28px; min-width:28px; padding:0 8px; border-radius:999px; display:grid; place-items:center; font-weight:900; font-size:.9rem; box-shadow:0 6px 14px color-mix(in oklab, var(--ok) 40%, transparent) }
  .v a{ color:var(--accent); font-weight:800; text-decoration:none }
  .meta{ color:var(--muted); font-size:.92rem; display:flex; gap:10px; flex-wrap:wrap }
  .sep::before{ content:'•'; margin:0 .5em; color: color-mix(in oklab, var(--muted) 70%, transparent) }
  .muted{ color:var(--muted) }
  .kbd{ font:600 .85rem/1.1 ui-monospace,SFMono-Regular,Menlo,Consolas,"Noto Sans Mono",monospace; background:#07090d; color:#dbe6ff; padding:.35em .55em; border-radius:.5rem; border:1px solid var(--bd) }
  @media (prefers-color-scheme: light){ .kbd{ background:#fafafa; color:#001b4d } }
  .help{ font-size:.92rem }
  .fade-in{ animation: fade .24s ease both }
  @keyframes fade{ from{ opacity:0; transform: translateY(3px)} to{opacity:1; transform: translateY(0)} }
</style>

<div class="wrap">
  <header>
    <h1>YouTube 全件取得（安全プロキシ利用）</h1>
    <p class="help">URL を 1つ貼り付け → <span class="kbd">取得</span>。@ハンドル / UCID / チャンネルURL / 動画URL / プレイリストURL すべてOK。APIキーはサーバー保管なので表示されません。</p>
  </header>

  <section class="panel fade-in">
    <div class="grid cols-2">
      <div>
        <label for="inputUrl">URL（チャンネル / 動画 / プレイリスト / @ハンドル / UCID）</label>
        <input id="inputUrl" placeholder="例）https://www.youtube.com/@Google | https://youtu.be/XXXXXXXXXXX | https://www.youtube.com/playlist?list=PL..." />
      </div>
      <div>
        <label for="postSort">並び替え</label>
        <select id="postSort" aria-label="並び替え">
          <option value="none" selected>取得順のまま</option>
          <option value="viewsDesc">視聴回数 多い順</option>
          <option value="viewsAsc">視聴回数 少ない順</option>
          <option value="likesDesc">高評価 多い順</option>
          <option value="likesAsc">高評価 少ない順</option>
          <option value="commentsDesc">コメント 多い順</option>
          <option value="commentsAsc">コメント 少ない順</option>
          <option value="newest">公開日 新しい順</option>
          <option value="oldest">公開日 古い順</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="run" class="btn" style="flex:1" aria-busy="false">取得</button>
      <div id="status" class="status" style="flex:2 1 200px" aria-live="polite"></div>
    </div>
  </section>

  <section id="chPanel" class="panel fade-in" style="display:none">
    <div class="statbar">
      <div class="ch-title" id="chTitle">-</div>
      <div class="chips">
        <span class="chip" id="chipSubs">登録者数：-</span>
        <span class="chip" id="chipViews">総再生回数：-</span>
        <span class="chip" id="chipCount">動画数：-</span>
        <span class="chip count" id="chipGot">取得件数：0</span>
      </div>
    </div>
  </section>

  <section class="panel fade-in">
    <ol id="list" class="video-list"></ol>
  </section>

  <section class="panel fade-in help">
    <details>
      <summary class="muted">ヒント / セキュリティ</summary>
      <ul>
        <li>動画URL → その動画の<strong>所属チャンネルの全動画</strong>を取得。</li>
        <li>プレイリストURL/ID → その<strong>プレイリストの全動画</strong>を取得（チャンネル統計は非表示）。</li>
        <li>上限は最大 5,000 本（APIクォータに注意）。</li>
        <li>APIキーはサーバーのスクリプトプロパティに保管。フロントへ露出しません。</li>
      </ul>
    </details>
  </section>
</div>

<!-- inline script: CSP の nonce と一致させる -->
<script nonce="yttool123">
/* ========== 設定 ========== */
/** ★あなたの GAS WebアプリURL（末尾 /exec） */
const API_BASE = 'https://script.google.com/macros/s/AKfycbxOwLPNL5zlcyzChiywKmFNzrtKDgC1JrcUJAs3FB8cG5UlOUoyDi4VvDY-cVuMq9czdg/exec';

/* ========== DOM ========== */
const inputUrl = document.getElementById('inputUrl');
const postSort = document.getElementById('postSort');
const runBtn   = document.getElementById('run');
const statusEl = document.getElementById('status');

const chPanel  = document.getElementById('chPanel');
const chTitle  = document.getElementById('chTitle');
const chipSubs = document.getElementById('chipSubs');
const chipViews= document.getElementById('chipViews');
const chipCount= document.getElementById('chipCount');
const chipGot  = document.getElementById('chipGot');
const listEl   = document.getElementById('list');

/* ========== 状態 ========== */
let baseRows = [];      // 取得した生データ（以後の並び替えはローカルのみ）
let lastChannel = null;
const MAX_FETCH = 5000;

/* ========== ユーティリティ ========== */
function isValidExecURL(s){
  try{ const u = new URL(String(s||'').trim()); return /^https?:$/.test(u.protocol) && /\/exec$/.test(u.pathname); }
  catch{ return false; }
}

function jsonp(endpoint, params={}){
  const base = (API_BASE||'').trim();
  if (!isValidExecURL(base)) throw new Error('API_BASE が未設定か不正です（/exec の完全URLを設定）');
  const cbName='__jp'+Math.random().toString(36).slice(2);
  return new Promise((resolve,reject)=>{
    let u; try{ u=new URL(base);}catch{ reject(new Error('API_BASE の URL 形式が不正です')); return; }
    u.searchParams.set('op', endpoint);
    for (const [k,v] of Object.entries(params)) if (v!=null && v!=='') u.searchParams.set(k,String(v));
    u.searchParams.set('callback', cbName);

    const scr=document.createElement('script'); const timer=setTimeout(()=>{cleanup();reject(new Error('JSONP timeout'));},30000);
    function cleanup(){ clearTimeout(timer); try{ delete window[cbName]; }catch{} scr.remove(); }
    window[cbName]=(data)=>{ cleanup(); data&&data.error ? reject(new Error(data.error)) : resolve(data); };
    scr.onerror=()=>{ cleanup(); reject(new Error('JSONP network error')); };
    scr.async=true; scr.referrerPolicy='no-referrer'; scr.src=u.toString();
    document.body.appendChild(scr);
  });
}

function busy(b,msg){ runBtn.disabled=b; runBtn.setAttribute('aria-busy', b?'true':'false'); statusEl.textContent=b?(msg||'取得中…'):''; }
function toast(msg){ statusEl.textContent=msg; setTimeout(()=> statusEl.textContent='',1600); }
function fmtNum(n){ return (n==null||isNaN(n))?'-':Number(n).toLocaleString('ja-JP'); }
function esc(s){ return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ========== 起動時ヘルスチェック ========== */
(async function bootCheck(){
  if (!isValidExecURL(API_BASE)) { statusEl.textContent='エラー: API_BASE が未設定か不正です'; runBtn.disabled=true; return; }
  try{ await jsonp('health'); runBtn.disabled=false; statusEl.textContent=''; }
  catch(e){ runBtn.disabled=true; statusEl.textContent='エラー: GAS に接続できません（デプロイと YT_API_KEY を確認）'; console.error(e); }
})();

/* ========== UI ハンドラ ========== */
runBtn.onclick = async () => {
  const raw = inputUrl.value.trim();
  if (!raw) return alert('URL を入力してください');
  try{
    busy(true, '解析中…'); setChannel(null); renderRows([]);
    const {rows, channel} = await runViaProxy(raw);
    baseRows   = rows;
    lastChannel= channel;
    const sorted = sortAfter([...baseRows], postSort.value);
    setChannel(channel, sorted.length);
    renderRows(sorted);
    toast(`${sorted.length} 件 取得しました`);
  }catch(err){
    console.error(err); setChannel(null); renderRows([]); alert('エラー: '+(err?.message||err));
  }finally{ busy(false); }
};

postSort.addEventListener('change', () => {
  if (!baseRows.length) return;
  const rows = sortAfter([...baseRows], postSort.value);
  renderRows(rows);
  if (lastChannel) setChannel(lastChannel, rows.length);
  toast('ローカルで並び替えました（再取得なし）');
});

inputUrl.addEventListener('keydown', (e)=>{ if (e.key==='Enter') runBtn.click(); });

/* ========== コア処理（高速API優先→失敗時フォールバック） ========== */
async function runViaProxy(raw){
  const type = detectInputType(raw);

  // --- プレイリスト ---
  if (type.kind === 'playlist'){
    try{
      const r = await jsonp('playlistDetailsAll', { playlistId: type.playlistId, max: MAX_FETCH });
      return { rows: r.items.map(toRowFromAPI), channel: null };
    }catch(_){
      const ids = await listPlaylistVideoIds_legacy(type.playlistId, MAX_FETCH);
      const details = await fetchVideosDetails_legacy(ids);
      const rows = ids.map((id,i)=> toRowFromDetail(details.get(id), id, i));
      return { rows, channel: null };
    }
  }

  // --- チャンネル or 動画 → チャンネルID ---
  let channelId = null;
  if (type.kind==='channel') channelId=type.channelId;
  if (type.kind==='video')   channelId=await getChannelIdFromVideo(type.videoId);
  if (type.kind==='channelQuery') channelId=await searchChannelId(type.q);
  if (!channelId) throw new Error('チャンネルIDを解決できませんでした');

  // 高速一括
  try{
    const r = await jsonp('channelUploadsDetailsAll', { id: channelId, max: MAX_FETCH });
    return {
      rows: r.items.map(toRowFromAPI),
      channel: r.channel ? {
        id:r.channel.id, title:r.channel.title, url:r.channel.url,
        subscriberCount:r.channel.subscriberCount, viewCount:r.channel.viewCount, videoCount:r.channel.videoCount
      } : null
    };
  }catch(_){
    const uploadsInfo = await getUploadsPlaylistId(channelId);
    if (!uploadsInfo?.uploads) throw new Error('アップロード済みプレイリストが見つかりませんでした');
    const [ids, ch] = await Promise.all([
      listPlaylistVideoIds_legacy(uploadsInfo.uploads, MAX_FETCH),
      fetchChannelInfo(channelId)
    ]);
    const details = await fetchVideosDetails_legacy(ids);
    const rows = ids.map((id,i)=> toRowFromDetail(details.get(id), id, i));
    return { rows, channel: ch };
  }
}

/* ========== 入力タイプ検出 ========== */
function detectInputType(raw){
  const s=String(raw||'').trim(); if(!s) return {kind:'unknown'};
  if(/^UC[0-9A-Za-z_-]{22}$/.test(s)) return {kind:'channel',channelId:s};
  if(s.startsWith('@')) return {kind:'channelQuery',q:s.slice(1)};
  if(/^https?:\/\//i.test(s)){
    try{
      const u=new URL(s); const host=u.hostname.replace(/^www\./,'');
      const parts=u.pathname.replace(/\/+$/,'').split('/').filter(Boolean);
      const vid=u.searchParams.get('v')||(['shorts','embed','live'].includes(parts[0])?parts[1]:null);
      const list=u.searchParams.get('list');
      if(host==='youtu.be'&&parts[0]) return {kind:'video',videoId:parts[0].slice(0,11)};
      if(vid) return {kind:'video',videoId:vid.slice(0,11)};
      if(list) return {kind:'playlist',playlistId:list};
      const mCh=u.pathname.match(/\/channel\/(UC[0-9A-Za-z_-]{22})$/);
      if(mCh) return {kind:'channel',channelId:mCh[1]};
      const mHandle=u.pathname.match(/\/@([^/]+)$/);
      if(mHandle) return {kind:'channelQuery',q:mHandle[1]};
      const mCustom=u.pathname.match(/\/(c|user)\/([^/]+)$/);
      if(mCustom) return {kind:'channelQuery',q:mCustom[2]};
    }catch{}
  }
  if(/^[0-9A-Za-z_-]{11}$/.test(s)) return {kind:'video',videoId:s};
  return {kind:'channelQuery',q:s};
}

/* ========== 行変換 & フォールバック呼び出し ========== */
function toRowFromAPI(it, i){
  return {
    url: `https://www.youtube.com/watch?v=${it.id}`,
    title: it.title || '',
    viewCount: it.viewCount ?? null,
    likeCount: it.likeCount ?? null,
    commentCount: it.commentCount ?? null,
    publishedAt: it.publishedAt || '',
    videoId: it.id,
    __idx: i ?? 0
  };
}

async function fetchChannelInfo(channelId){ const r=await jsonp('channelInfo',{id:channelId}); const d=r?.data; if(!d) return null; return {id:d.id,title:d.title,url:d.url,subscriberCount:d.subscriberCount,viewCount:d.viewCount,videoCount:d.videoCount}; }
async function getChannelIdFromVideo(vid){ const r=await jsonp('channelFromVideo',{id:vid}); return r?.channelId||null; }
async function getUploadsPlaylistId(ch){ const r=await jsonp('uploads',{id:ch}); return r?.data||null; }
async function searchChannelId(q){ const r=await jsonp('searchChannel',{q}); return r?.channelId||null; }

async function listPlaylistVideoIds_legacy(pid,maxCount){
  let ids=[], pageToken=''; while(ids.length<Math.min(maxCount,MAX_FETCH)){
    const r=await jsonp('playlistItems',{playlistId:pid,pageToken});
    const chunk=(r?.items||[]).map(it=>it?.contentDetails?.videoId).filter(Boolean);
    ids.push(...chunk); pageToken=r?.nextPageToken||''; if(!pageToken) break; busy(true,`取得中… ${ids.length}件`);
  } return ids.slice(0,Math.min(maxCount,MAX_FETCH));
}
async function fetchVideosDetails_legacy(videoIds, concurrency=6){
  const map=new Map(); const chunks=[]; for(let i=0;i<videoIds.length;i+=50) chunks.push(videoIds.slice(i,i+50));
  let cursor=0; async function worker(){ while(true){ const my=cursor++; if(my>=chunks.length) break; const ids=chunks[my].join(','); busy(true,`詳細取得中… ${Math.min((my+1)*50,videoIds.length)}/${videoIds.length}`); const r=await jsonp('videos',{ids}); for(const it of (r?.items||[])){ const st=it.statistics||{}, sn=it.snippet||{}; map.set(it.id,{title:sn.title??'',viewCount:st.viewCount!=null?Number(st.viewCount):null,likeCount:st.likeCount!=null?Number(st.likeCount):null,commentCount:st.commentCount!=null?Number(st.commentCount):null,publishedAt:sn.publishedAt??''}); } } }
  await Promise.all(Array.from({length:Math.min(concurrency,chunks.length)},worker)); return map;
}
function toRowFromDetail(d,id,i){ return { url:`https://www.youtube.com/watch?v=${id}`, title:d?.title??'', viewCount:d?.viewCount??null, likeCount:d?.likeCount??null, commentCount:d?.commentCount??null, publishedAt:d?.publishedAt??'', videoId:id, __idx:i }; }

/* ========== 並び替え & 描画（平均/日なし） ========== */
function sortAfter(rows,key){
  const byNum=(field,asc=true)=>(a,b)=>{ const av=Number(a[field]), bv=Number(b[field]); const aNaN=isNaN(av), bNaN=isNaN(bv);
    if(aNaN&&bNaN) return a.__idx-b.__idx; if(aNaN) return 1; if(bNaN) return -1; return asc?(av-bv):(bv-av); };
  switch(key){
    case 'viewsDesc': return rows.sort(byNum('viewCount',false));
    case 'viewsAsc' : return rows.sort(byNum('viewCount',true ));
    case 'likesDesc': return rows.sort(byNum('likeCount',false));
    case 'likesAsc' : return rows.sort(byNum('likeCount',true ));
    case 'commentsDesc': return rows.sort(byNum('commentCount',false));
    case 'commentsAsc' : return rows.sort(byNum('commentCount',true ));
    case 'newest'  : return rows.sort((a,b)=> new Date(b.publishedAt)-new Date(a.publishedAt));
    case 'oldest'  : return rows.sort((a,b)=> new Date(a.publishedAt)-new Date(b.publishedAt));
    default        : return rows.sort((a,b)=> a.__idx-b.__idx);
  }
}

function renderRows(rows){
  listEl.innerHTML=''; chipGot.textContent=`取得件数：${rows.length}`;
  const frag=document.createDocumentFragment();
  rows.forEach((r)=>{ const li=document.createElement('li'); li.className='v';
    const a=document.createElement('a'); a.href=r.url; a.target='_blank'; a.rel='noopener noreferrer'; a.textContent=r.title||'(no title)'; li.appendChild(a);
    const meta=document.createElement('div'); meta.className='meta';
    meta.innerHTML=[
      `${fmtNum(r.viewCount)}回 再生`,
      (r.likeCount==null?'-':`${fmtNum(r.likeCount)} 高評価`),
      (r.commentCount==null?'-':`${fmtNum(r.commentCount)} コメント`),
      (r.publishedAt?new Date(r.publishedAt).toLocaleDateString('ja-JP'):'-')
    ].map((t,idx)=> idx===0?t:`<span class="sep"></span>${t}`).join('');
    li.appendChild(meta); frag.appendChild(li);
  });
  listEl.appendChild(frag);
}

function setChannel(ch,got=0){
  if(!ch){ chPanel.style.display='none'; chipGot.textContent='取得件数：0'; return; }
  chPanel.style.display=''; chTitle.innerHTML=`<a href="${ch.url}" target="_blank" rel="noopener noreferrer">${esc(ch.title||'')}</a>`;
  chipSubs.textContent=`登録者数：${fmtNum(ch.subscriberCount)}人`; chipViews.textContent=`総再生回数：${fmtNum(ch.viewCount)}回`;
  chipCount.textContent=`動画数：${fmtNum(ch.videoCount)}本`; chipGot.textContent=`取得件数：${got}`;
}
</script>
