<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- 高コントラスト & PWA想定のCSP -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' https://script.google.com https://script.googleusercontent.com 'nonce-yttool123';
                 connect-src 'self' https://script.google.com https://script.googleusercontent.com;
                 img-src 'self' data:;
                 style-src 'self' 'unsafe-inline';
                 worker-src 'self';
                 manifest-src 'self'">

  <title>YouTube情報一括取得</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0b66ff">

  <style>
    /* ====== 配色（ライト優先・高コントラスト） ====== */
    :root{
      --bg:#ffffff; --panel:#ffffff; --text:#111111; --muted:#4a4a4a; --bd:#dcdfe4;
      --accent:#0b66ff; --accent-2:#094fd1; --ok:#11895a; --warn:#b25a00;
      --chip-bg:#ffffff;          /* チップ背景（Light） */
      --chip-fg:#111111;          /* チップ文字色（Light） */
      --link:#0b57d0;             /* 強コントラストリンク（Light） */
      --tap:48px;                 /* 最小タッチサイズ */
      --radius:14px;              /* 角丸 */
      --shadow:0 1px 2px rgba(0,0,0,.08);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#111418; --panel:#161a20; --text:#f5f7fa; --muted:#b5bcc6; --bd:#283041;
        --accent:#5c96ff; --accent-2:#3c78f2; --ok:#1db47a; --warn:#ffb020;
        --chip-bg:#0e1117;         /* チップ背景（Dark） */
        --chip-fg:#e9eef6;         /* チップ文字色（Dark） */
        --link:#8ab4ff;            /* 強コントラストリンク（Dark） */
        --shadow:0 1px 2px rgba(0,0,0,.35);
      }
    }

    /* ====== ベース ====== */
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{ height:100% }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .wrap{ max-width:720px; margin:0 auto; padding:14px 12px 32px; }

    header{
      position:sticky; top:0; z-index:10; background:var(--bg);
      padding:10px 0 8px; border-bottom:1px solid var(--bd);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    header h1{ margin:0; font-size:20px; font-weight:800; letter-spacing:.2px }

    /* 言語切り替え */
    .lang{
      display:flex; align-items:center; gap:8px;
      font-size:14px; color:var(--muted);
    }
    .lang select{
      min-height:var(--tap); padding:8px 10px; border-radius:10px;
      border:1px solid var(--bd);
      background:#fff; color:#000;
    }
    @media (prefers-color-scheme: dark){
      .lang select{ background:#12161c; color:#f5f7fa; }
    }

    /* ====== UIカード ====== */
    .panel{
      background:var(--panel); border:1px solid var(--bd);
      border-radius:var(--radius); padding:12px; box-shadow:var(--shadow); margin:12px 0;
    }

    /* 入力行（モバイル1カラム） */
    .grid{ display:grid; gap:10px; grid-template-columns:1fr; }
    @media (min-width:540px){ .grid.cols-2{ grid-template-columns:1.5fr 1fr; } }

    label{ display:block; margin:0 0 6px; font-size:14px; font-weight:700; color:var(--text); }
    input,select,button{
      width:100%; min-height:var(--tap); font-size:16px; line-height:1.2;
      padding:12px 14px; border-radius:12px; outline:none; border:1px solid var(--bd);
      background:#fff; color:#000;
    }
    @media (prefers-color-scheme: dark){
      input,select,button{ background:#12161c; color:#f5f7fa; }
    }
    input::placeholder{ color:color-mix(in oklab, var(--muted) 70%, transparent) }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{
      background:linear-gradient(180deg, var(--accent), var(--accent-2));
      color:#fff; border:none; cursor:pointer; font-weight:800;
      box-shadow:0 4px 12px color-mix(in oklab, var(--accent-2) 28%, transparent);
      transition:transform .06s ease, filter .15s ease;
      touch-action:manipulation;
    }
    .btn:active{ transform:translateY(1px) scale(.998) }
    .status{ color:var(--muted); min-height:1.2em; font-size:14px }

    /* ====== チャンネル情報 ====== */
    .statbar{ display:grid; gap:10px; grid-template-columns:1fr; }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; }

    /* チップ（取得件数を含め全て同一トーン） */
    .chip,
    .chip.count{
      background:var(--chip-bg);
      color:var(--chip-fg);
      border:1px solid var(--bd);
      border-radius:999px;
      padding:.55em .95em;
      font-weight:700;
      line-height:1.4;
      min-height:48px;
      display:inline-flex; align-items:center;
    }

    /* ====== リスト/リンクの視認性 ====== */
    ol.video-list{ list-style:none; margin:8px 0 0; padding:0; }
    .v{
      border:1px solid var(--bd); border-radius:12px; padding:12px; margin:10px 0;
      background:var(--panel); box-shadow:var(--shadow);
    }

    /* 強コントラストのリンク（カード内＆タイトル） */
    .v a,
    .ch-title a{
      color:var(--link);
      text-decoration:underline;
      text-decoration-thickness:2px;
      text-underline-offset:3px;
      font-weight:800;
      word-break:break-word;
    }
    .v a:focus-visible,
    .ch-title a:focus-visible{
      outline:2px solid var(--link);
      outline-offset:2px;
      border-radius:6px;
    }

    /* メタ表示（再生/高評価/コメント/日付）— 行チップで見やすく */
    .meta{
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:8px 10px;
    }
    .mi{
      background:var(--chip-bg);
      color:var(--chip-fg);
      border:1px solid var(--bd);
      border-radius:999px;
      padding:.4em .75em;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      line-height:1.3;
    }
    .mi b{ font-weight:800; margin-right:.45em; }

    /* アクセシビリティ（スクリーンリーダー専用） */
    .sr{
      position:absolute; width:1px; height:1px; padding:0; margin:-1px;
      overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
    }

    /* === 「取得」ボタンの縦書き防止（横書き固定 & 1行固定） === */
    #run, .btn, button{
      writing-mode:horizontal-tb !important;
      text-orientation:mixed !important;
      white-space:nowrap;
      display:inline-flex; align-items:center; justify-content:center;
      letter-spacing:.02em;
    }
    #run *{
      writing-mode:horizontal-tb !important;
      text-orientation:mixed !important;
      white-space:nowrap;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1 id="appTitle">YouTubeじょうほう一括取得</h1>
      <div class="lang">
        <label for="langSel" id="langLabel">言語</label>
        <select id="langSel" aria-label="Language">
          <option value="ja">JA</option>
          <option value="en">EN</option>
        </select>
      </div>
    </header>

    <!-- 入力 -->
    <section class="panel" aria-labelledby="input-label">
      <div class="grid cols-2">
        <div>
          <label id="input-label" for="inputUrl">URLを貼ってね</label>
          <input id="inputUrl" inputmode="url" enterkeyhint="go"
                 autocapitalize="off" autocomplete="off" spellcheck="false"
                 placeholder="例）https://www.youtube.com/@Google など" />
        </div>
        <div>
          <label for="postSort" id="sortLabel">並び替え</label>
          <select id="postSort" aria-label="並び替え">
            <option value="none"    selected>取得順のまま</option>
            <option value="viewsDesc">視聴回数 多い順</option>
            <option value="viewsAsc">視聴回数 少ない順</option>
            <option value="likesDesc">高評価 多い順</option>
            <option value="likesAsc">高評価 少ない順</option>
            <option value="commentsDesc">コメント 多い順</option>
            <option value="commentsAsc">コメント 少ない順</option>
            <option value="newest">公開日 新しい順</option>
            <option value="oldest">公開日 古い順</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="run" class="btn" type="button" style="flex:1" aria-busy="false">取得</button>
        <div id="status" class="status" style="flex:2 1 200px" aria-live="polite"></div>
      </div>
    </section>

    <!-- チャンネル統計 -->
    <section id="chPanel" class="panel" style="display:none">
      <div class="statbar">
        <div class="ch-title" id="chTitle" style="font-weight:900; font-size:18px;">-</div>
        <div class="chips">
          <span class="chip" id="chipSubs">登録者数：-</span>
          <span class="chip" id="chipViews">総再生回数：-</span>
          <span class="chip" id="chipCount">動画数：-</span>
          <span class="chip count" id="chipGot">取得件数：0</span>
        </div>
      </div>
    </section>

    <!-- 出力 -->
    <section class="panel">
      <ol id="list" class="video-list"></ol>
    </section>

    <!-- 取り扱い説明（簡潔） -->
    <section class="panel" aria-labelledby="help-title">
      <h2 id="help-title" class="sr">使い方</h2>
      <ul style="margin:0; padding-left:18px; color:var(--muted); font-size:14px">
        <li id="helpNote">※お試し版のため、最大<strong>300本</strong>まで取得します</li>
      </ul>
    </section>
  </div>

  <!-- PWA登録（nonce一致・相対パスでGitHub Pages対応） -->
  <script nonce="yttool123">
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js', { scope: './' }).catch(()=>{});
    });
  }
  </script>

  <!-- アプリ本体（nonce一致） -->
  <script nonce="yttool123">
  /* ========= 設定 ========= */
  const API_BASE = 'https://script.google.com/macros/s/AKfycbxOwLPNL5zlcyzChiywKmFNzrtKDgC1JrcUJAs3FB8cG5UlOUoyDi4VvDY-cVuMq9czdg/exec';

  /* ========= I18N ========= */
  const I18N = {
    ja: {
      appTitle:'YouTubeじょうほう一括取得',
      langLabel:'言語',
      urlLabel:'URLを貼ってね',
      urlPh:'例）https://www.youtube.com/@Google など',
      sortLabel:'並び替え',
      sortOpts:{
        none:'取得順のまま',
        viewsDesc:'視聴回数 多い順',
        viewsAsc:'視聴回数 少ない順',
        likesDesc:'高評価 多い順',
        likesAsc:'高評価 少ない順',
        commentsDesc:'コメント 多い順',
        commentsAsc:'コメント 少ない順',
        newest:'公開日 新しい順',
        oldest:'公開日 古い順'
      },
      fetch:'取得',
      helpNote:'※お試し版のため、最大<strong>300本</strong>まで取得します',
      stat:{
        subs:'登録者数：{n}人',
        views:'総再生回数：{n}回',
        videos:'動画数：{n}本',
        got:'取得件数：{n}'
      },
      meta:{ views:'再生', likes:'高評価', comments:'コメント', date:'日付', viewsUnit:' 回' },
      status:{ analyzing:'解析中…', fetching:'取得中…', sorting:'並び替え（再取得なし）', ok:'{n} 件 取得しました',
               healthErr:'エラー: GAS に接続できません（デプロイと YT_API_KEY を確認）',
               apiBaseErr:'エラー: API_BASE が未設定か不正です',
               inputReq:'URL を入力してください',
               idResolveErr:'チャンネルIDを解決できませんでした' },
      locale:'ja-JP'
    },
    en: {
      appTitle:'YouTube Bulk Info Fetcher',
      langLabel:'Language',
      urlLabel:'Paste a YouTube URL',
      urlPh:'e.g. https://www.youtube.com/@Google',
      sortLabel:'Sort',
      sortOpts:{
        none:'As fetched',
        viewsDesc:'Views: high → low',
        viewsAsc:'Views: low → high',
        likesDesc:'Likes: high → low',
        likesAsc:'Likes: low → high',
        commentsDesc:'Comments: high → low',
        commentsAsc:'Comments: low → high',
        newest:'Publish date: newest',
        oldest:'Publish date: oldest'
      },
      fetch:'Fetch',
      helpNote:'Trial mode: up to <strong>300 items</strong> per fetch.',
      stat:{
        subs:'Subscribers: {n}',
        views:'Channel views: {n}',
        videos:'Videos: {n}',
        got:'Fetched: {n}'
      },
      meta:{ views:'Views', likes:'Likes', comments:'Comments', date:'Date', viewsUnit:'' },
      status:{ analyzing:'Analyzing…', fetching:'Fetching…', sorting:'Sorted (no re-fetch)', ok:'Fetched {n} items',
               healthErr:'Error: cannot reach GAS (check deployment and YT_API_KEY)',
               apiBaseErr:'Error: API_BASE missing or invalid',
               inputReq:'Please enter a URL',
               idResolveErr:'Could not resolve channel ID' },
      locale:'en-US'
    }
  };
  let LANG = localStorage.getItem('lang') || (navigator.language?.startsWith('en') ? 'en' : 'ja');

  function t(path, vars){
    const seg = path.split('.');
    let cur = I18N[LANG];
    for(const k of seg){ cur = cur?.[k]; }
    let s = String(cur ?? '');
    if(vars) for(const [k,v] of Object.entries(vars)) s = s.replaceAll(`{${k}}`, v);
    return s;
  }

  function applyI18nStatic(){
    document.documentElement.lang = LANG;
    document.getElementById('appTitle').textContent = t('appTitle');
    document.getElementById('langLabel').textContent = t('langLabel');
    document.getElementById('input-label').textContent = t('urlLabel');
    document.getElementById('inputUrl').placeholder = t('urlPh');
    document.getElementById('sortLabel').textContent = t('sortLabel');

    const opts = document.getElementById('postSort').options;
    const map = ['none','viewsDesc','viewsAsc','likesDesc','likesAsc','commentsDesc','commentsAsc','newest','oldest'];
    map.forEach((k,i)=>{ if(opts[i]) opts[i].textContent = t('sortOpts.'+k); });

    const runBtn = document.getElementById('run');
    runBtn.textContent = t('fetch');

    document.getElementById('helpNote').innerHTML = t('helpNote');
  }

  function applyI18nStats(ch, got=0){
    const fmt = n => (n==null||isNaN(n))?'-':Number(n).toLocaleString(LANG==='ja'?'ja-JP':'en-US');
    if(!ch){
      document.getElementById('chipGot').textContent = t('stat.got',{n:0});
      return;
    }
    document.getElementById('chipSubs').textContent  = t('stat.subs',{n:fmt(ch.subscriberCount)});
    document.getElementById('chipViews').textContent = t('stat.views',{n:fmt(ch.viewCount)});
    document.getElementById('chipCount').textContent = t('stat.videos',{n:fmt(ch.videoCount)});
    document.getElementById('chipGot').textContent   = t('stat.got',{n:fmt(got)});
  }

  /* ========= DOM ========= */
  const inputUrl = document.getElementById('inputUrl');
  const postSort = document.getElementById('postSort');
  const runBtn   = document.getElementById('run');
  const statusEl = document.getElementById('status');
  const langSel  = document.getElementById('langSel');

  const chPanel  = document.getElementById('chPanel');
  const chTitle  = document.getElementById('chTitle');
  const chipSubs = document.getElementById('chipSubs');
  const chipViews= document.getElementById('chipViews');
  const chipCount= document.getElementById('chipCount');
  const chipGot  = document.getElementById('chipGot');
  const listEl   = document.getElementById('list');

  /* ========= 状態 ========= */
  let baseRows = [];      // 取得した生データ
  let lastChannel = null;
  const MAX_FETCH = 300;  // お試し上限（フロント側）

  /* ========= ユーティリティ ========= */
  function isValidExecURL(s){
    try{ const u=new URL(String(s||'').trim()); return /^https?:$/.test(u.protocol) && /\/exec$/.test(u.pathname); }
    catch{ return false; }
  }
  function jsonp(endpoint, params={}){
    const base=(API_BASE||'').trim();
    if(!isValidExecURL(base)) throw new Error(t('status.apiBaseErr'));
    const cbName='__jp'+Math.random().toString(36).slice(2);
    return new Promise((resolve,reject)=>{
      let u; try{ u=new URL(base); }catch{ reject(new Error(t('status.apiBaseErr'))); return; }
      u.searchParams.set('op', endpoint);
      for(const [k,v] of Object.entries(params)) if(v!=null && v!=='') u.searchParams.set(k,String(v));
      u.searchParams.set('callback', cbName);

      const scr=document.createElement('script'); const timer=setTimeout(()=>{cleanup();reject(new Error('JSONP timeout'));},30000);
      function cleanup(){ clearTimeout(timer); try{ delete window[cbName]; }catch{} scr.remove(); }
      window[cbName]=(data)=>{ cleanup(); data&&data.error ? reject(new Error(data.error)) : resolve(data); };
      scr.onerror=()=>{ cleanup(); reject(new Error('JSONP network error')); };
      scr.async=true; scr.referrerPolicy='no-referrer'; scr.src=u.toString();
      document.body.appendChild(scr);
    });
  }
  function busy(b,msg){ runBtn.disabled=b; runBtn.setAttribute('aria-busy', b?'true':'false'); statusEl.textContent=b?(msg||''):''; }
  function toast(msg){ statusEl.textContent=msg; setTimeout(()=> statusEl.textContent='',1600); }
  function fmtNum(n){ return (n==null||isNaN(n))?'-':Number(n).toLocaleString(LANG==='ja'?'ja-JP':'en-US'); }
  function esc(s){ return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  /* ========= 起動時ヘルスチェック ========= */
  (async function bootCheck(){
    // 初期言語適用
    langSel.value = LANG;
    applyI18nStatic();

    if (!isValidExecURL(API_BASE)) { statusEl.textContent=t('status.apiBaseErr'); runBtn.disabled=true; return; }
    try{ await jsonp('health'); runBtn.disabled=false; statusEl.textContent=''; }
    catch(e){ runBtn.disabled=true; statusEl.textContent=t('status.healthErr'); console.error(e); }
  })();

  /* ========= 言語切り替え ========= */
  langSel.addEventListener('change', ()=>{
    LANG = langSel.value === 'en' ? 'en' : 'ja';
    localStorage.setItem('lang', LANG);
    applyI18nStatic();
    // 既に取得済みデータがあれば、表記（チップ/日付/トースト）更新
    renderRows(sortAfter([...baseRows], postSort.value));
    if (lastChannel) applyI18nStats(lastChannel, baseRows.length);
  });

  /* ========= UI ハンドラ ========= */
  runBtn.onclick = async () => {
    const raw = inputUrl.value.trim();
    if (!raw) return alert(t('status.inputReq'));
    try{
      busy(true, t('status.analyzing')); setChannel(null); renderRows([]);
      const {rows, channel} = await runViaProxy(raw);
      baseRows   = rows;
      lastChannel= channel;
      const sorted = sortAfter([...baseRows], postSort.value);
      setChannel(channel, sorted.length);
      renderRows(sorted);
      toast(t('status.ok',{n:sorted.length}));
    }catch(err){
      console.error(err); setChannel(null); renderRows([]);
      const msg = err?.message?.includes('チャンネルID') || err?.message?.toLowerCase?.().includes('channel') ? t('status.idResolveErr') : (err?.message||String(err));
      alert(msg);
    }finally{ busy(false); }
  };
  postSort.addEventListener('change', () => {
    if (!baseRows.length) return;
    const rows = sortAfter([...baseRows], postSort.value);
    renderRows(rows);
    if (lastChannel) setChannel(lastChannel, rows.length);
    toast(t('status.sorting'));
  });
  inputUrl.addEventListener('keydown', (e)=>{ if (e.key==='Enter') runBtn.click(); });

  /* ========= コア処理 ========= */
  async function runViaProxy(raw){
    const type = detectInputType(raw);

    // プレイリスト
    if (type.kind === 'playlist'){
      try{
        const r = await jsonp('playlistDetailsAll', { playlistId: type.playlistId, max: MAX_FETCH });
        return { rows: r.items.map(toRowFromAPI), channel: null };
      }catch(_){
        const ids = await listPlaylistVideoIds_legacy(type.playlistId, MAX_FETCH);
        const details = await fetchVideosDetails_legacy(ids);
        const rows = ids.map((id,i)=> toRowFromDetail(details.get(id), id, i));
        return { rows, channel: null };
      }
    }

    // チャンネル or 動画 → チャンネルID
    let channelId = null;
    if (type.kind==='channel') channelId=type.channelId;
    if (type.kind==='video')   channelId=await getChannelIdFromVideo(type.videoId);
    if (type.kind==='channelQuery') channelId=await searchChannelId(type.q);
    if (!channelId) throw new Error(t('status.idResolveErr'));

    try{
      const r = await jsonp('channelUploadsDetailsAll', { id: channelId, max: MAX_FETCH });
      return {
        rows: r.items.map(toRowFromAPI),
        channel: r.channel ? {
          id:r.channel.id, title:r.channel.title, url:r.channel.url,
          subscriberCount:r.channel.subscriberCount, viewCount:r.channel.viewCount, videoCount:r.channel.videoCount
        } : null
      };
    }catch(_){
      const uploadsInfo = await getUploadsPlaylistId(channelId);
      if (!uploadsInfo?.uploads) throw new Error('Uploads playlist not found');
      const [ids, ch] = await Promise.all([
        listPlaylistVideoIds_legacy(uploadsInfo.uploads, MAX_FETCH),
        fetchChannelInfo(channelId)
      ]);
      const details = await fetchVideosDetails_legacy(ids);
      const rows = ids.map((id,i)=> toRowFromDetail(details.get(id), id, i));
      return { rows, channel: ch };
    }
  }

  /* ========= 入力タイプ検出 ========= */
  function detectInputType(raw){
    const s=String(raw||'').trim(); if(!s) return {kind:'unknown'};
    if(/^UC[0-9A-Za-z_-]{22}$/.test(s)) return {kind:'channel',channelId:s};
    if(s.startsWith('@')) return {kind:'channelQuery',q:s.slice(1)};
    if(/^https?:\/\//i.test(s)){
      try{
        const u=new URL(s); const host=u.hostname.replace(/^www\./,'');
        const parts=u.pathname.replace(/\/+$/,'').split('/').filter(Boolean);
        const vid=u.searchParams.get('v')||(['shorts','embed','live'].includes(parts[0])?parts[1]:null);
        const list=u.searchParams.get('list');
        if(host==='youtu.be'&&parts[0]) return {kind:'video',videoId:parts[0].slice(0,11)};
        if(vid) return {kind:'video',videoId:vid.slice(0,11)};
        if(list) return {kind:'playlist',playlistId:list};
        const mCh=u.pathname.match(/\/channel\/(UC[0-9A-Za-z_-]{22})$/);
        if(mCh) return {kind:'channel',channelId:mCh[1]};
        const mHandle=u.pathname.match(/\/@([^/]+)$/);
        if(mHandle) return {kind:'channelQuery',q:mHandle[1]};
        const mCustom=u.pathname.match(/\/(c|user)\/([^/]+)$/);
        if(mCustom) return {kind:'channelQuery',q:mCustom[2]};
      }catch{}
    }
    if(/^[0-9A-Za-z_-]{11}$/.test(s)) return {kind:'video',videoId:s};
    return {kind:'channelQuery',q:s};
  }

  /* ========= 行変換（高速API） ========= */
  function toRowFromAPI(it, i){
    return {
      url: `https://www.youtube.com/watch?v=${it.id}`,
      title: it.title || '',
      viewCount: it.viewCount ?? null,
      likeCount: it.likeCount ?? null,
      commentCount: it.commentCount ?? null,
      publishedAt: it.publishedAt || '',
      videoId: it.id,
      __idx: i ?? 0
    };
  }

  /* ========= フォールバック ========= */
  async function fetchChannelInfo(channelId){ const r=await jsonp('channelInfo',{id:channelId}); const d=r?.data; if(!d) return null; return {id:d.id,title:d.title,url:d.url,subscriberCount:d.subscriberCount,viewCount:d.viewCount,videoCount:d.videoCount}; }
  async function getChannelIdFromVideo(vid){ const r=await jsonp('channelFromVideo',{id:vid}); return r?.channelId||null; }
  async function getUploadsPlaylistId(ch){ const r=await jsonp('uploads',{id:ch}); return r?.data||null; }
  async function searchChannelId(q){ const r=await jsonp('searchChannel',{q}); return r?.channelId||null; }
  async function listPlaylistVideoIds_legacy(pid,maxCount){
    let ids=[], pageToken='';
    while(ids.length<Math.min(maxCount,MAX_FETCH)){
      const r=await jsonp('playlistItems',{playlistId:pid,pageToken});
      const chunk=(r?.items||[]).map(it=>it?.contentDetails?.videoId).filter(Boolean);
      ids.push(...chunk); pageToken=r?.nextPageToken||''; if(!pageToken) break; busy(true,t('status.fetching')+` ${ids.length}`);
    }
    return ids.slice(0,Math.min(maxCount,MAX_FETCH));
  }
  async function fetchVideosDetails_legacy(videoIds, concurrency=6){
    const map=new Map(); const chunks=[]; for(let i=0;i<videoIds.length;i+=50) chunks.push(videoIds.slice(i,i+50));
    let cursor=0;
    async function worker(){
      while(true){
        const my=cursor++; if(my>=chunks.length) break;
        const ids=chunks[my].join(',');
        busy(true,t('status.fetching')+` ${Math.min((my+1)*50,videoIds.length)}/${videoIds.length}`);
        const r=await jsonp('videos',{ids});
        for(const it of (r?.items||[])){
          const st=it.statistics||{}, sn=it.snippet||{};
          map.set(it.id,{title:sn.title??'',viewCount:st.viewCount!=null?Number(st.viewCount):null,likeCount:st.likeCount!=null?Number(st.likeCount):null,commentCount:st.commentCount!=null?Number(st.commentCount):null,publishedAt:sn.publishedAt??''});
        }
      }
    }
    await Promise.all(Array.from({length:Math.min(concurrency,chunks.length)},worker));
    return map;
  }
  function toRowFromDetail(d,id,i){
    return { url:`https://www.youtube.com/watch?v=${id}`, title:d?.title??'', viewCount:d?.viewCount??null, likeCount:d?.likeCount??null, commentCount:d?.commentCount??null, publishedAt:d?.publishedAt??'', videoId:id, __idx:i };
  }

  /* ========= 並び替え & 描画 ========= */
  function sortAfter(rows,key){
    const byNum=(field,asc=true)=>(a,b)=>{
      const av=Number(a[field]), bv=Number(b[field]);
      const aNaN=isNaN(av), bNaN=isNaN(bv);
      if(aNaN&&bNaN) return a.__idx-b.__idx;
      if(aNaN) return 1;
      if(bNaN) return -1;
      return asc?(av-bv):(bv-av);
    };
    const byDate=(get,desc=true)=>(a,b)=>{
      const at=Date.parse(get(a)||''), bt=Date.parse(get(b)||'');
      const aNaN=isNaN(at), bNaN=isNaN(bt);
      if(aNaN&&bNaN) return a.__idx-b.__idx;
      if(aNaN) return 1;
      if(bNaN) return -1;
      return desc ? (bt-at) : (at-bt);
    };
    switch(key){
      case 'viewsDesc': return rows.sort(byNum('viewCount',false));
      case 'viewsAsc' : return rows.sort(byNum('viewCount',true ));
      case 'likesDesc': return rows.sort(byNum('likeCount',false));
      case 'likesAsc' : return rows.sort(byNum('likeCount',true ));
      case 'commentsDesc': return rows.sort(byNum('commentCount',false));
      case 'commentsAsc' : return rows.sort(byNum('commentCount',true ));
      case 'newest'  : return rows.sort(byDate(r=>r.publishedAt,true));
      case 'oldest'  : return rows.sort(byDate(r=>r.publishedAt,false));
      default        : return rows.sort((a,b)=> a.__idx-b.__idx);
    }
  }

  function makeMetaItem(label, value){
    const s = document.createElement('span');
    s.className = 'mi';
    const b = document.createElement('b');
    b.textContent = label;
    s.appendChild(b);
    s.appendChild(document.createTextNode(value));
    return s;
  }

  function renderRows(rows){
    listEl.innerHTML=''; chipGot.textContent=t('stat.got',{n:rows.length.toLocaleString(LANG==='ja'?'ja-JP':'en-US')});
    const frag=document.createDocumentFragment();
    rows.forEach((r)=>{
      const li=document.createElement('li'); li.className='v';

      const a=document.createElement('a');
      a.href=r.url; a.target='_blank'; a.rel='noopener noreferrer';
      a.textContent=r.title||'(no title)';
      li.appendChild(a);

      const meta=document.createElement('div'); meta.className='meta';
      meta.appendChild(makeMetaItem(t('meta.views'), r.viewCount!=null ? `${fmtNum(r.viewCount)}${t('meta.viewsUnit')}` : '-'));
      if (r.likeCount!=null)    meta.appendChild(makeMetaItem(t('meta.likes'), `${fmtNum(r.likeCount)}`));
      if (r.commentCount!=null) meta.appendChild(makeMetaItem(t('meta.comments'), `${fmtNum(r.commentCount)}`));
      meta.appendChild(makeMetaItem(t('meta.date'), r.publishedAt? new Date(r.publishedAt).toLocaleDateString(I18N[LANG].locale) : '-'));

      li.appendChild(meta);
      frag.appendChild(li);
    });
    listEl.appendChild(frag);
  }

  function setChannel(ch,got=0){
    if(!ch){ chPanel.style.display='none'; chipGot.textContent=t('stat.got',{n:0}); return; }
    chPanel.style.display='';
    chTitle.innerHTML=`<a href="${ch.url}" target="_blank" rel="noopener noreferrer">${esc(ch.title||'')}</a>`;
    applyI18nStats(ch, got);
  }
  </script>
</body>
</html>
