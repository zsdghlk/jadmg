/**
 * YouTube Data API を安全にプロキシする Apps Script（JSON/JSONP両対応）
 * - APIキーは Script Properties の YT_API_KEY に保存（フロントへは出さない）
 * - 高速API：playlistDetailsAll / channelUploadsDetailsAll（fetchAll で並列化）
 * - 互換API：health, channelInfo, channelFromVideo, uploads, playlistItems, videos, searchChannel
 */

(function(){})();// 無害な IIFE（エディタの自動挿入対策）

/* ========== APIキー ========== */
function setApiKey_(key){
  if(!key || !/^AIza[0-9A-Za-z_\-]{30,}$/.test(key)) throw new Error('不正な APIキー形式です。');
  PropertiesService.getScriptProperties().setProperty('YT_API_KEY', key);
  return 'OK';
}
function getApiKey_(){
  var k=PropertiesService.getScriptProperties().getProperty('YT_API_KEY');
  if(!k) throw new Error('YT_API_KEY が未設定です。スクリプト プロパティに追加してください。');
  return k;
}

/* ========== 共通ユーティリティ ========== */
function outJSON_(obj, cb){
  var json=JSON.stringify(obj, null, 2);
  var out=cb ? (cb+'('+json+')') : json;
  return ContentService.createTextOutput(out)
    .setMimeType(cb ? ContentService.MimeType.JAVASCRIPT : ContentService.MimeType.JSON);
}
function outErr_(msg, cb){ return outJSON_({ error:String(msg) }, cb); }
function isVideoId_(s){ return /^[0-9A-Za-z_-]{11}$/.test(s||''); }
function isChannelId_(s){ return /^UC[0-9A-Za-z_-]{22}$/.test(s||''); }
function isPlaylistId_(s){ return /^(PL|UU|LL|OL)[0-9A-Za-z_-]+$/.test(s||''); }

var YT_BASE='https://www.googleapis.com/youtube/v3';
function httpGetJSON_(url, params){
  var q=Object.keys(params||{}).map(function(k){ return encodeURIComponent(k)+'='+encodeURIComponent(params[k]); }).join('&');
  var full=q?(url+'?'+q):url;
  var res=UrlFetchApp.fetch(full,{method:'get',muteHttpExceptions:true,headers:{'Accept':'application/json'}});
  var code=res.getResponseCode(), body=res.getContentText('utf-8');
  if(code>=200 && code<300) return JSON.parse(body);
  throw new Error('YouTube API エラー: '+code+' / '+body.slice(0,200));
}

/* ========== ルーター ========== */
function doGet(e){
  try{
    var p=(e&&e.parameter)||{}, op=String(p.op||'').trim(), cb=p.callback||'';
    if(!op){
      return outJSON_({ ok:true, service:'yt-proxy',
        fast:['playlistDetailsAll','channelUploadsDetailsAll'],
        compat:['health','channelInfo','channelFromVideo','uploads','playlistItems','videos','searchChannel']
      }, cb);
    }
    if(op==='health') return outJSON_({ ok:true, time:(new Date()).toISOString() }, cb);

    switch(op){
      // 高速API
      case 'playlistDetailsAll'      : return op_playlistDetailsAll_(p, cb);
      case 'channelUploadsDetailsAll': return op_channelUploadsDetailsAll_(p, cb);

      // 互換API（フロントのフォールバック用）
      case 'channelInfo'     : return yt_channelInfo_(p, cb);
      case 'channelFromVideo': return yt_channelFromVideo_(p, cb);
      case 'uploads'         : return yt_uploads_(p, cb);
      case 'playlistItems'   : return yt_playlistItems_(p, cb);
      case 'videos'          : return yt_videos_(p, cb);
      case 'searchChannel'   : return yt_searchChannel_(p, cb);

      default: return outErr_('unknown op', cb);
    }
  }catch(err){
    var cb2=(e && e.parameter && e.parameter.callback)||'';
    return outErr_(err && err.message ? err.message : err, cb2);
  }
}

/* ========== 高速API 実装 ========== */
// プレイリストの全 videoId を集め、videos.list を並列で叩いて整形して返す
function op_playlistDetailsAll_(p, cb){
  var pid=String(p.playlistId||'').trim();
  if(!isPlaylistId_(pid)) return outErr_('invalid playlist id', cb);
  var max=p.max ? Math.min(5000, Math.max(1, Number(p.max))) : 5000;

  var ids=_listAllVideoIdsFromPlaylist_(pid, max); // 逐次ページング（サーバー内なので往復ゼロ）
  var items=_fetchVideosDetailsBatch_(ids);        // fetchAll で並列

  return outJSON_({ items: items }, cb);
}

// チャンネルID → uploads を解決し、上と同じ
function op_channelUploadsDetailsAll_(p, cb){
  var id=String(p.id||'').trim();
  if(!isChannelId_(id)) return outErr_('invalid channel id', cb);
  var max=p.max ? Math.min(5000, Math.max(1, Number(p.max))) : 5000;

  var key=getApiKey_();
  var j=httpGetJSON_(YT_BASE+'/channels', {
    part:'snippet,statistics,contentDetails',
    id:id, key:key,
    fields:'items(id,snippet/title,statistics/subscriberCount,statistics/viewCount,statistics/videoCount,contentDetails/relatedPlaylists/uploads)'
  });
  var it=j.items && j.items[0]; if(!it) return outErr_('channel not found', cb);
  var uploads=it.contentDetails && it.contentDetails.relatedPlaylists && it.contentDetails.relatedPlaylists.uploads || null;
  if(!uploads) return outErr_('uploads playlist not found', cb);

  var ids=_listAllVideoIdsFromPlaylist_(uploads, max);
  var items=_fetchVideosDetailsBatch_(ids);
  var ch={
    id: it.id,
    title: (it.snippet && it.snippet.title) || '',
    url: 'https://www.youtube.com/channel/'+it.id,
    subscriberCount: it.statistics && it.statistics.subscriberCount != null ? Number(it.statistics.subscriberCount) : null,
    viewCount:      it.statistics && it.statistics.viewCount      != null ? Number(it.statistics.viewCount)      : null,
    videoCount:     it.statistics && it.statistics.videoCount     != null ? Number(it.statistics.videoCount)     : null
  };

  return outJSON_({ channel: ch, items: items }, cb);
}

/* 内部：プレイリストの全 videoId を順次取得（fields で極小化） */
function _listAllVideoIdsFromPlaylist_(playlistId, max){
  var key=getApiKey_(), ids=[], pageToken='', remain=max;
  do{
    var j=httpGetJSON_(YT_BASE+'/playlistItems', {
      part:'contentDetails', playlistId:playlistId, key:key, maxResults: Math.min(50, remain), pageToken: pageToken,
      fields:'nextPageToken,items(contentDetails/videoId)'
    });
    var chunk=(j.items||[]).map(function(it){ return it && it.contentDetails && it.contentDetails.videoId; }).filter(Boolean);
    ids=ids.concat(chunk);
    remain = max - ids.length;
    pageToken=j.nextPageToken || '';
  }while(pageToken && ids.length < max);
  return ids;
}

/* 内部：videos.list を 50件ずつに分割し、UrlFetchApp.fetchAll で並列取得 → 必要最小の形に整形 */
function _fetchVideosDetailsBatch_(videoIds){
  if(!videoIds || !videoIds.length) return [];
  var key=getApiKey_();
  var reqs=[];
  for(var i=0;i<videoIds.length;i+=50){
    var sub=videoIds.slice(i,i+50).join(',');
    var url = YT_BASE+'/videos'+'?'+[
      'part=snippet,statistics',
      'id='+encodeURIComponent(sub),
      'key='+encodeURIComponent(key),
      'fields=items(id,snippet/title,snippet/publishedAt,statistics/viewCount,statistics/likeCount,statistics/commentCount)'
    ].join('&');
    reqs.push({ url:url, method:'get', muteHttpExceptions:true, headers:{'Accept':'application/json'} });
  }
  var resList=UrlFetchApp.fetchAll(reqs);
  var out=[];
  for(var r=0;r<resList.length;r++){
    var res=resList[r], code=res.getResponseCode(); if(code<200||code>=300) continue;
    var j=JSON.parse(res.getContentText('utf-8'));
    (j.items||[]).forEach(function(it){
      var sn=it.snippet||{}, st=it.statistics||{};
      out.push({
        id: it.id,
        title: sn.title || '',
        publishedAt: sn.publishedAt || '',
        viewCount: st.viewCount != null ? Number(st.viewCount) : null,
        likeCount: st.likeCount != null ? Number(st.likeCount) : null,
        commentCount: st.commentCount != null ? Number(st.commentCount) : null
      });
    });
  }
  return out;
}

/* ========== 互換API（フォールバック用） ========== */
function yt_channelInfo_(p, cb){
  var id=String(p.id||'').trim(); if(!isChannelId_(id)) return outErr_('invalid channel id', cb);
  var key=getApiKey_();
  var j=httpGetJSON_(YT_BASE+'/channels', {
    part:'snippet,statistics,contentDetails', id:id, key:key,
    fields:'items(id,snippet/title,statistics/subscriberCount,statistics/viewCount,statistics/videoCount,contentDetails/relatedPlaylists/uploads)'
  });
  var it=j.items && j.items[0]; if(!it) return outErr_('channel not found', cb);
  var sn=it.snippet||{}, st=it.statistics||{}, cd=it.contentDetails||{};
  return outJSON_({ data:{
    id:it.id, title:sn.title||'', url:'https://www.youtube.com/channel/'+it.id,
    subscriberCount: st.subscriberCount!=null?Number(st.subscriberCount):null,
    viewCount: st.viewCount!=null?Number(st.viewCount):null,
    videoCount: st.videoCount!=null?Number(st.videoCount):null,
    uploads: cd.relatedPlaylists && cd.relatedPlaylists.uploads || null
  }}, cb);
}
function yt_channelFromVideo_(p, cb){
  var id=String(p.id||'').trim(); if(!isVideoId_(id)) return outErr_('invalid video id', cb);
  var key=getApiKey_();
  var j=httpGetJSON_(YT_BASE+'/videos',{ part:'snippet', id:id, key:key, fields:'items(snippet/channelId)' });
  var ch=j.items && j.items[0] && j.items[0].snippet && j.items[0].snippet.channelId || null;
  return outJSON_({ channelId: ch }, cb);
}
function yt_uploads_(p, cb){
  var id=String(p.id||'').trim(); if(!isChannelId_(id)) return outErr_('invalid channel id', cb);
  var key=getApiKey_();
  var j=httpGetJSON_(YT_BASE+'/channels',{ part:'contentDetails', id:id, key:key, fields:'items(contentDetails/relatedPlaylists/uploads)' });
  var uploads=j.items && j.items[0] && j.items[0].contentDetails && j.items[0].contentDetails.relatedPlaylists && j.items[0].contentDetails.relatedPlaylists.uploads || null;
  return outJSON_({ data:{ uploads:uploads } }, cb);
}
function yt_playlistItems_(p, cb){
  var playlistId=String(p.playlistId||'').trim(); if(!isPlaylistId_(playlistId)) return outErr_('invalid playlist id', cb);
  var pageToken=(p.pageToken||'').trim(); var key=getApiKey_();
  var j=httpGetJSON_(YT_BASE+'/playlistItems',{ part:'contentDetails', playlistId:playlistId, key:key, maxResults:50, pageToken:pageToken, fields:'nextPageToken,items(contentDetails/videoId)' });
  var items=(j.items||[]).map(function(it){ return { contentDetails:{ videoId:(it && it.contentDetails && it.contentDetails.videoId) || '' } }; });
  return outJSON_({ items:items, nextPageToken:j.nextPageToken||'' }, cb);
}
function yt_videos_(p, cb){
  var ids=String(p.ids||'').split(',').map(function(s){return s.trim();}).filter(Boolean);
  if(!ids.length) return outErr_('ids required', cb);
  if(ids.length>50) return outErr_('too many ids (>50)', cb);
  if(!ids.every(isVideoId_)) return outErr_('invalid video id exists', cb);
  var key=getApiKey_();
  var j=httpGetJSON_(YT_BASE+'/videos',{ part:'snippet,statistics', id:ids.join(','), key:key, fields:'items(id,snippet/title,snippet/publishedAt,statistics/viewCount,statistics/likeCount,statistics/commentCount)' });
  var items=(j.items||[]).map(function(it){
    var sn=it.snippet||{}, st=it.statistics||{};
    return {
      id:it.id,
      snippet:{ title:sn.title||'', publishedAt:sn.publishedAt||'' },
      statistics:{ viewCount:st.viewCount||null, likeCount:st.likeCount||null, commentCount:st.commentCount||null }
    };
  });
  return outJSON_({ items:items }, cb);
}
function yt_searchChannel_(p, cb){
  var q=String(p.q||'').trim(); if(!q) return outErr_('q required', cb);
  var key=getApiKey_();
  var j=httpGetJSON_(YT_BASE+'/search',{ part:'snippet', type:'channel', q:q, maxResults:1, key:key, fields:'items(id/channelId)' });
  var id=j.items && j.items[0] && j.items[0].id && j.items[0].id.channelId || null;
  return outJSON_({ channelId:id }, cb);
}
