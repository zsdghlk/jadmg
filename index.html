<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>YouTube ä¸€æ‹¬å–å¾—ãƒ»æ•´å½¢ï¼ˆçµ±è¨ˆï¼‹ä¸¦ã³æ›¿ãˆãƒ•ãƒ«ï¼‰</title>
<style>
  :root{--muted:#6b7280;--bd:#e5e7eb}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;margin:24px;line-height:1.7}
  h1{font-size:1.2rem;margin:0 0 12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0}
  input,button,select,textarea{font-size:14px}
  input,button,select{padding:8px}
  input[type="number"]{width:120px}
  input[type="date"]{width:auto}
  textarea{width:100%;min-height:260px;padding:10px}
  .muted{color:var(--muted)}
  .pill{border:1px solid #d1d5db;border-radius:999px;padding:6px 10px}
  .section{border:1px solid var(--bd);border-radius:10px;padding:12px;margin:12px 0}
  .hide{display:none}
  .preview{border:1px dashed var(--bd);border-radius:10px;padding:12px;margin-top:8px}
</style>

<h1>YouTube ä¸€æ‹¬å–å¾—ãƒ»æ•´å½¢ï¼ˆçµ±è¨ˆï¼‹ä¸¦ã³æ›¿ãˆãƒ•ãƒ«ï¼‰</h1>

<script>
// å…¬é–‹ç’°å¢ƒã§ã¯ç©ºãŒå®‰å…¨ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç”¨é€”ã®ã¿å€¤ã‚’å…¥ã‚Œã¦OKï¼‰
const DEFAULT_API_KEY = 'AIzaSyAsoGsbekSs5kfzjfIdxmuOdo44hwDqq3g';
</script>

<!-- å‹•ä½œãƒ¢ãƒ¼ãƒ‰ -->
<div class="row">
  <span class="pill">
    <label><input type="radio" name="work" value="collect" checked> å–å¾—ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒãƒ£ãƒ³ãƒãƒ«/PLã‹ã‚‰å–å¾—ï¼‰</label>
  </span>
  <span class="pill">
    <label><input type="radio" name="work" value="format"> æ•´å½¢ãƒ¢ãƒ¼ãƒ‰ï¼ˆè²¼ã‚Šä»˜ã‘ãŸå‹•ç”»URLã‚’æ•´å½¢ï¼‰</label>
  </span>
</div>

<!-- API/GAS è¨­å®š -->
<div class="section">
  <div class="row">
    <span class="pill">
      <label><input type="radio" name="mode" value="client" checked> ç›´æ¥API</label>
    </span>
    <span class="pill">
      <label><input type="radio" name="mode" value="gas"> GASãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰</label>
    </span>
    <span class="muted">â€» æ•´å½¢ãƒ¢ãƒ¼ãƒ‰ã¯APIã‚­ãƒ¼ã‚’ä½¿ã„ã¾ã™ï¼ˆGASã¯ä¸è¦ï¼‰</span>
  </div>

  <div class="row" id="apiRow">
    <label>APIã‚­ãƒ¼ï¼š</label>
    <input id="apiKey" placeholder="YouTube Data API v3 ã® APIã‚­ãƒ¼" style="min-width:260px;flex:1">
    <button id="saveKey">ä¿å­˜</button>
    <span class="muted">ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã«ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰</span>
  </div>

  <div class="row hide" id="gasRow">
    <label>GAS APP_URLï¼ˆ/execï¼‰ï¼š</label>
    <input id="appUrl" placeholder="https://script.google.com/macros/s/xxxxxxxxxxxxxxxx/exec" style="min-width:360px;flex:1">
    <span class="muted">â€» /dev ã§ã¯ãªã /exec ã‚’æŒ‡å®š</span>
  </div>
</div>

<!-- å…¥åŠ›UIï¼ˆå–å¾—ãƒ¢ãƒ¼ãƒ‰ï¼‰ -->
<div class="section" id="collectBox">
  <div class="row">
    <label>ãƒãƒ£ãƒ³ãƒãƒ«/PL/URLï¼š</label>
    <input id="channel" placeholder="@handle / UCxxxxxxxx... / https://.../@handle / å‹•ç”»URL / ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆURL" style="min-width:320px;flex:1">
  </div>
  <div class="row">
    <label>æœ€å¤§ä»¶æ•°ï¼š</label>
    <input id="limit" type="number" value="200" min="1" max="5000">
    <label>å…¬é–‹æ—¥ sinceï¼š</label>
    <input id="since" type="date">
    <label>å–å¾—æ™‚ã®ä¸¦ã³ï¼š</label>
    <select id="sort">
      <option value="newest" selected>æ–°ã—ã„é †ï¼ˆå…¬é–‹æ—¥ï¼‰</option>
      <option value="oldest">å¤ã„é †ï¼ˆå…¬é–‹æ—¥ï¼‰</option>
      <option value="none">ãã®ã¾ã¾</option>
    </select>
  </div>
  <div class="row">
    <button id="runCollect">å–å¾— â†’ æ•´å½¢</button>
  </div>
</div>

<!-- å…¥åŠ›UIï¼ˆæ•´å½¢ãƒ¢ãƒ¼ãƒ‰ï¼‰ -->
<div class="section hide" id="formatBox">
  <div class="row"><label class="muted">å‹•ç”»URLã‚’æ”¹è¡Œ/ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã§è²¼ã‚Šä»˜ã‘</label></div>
  <textarea id="rawUrls" placeholder="ä¾‹ï¼‰https://www.youtube.com/watch?v=dQw4w9WgXcQ&#10;https://youtu.be/XXXXXXXXXXX&#10;..."></textarea>
  <div class="row">
    <label>å…¬é–‹æ—¥ sinceï¼š</label>
    <input id="since2" type="date">
    <label>å–å¾—æ™‚ã®ä¸¦ã³ï¼š</label>
    <select id="sort2">
      <option value="none" selected>å…¥åŠ›é †ã®ã¾ã¾</option>
      <option value="newest">æ–°ã—ã„é †ï¼ˆå…¬é–‹æ—¥ï¼‰</option>
      <option value="oldest">å¤ã„é †ï¼ˆå…¬é–‹æ—¥ï¼‰</option>
    </select>
  </div>
  <div class="row">
    <button id="runFormat">æ•´å½¢ã™ã‚‹</button>
  </div>
</div>

<!-- å‡ºåŠ›è¨­å®š -->
<div class="section">
  <div class="row">
    <label>å‡ºåŠ›ãƒ†ãƒ³ãƒ—ãƒ¬ï¼š</label>
    <select id="format">
      <option value="html-list" selected>HTMLï¼šé€£ç•ªãƒªã‚¹ãƒˆï¼ˆä¸Šã«ãƒãƒ£ãƒ³ãƒãƒ«çµ±è¨ˆï¼‰</option>
      <option value="html-cards">HTMLï¼šã‚«ãƒ¼ãƒ‰å‹ï¼ˆä¸Šã«ãƒãƒ£ãƒ³ãƒãƒ«çµ±è¨ˆï¼‰</option>
      <option value="md">Markdownï¼ˆè¦‹å‡ºã—ï¼‹é€£ç•ªãƒªã‚¹ãƒˆï¼‰</option>
      <option value="tsv">TSVï¼ˆè¡¨å½¢å¼ï¼‰</option>
      <option value="csv">CSVï¼ˆè¡¨å½¢å¼ï¼‰</option>
    </select>

    <!-- â˜… æ•´å½¢å¾Œä¸¦ã³æ›¿ãˆï¼ˆè¦–è´å›æ•°ç­‰ï¼‰ -->
    <label>æ•´å½¢å¾Œã®ä¸¦ã³æ›¿ãˆï¼š</label>
    <select id="postSort">
      <option value="none" selected>å…¥åŠ›é †ã®ã¾ã¾</option>
      <option value="viewsDesc">è¦–è´å›æ•° å¤šã„é †</option>
      <option value="viewsAsc">è¦–è´å›æ•° å°‘ãªã„é †</option>
      <option value="likesDesc">é«˜è©•ä¾¡ å¤šã„é †</option>
      <option value="likesAsc">é«˜è©•ä¾¡ å°‘ãªã„é †</option>
      <option value="commentsDesc">ã‚³ãƒ¡ãƒ³ãƒˆ å¤šã„é †</option>
      <option value="commentsAsc">ã‚³ãƒ¡ãƒ³ãƒˆ å°‘ãªã„é †</option>
      <option value="avgDesc">å¹³å‡/æ—¥ å¤šã„é †</option>
      <option value="avgAsc">å¹³å‡/æ—¥ å°‘ãªã„é †</option>
      <option value="growthDesc">æ¨å®šå¢—åˆ†(Næ—¥) å¤šã„é †</option>
      <option value="growthAsc">æ¨å®šå¢—åˆ†(Næ—¥) å°‘ãªã„é †</option>
    </select>

    <label>æ¨å®šNæ—¥ï¼š</label>
    <input id="windowDays" type="number" value="28" min="1" style="width:90px">

    <label>é–‹å§‹ç•ªå·ï¼š</label>
    <input id="startNum" type="number" value="1" min="1">

    <span class="muted">ä»¶æ•°ï¼š</span><span id="count" class="pill">0 ä»¶</span>
    <span id="status" class="muted"></span>
  </div>

  <p class="muted">å„è¡Œã¯ <strong>é€£ç•ª. ã‚¿ã‚¤ãƒˆãƒ«(ãƒªãƒ³ã‚¯) â€” è¦–è´å›æ•°(ãƒªãƒ³ã‚¯) â€” é«˜è©•ä¾¡ â€” ã‚³ãƒ¡ãƒ³ãƒˆ â€” å¹³å‡/æ—¥ â€” æ¨å®šå¢—åˆ†(Næ—¥) â€” å…¬é–‹æ—¥</strong> ã§å‡ºåŠ›ï¼ˆå½¢å¼ã«ã‚ˆã‚Šæœ€é©åŒ–ï¼‰ã€‚</p>
  <textarea id="out" placeholder="ã“ã“ã«çµæœãŒå‡ºã¾ã™"></textarea>

  <div class="row">
    <button id="copy">ã‚³ãƒ”ãƒ¼</button>
    <button id="dlCsv">CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
  </div>

  <!-- ç°¡æ˜“ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆHTMLã®ã¿ï¼‰ -->
  <details class="preview" id="previewWrap">
    <summary>HTMLãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰</summary>
    <div id="preview"></div>
  </details>
</div>

<script>
/* ================== è¦ç´ å‚ç…§ ================== */
const apiKeyInput = document.getElementById('apiKey');
const appUrlInput = document.getElementById('appUrl');
const apiRow      = document.getElementById('apiRow');
const gasRow      = document.getElementById('gasRow');

const collectBox  = document.getElementById('collectBox');
const formatBox   = document.getElementById('formatBox');

const channelInput= document.getElementById('channel');
const limitInput  = document.getElementById('limit');
const sinceInput  = document.getElementById('since');
const sortSelect  = document.getElementById('sort');
const runCollect  = document.getElementById('runCollect');

const rawUrlsTA   = document.getElementById('rawUrls');
const since2Input = document.getElementById('since2');
const sort2Select = document.getElementById('sort2');
const runFormat   = document.getElementById('runFormat');

const fmtSelect   = document.getElementById('format');
const postSortSel = document.getElementById('postSort');
const windowDays  = document.getElementById('windowDays');
const startNumInp = document.getElementById('startNum');

const outTA       = document.getElementById('out');
const copyBtn     = document.getElementById('copy');
const dlCsvBtn    = document.getElementById('dlCsv');
const statusEl    = document.getElementById('status');
const countEl     = document.getElementById('count');
const previewWrap = document.getElementById('previewWrap');
const previewDiv  = document.getElementById('preview');

/* ==== ç›´è¿‘ã®çµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆæ•´å½¢å¾Œä¸¦ã³æ›¿ãˆã«ä½¿ã†ï¼‰ ==== */
let lastRows = [];       // {url, viewCount, likeCount, commentCount, title, publishedAt, channelId, __idx}
let lastChannel = null;  // {id,title,url,avatar,subscriberCount,viewCount,videoCount}

/* ================== ä¿å­˜/å¾©å…ƒ ================== */
apiKeyInput.value = localStorage.getItem('yt_api_key') || DEFAULT_API_KEY || '';
appUrlInput.value = localStorage.getItem('yt_app_url') || '';
document.getElementById('saveKey').onclick = () => {
  localStorage.setItem('yt_api_key', apiKeyInput.value.trim());
  flash('APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
};
appUrlInput.addEventListener('change', () => {
  localStorage.setItem('yt_app_url', appUrlInput.value.trim());
});

/* ================== ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ ================== */
function getApiMode(){ return document.querySelector('input[name="mode"]:checked').value; }
function getWorkMode(){ return document.querySelector('input[name="work"]:checked').value; }

for (const r of document.querySelectorAll('input[name="mode"]')) r.addEventListener('change', syncVisibility);
for (const r of document.querySelectorAll('input[name="work"]')) r.addEventListener('change', () => { syncVisibility(); clearOutput(); });

function syncVisibility(){
  const apiMode  = getApiMode();
  const workMode = getWorkMode();
  apiRow.classList.toggle('hide', apiMode !== 'client');
  gasRow.classList.toggle('hide', apiMode !== 'gas');
  collectBox.classList.toggle('hide', workMode !== 'collect');
  formatBox.classList.toggle('hide', workMode !== 'format');
}
syncVisibility();

/* ================== å®Ÿè¡Œï¼ˆå–å¾—ãƒ¢ãƒ¼ãƒ‰ï¼‰ ================== */
runCollect.onclick = async () => {
  const apiMode = getApiMode();
  const raw  = channelInput.value.trim();
  const max  = Math.max(1, Math.min(5000, Number(limitInput.value) || 200));
  const since= sinceInput.value;
  const sort = sortSelect.value;
  if (!raw) return alert('ãƒãƒ£ãƒ³ãƒãƒ«/ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ/URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

  try {
    setBusy(true); setCount('â€”');
    let rows = [], channel = null;

    if (apiMode === 'gas') {
      const app = validateExecUrlOrThrow(appUrlInput.value.trim());
      const payload = await runViaGAS(app, raw, { max, since, sort });
      rows = payload.rows; channel = payload.channel || null;
    } else {
      const key = getKeyOrThrow();
      const { rows: rws, channel: ch } = await runViaClient(key, raw, { max, since, sort });
      rows = rws; channel = ch;
    }

    lastRows = rows.map((r, i) => ({ ...r, __idx: i }));
    lastChannel = channel;

    rerenderFromCache();
    flash(`${rows.length}ä»¶ã‚’æ•´å½¢ã—ã¾ã—ãŸ`);
  } catch (e) {
    console.error(e);
    clearOutput();
    alert('ã‚¨ãƒ©ãƒ¼: ' + (e.message || e));
  } finally {
    setBusy(false);
  }
};

/* ================== å®Ÿè¡Œï¼ˆæ•´å½¢ãƒ¢ãƒ¼ãƒ‰ï¼‰ ================== */
runFormat.onclick = async () => {
  const text = rawUrlsTA.value;
  const ids  = extractVideoIds(text);
  if (!ids.length) return alert('å‹•ç”»URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');

  const key   = getKeyOrThrow();
  const since = since2Input.value;
  const sort  = sort2Select.value;

  try {
    setBusy(true); setCount('â€”');
    const details = await fetchVideosDetails(ids, key); // Map<id,{title,viewCount,likeCount,commentCount,publishedAt,channelId}>
    let rows = ids.map((id, i) => {
      const d = details.get(id) || {};
      return {
        url:`https://www.youtube.com/watch?v=${id}`,
        viewCount:d.viewCount ?? null,
        likeCount:d.likeCount ?? null,
        commentCount:d.commentCount ?? null,
        title:d.title ?? '',
        publishedAt:d.publishedAt ?? '',
        channelId:d.channelId || '',
        __idx:i
      };
    });
    rows = applySinceAndSort(rows, { since, sort });

    // åŒä¸€ãƒãƒ£ãƒ³ãƒãƒ«ã®ã¿çµ±è¨ˆè¡¨ç¤º
    let channel = null;
    const setCh = new Set(rows.map(r=>r.channelId).filter(Boolean));
    if (setCh.size === 1) channel = await fetchChannelInfo(Array.from(setCh)[0], key);

    lastRows = rows;
    lastChannel = channel;

    rerenderFromCache();
    flash(`${rows.length}ä»¶ã‚’æ•´å½¢ã—ã¾ã—ãŸ`);
  } catch(e){
    console.error(e);
    clearOutput();
    alert('ã‚¨ãƒ©ãƒ¼: ' + (e.message || e));
  } finally {
    setBusy(false);
  }
};

/* ================== æ•´å½¢å¾Œã®ä¸¦ã³æ›¿ãˆï¼†å†æç”» ================== */
postSortSel.addEventListener('change', rerenderFromCache);
fmtSelect.addEventListener('change', rerenderFromCache);
startNumInp.addEventListener('input', rerenderFromCache);
windowDays.addEventListener('input', rerenderFromCache);

function rerenderFromCache(){
  const startNo = Math.max(1, Number(startNumInp.value)||1);
  const postSort = postSortSel.value;
  const win = Math.max(1, Number(windowDays.value)||28);

  // ç”±æ¥ä¸å¤‰ã®ä¸¦ã³ã‚’å®ˆã‚Œã‚‹ã‚ˆã† __idx ã‚’ä¿æŒã—ã¤ã¤ã‚³ãƒ”ãƒ¼
  let rows = lastRows.map(r => ({ ...r }));

  // æ¨æ´¾ç”ŸæŒ‡æ¨™ã‚’è¨ˆç®—
  rows = computeDerivedMetrics(rows, win);

  // æ•´å½¢å¾Œä¸¦ã³æ›¿ãˆ
  rows = applyPostSort(rows, postSort);

  const text = rowsToFormattedText(rows, fmtSelect.value, startNo, lastChannel, win);
  outTA.value = text;
  setCount(rows.length);
  renderPreview(text);
}

function computeDerivedMetrics(rows, winDays){
  const now = Date.now();
  return rows.map(r=>{
    const t = new Date(r.publishedAt || 0).getTime();
    const age = isFinite(t) ? Math.max((now - t) / 86400000, 1/24) : NaN; // æ—¥ï¼ˆæœ€å°1æ™‚é–“ç›¸å½“ï¼‰
    const views = (r.viewCount==null || isNaN(r.viewCount)) ? NaN : Number(r.viewCount);
    const avgPerDay = isNaN(views) || isNaN(age) ? NaN : (views/age);
    const growth = isNaN(avgPerDay) ? NaN : (avgPerDay * Math.min(winDays, Math.max(age,0)));
    return { ...r, __ageDays: age, __avgPerDay: avgPerDay, __growthWin: growth };
  });
}

function applyPostSort(rows, postSort){
  const byNum = (field, asc=true) => (a,b)=>{
    const av = Number(a[field]); const bv = Number(b[field]);
    const aNaN = isNaN(av); const bNaN = isNaN(bv);
    if (aNaN && bNaN) return a.__idx - b.__idx;
    if (aNaN) return 1;
    if (bNaN) return -1;
    return asc ? (av - bv) : (bv - av);
  };
  switch(postSort){
    case 'viewsDesc': return rows.sort(byNum('viewCount', false));
    case 'viewsAsc' : return rows.sort(byNum('viewCount', true));
    case 'likesDesc': return rows.sort(byNum('likeCount', false));
    case 'likesAsc' : return rows.sort(byNum('likeCount', true));
    case 'commentsDesc': return rows.sort(byNum('commentCount', false));
    case 'commentsAsc' : return rows.sort(byNum('commentCount', true));
    case 'avgDesc': return rows.sort(byNum('__avgPerDay', false));
    case 'avgAsc' : return rows.sort(byNum('__avgPerDay', true));
    case 'growthDesc': return rows.sort(byNum('__growthWin', false));
    case 'growthAsc' : return rows.sort(byNum('__growthWin', true));
    default: return rows.sort((a,b)=> a.__idx - b.__idx); // å…¥åŠ›é †
  }
}

/* ================== ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆHTMLã®ã¿ï¼‰ ================== */
function renderPreview(text){
  if (!/^html-/.test(fmtSelect.value)) { previewWrap.open=false; previewDiv.innerHTML=''; return; }
  previewDiv.innerHTML = text;
}

/* ================== å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ================== */
function clearOutput(){ outTA.value=''; setCount(0); renderPreview(''); }
function setBusy(b, msg){ statusEl.textContent = b ? (msg || 'å‡¦ç†ä¸­â€¦') : ''; }
function flash(msg){ statusEl.textContent = msg; setTimeout(()=> statusEl.textContent='', 1600); }
function setCount(n){ countEl.textContent = (n==='â€”') ? 'â€”' : `${Number(n)||0} ä»¶`; }
function getKeyOrThrow(){ const key = apiKeyInput.value.trim(); if (!key) throw new Error('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return key; }

/* ==== ç›´æ¥APIï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰ ==== */
async function runViaClient(key, raw, {max, since, sort}) {
  const channelId = await resolveChannelIdSmart(raw, key);
  if (!channelId) throw new Error('ãƒãƒ£ãƒ³ãƒãƒ«IDã‚’è§£æ±ºã§ãã¾ã›ã‚“ã§ã—ãŸ');

  const [uploads, channel] = await Promise.all([
    getUploadsPlaylistId(channelId, key),
    fetchChannelInfo(channelId, key)
  ]);
  if (!uploads) throw new Error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');

  const videoIds = await listPlaylistVideoIds(uploads, key, max);
  const details  = await fetchVideosDetails(videoIds, key);
  let rows = videoIds.map((id, i) => {
    const d = details.get(id) || {};
    return {
      url:`https://www.youtube.com/watch?v=${id}`,
      viewCount:d.viewCount ?? null,
      likeCount:d.likeCount ?? null,
      commentCount:d.commentCount ?? null,
      title:d.title ?? '',
      publishedAt:d.publishedAt ?? '',
      channelId:d.channelId || '',
      __idx:i
    };
  });
  rows = applySinceAndSort(rows, { since, sort });
  return { rows, channel };
}

/* ==== GASçµŒç”±ï¼ˆå–å¾—ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰ ==== */
async function runViaGAS(appUrl, channelInput, {max, since, sort}){
  const url = new URL(appUrl);
  url.searchParams.set('max', String(max));
  if (since) url.searchParams.set('since', since);
  if (/^UC[0-9A-Za-z_-]{22}$/.test(channelInput)) url.searchParams.set('channelId', channelInput);
  else url.searchParams.set('channel', channelInput);

  try {
    const json = await fetchJson(url.toString());
    return normalizeFromBackend(json, sort, since);
  } catch (_) {
    const json = await jsonpFetch(url);
    return normalizeFromBackend(json, sort, since);
  }
}
function normalizeFromBackend(json, sort, since){
  if (!json || json.ok === false) throw new Error(json?.error || 'GASå¿œç­”ã‚¨ãƒ©ãƒ¼');
  let rows = (json.items || []).map((it,i) => ({
    url: it.url || '',
    viewCount: (it.viewCount != null) ? Number(it.viewCount) : null,
    likeCount: (it.likeCount != null) ? Number(it.likeCount) : null,
    commentCount: (it.commentCount != null) ? Number(it.commentCount) : null,
    title: it.title || '',
    publishedAt: it.publishedAt || '',
    channelId: it.channelId || '',
    __idx: i
  }));
  rows = applySinceAndSort(rows, { since, sort });
  const channel = json.channel ? {
    id: json.channel.id || '',
    title: json.channel.title || '',
    url: json.channel.url || '',
    subscriberCount: (json.channel.subscriberCount!=null)? Number(json.channel.subscriberCount):null,
    viewCount: (json.channel.viewCount!=null)? Number(json.channel.viewCount):null,
    videoCount: (json.channel.videoCount!=null)? Number(json.channel.videoCount):null,
    avatar: json.channel.avatar || ''
  } : null;
  return { rows, channel };
}

/* ==== å–å¾—æ™‚ã®ä¸¦ã³æ›¿ãˆãƒ»ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆå…¬é–‹æ—¥ãƒ™ãƒ¼ã‚¹ï¼‰ ==== */
function applySinceAndSort(rows, {since, sort}) {
  if (since) {
    const t0 = new Date(`${since}T00:00:00Z`).getTime();
    if (isFinite(t0)) rows = rows.filter(r => {
      const t = new Date(r.publishedAt || 0).getTime();
      return isFinite(t) && t >= t0;
    });
  }
  if (sort === 'newest' || sort === 'oldest') {
    rows.sort((a,b) => {
      const ta = new Date(a.publishedAt || 0).getTime();
      const tb = new Date(b.publishedAt || 0).getTime();
      return sort === 'newest' ? (tb - ta) : (ta - tb);
    });
  }
  return rows;
}

/* ==== æ•´å½¢ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ï¼šä¸Šã«ãƒãƒ£ãƒ³ãƒãƒ«çµ±è¨ˆï¼‰ ==== */
function rowsToFormattedText(rows, fmt, startNo, channel, winDays){
  const num = (i)=> String(Math.max(1, startNo|0) + i);
  const fmtNum = (n, unit='') => (n==null || isNaN(n)) ? '' : Number(n).toLocaleString('ja-JP')+unit;
  const fmtFloat = (n)=> (n==null || isNaN(n)) ? '' : (Math.round(n*10)/10).toLocaleString('ja-JP');
  const ch = channel || null;

  const headHtml = ch ? (() => {
    const sub = fmtNum(ch.subscriberCount, 'äºº');
    const views = fmtNum(ch.viewCount, 'å›');
    const vids = fmtNum(ch.videoCount, 'æœ¬');
    const name = escapeHtml(ch.title||'');
    const url  = ch.url || (ch.id ? `https://www.youtube.com/channel/${ch.id}`:'');
    const img  = ch.avatar ? `<img src="${ch.avatar}" alt="" style="width:48px;height:48px;border-radius:999px;vertical-align:middle;margin-right:8px">` : '';
    return `<section style="margin:0 10px 12px 0;padding:10px;border:1px solid #eee;border-radius:8px">
      <div style="display:flex;align-items:center;gap:8px">
        ${img}
        <div>
          <div style="font-weight:700;font-size:1.1rem"><a href="${url}" target="_blank" rel="noopener">${name}</a></div>
          <div style="color:#666;font-size:.9rem">ç™»éŒ²è€…æ•°ï¼š${sub || '-'}ã€€ç·å†ç”Ÿå›æ•°ï¼š${views || '-'}ã€€å‹•ç”»æ•°ï¼š${vids || '-'}</div>
        </div>
      </div>
    </section>`;
  })() : '';

  const viewLine = (r) => {
    const views = (r.viewCount!=null)? Number(r.viewCount).toLocaleString('ja-JP')+'å›' : '-';
    const likes = (r.likeCount!=null)? Number(r.likeCount).toLocaleString('ja-JP') : '-';
    const comms = (r.commentCount!=null)? Number(r.commentCount).toLocaleString('ja-JP') : '-';
    const avg   = isNaN(r.__avgPerDay) ? '-' : `${fmtFloat(r.__avgPerDay)}/æ—¥`;
    const grow  = isNaN(r.__growthWin) ? '-' : `${Math.round(r.__growthWin).toLocaleString('ja-JP')}å›/æ¨å®š${winDays}æ—¥`;
    const date  = r.publishedAt ? r.publishedAt.slice(0,10) : '';
    return { views, likes, comms, avg, grow, date };
  };

  if (fmt === 'html-list' || fmt === 'html-cards') {
    if (fmt === 'html-list') {
      const items = rows.map((r,i)=>{
        const v = viewLine(r);
        return `<li style="margin:6px 0">
          <a href="${r.url}" target="_blank" rel="noopener" style="font-weight:600">${escapeHtml(r.title)}</a>
          â€” <a href="${r.url}" target="_blank" rel="noopener">${v.views}</a>
          â€” ğŸ‘ ${v.likes} â€” ğŸ’¬ ${v.comms} â€” ${v.avg} â€” ${v.grow}
          â€” <span style="color:#666">${escapeHtml(v.date)}</span>
        </li>`;
      }).join('');
      return `${headHtml}<ol start="${Math.max(1, startNo|0)}" style="padding-left:1.4em">${items}</ol>`;
    } else {
      // html-cards
      const cards = rows.map((r,i)=>{
        const no = num(i);
        const v = viewLine(r);
        return `<div style="border:1px solid #eee;border-radius:10px;padding:10px">
          <div style="font-size:.9rem;color:#666">#${no}</div>
          <div style="font-weight:700;margin:2px 0 6px"><a href="${r.url}" target="_blank" rel="noopener">${escapeHtml(r.title)}</a></div>
          <div style="color:#444">
            <a href="${r.url}" target="_blank" rel="noopener">${v.views}</a>ã€€|ã€€ğŸ‘ ${v.likes}ã€€|ã€€ğŸ’¬ ${v.comms}
          </div>
          <div style="color:#444">å¹³å‡/æ—¥ï¼š${v.avg}ã€€|ã€€æ¨å®šå¢—åˆ†ï¼š${v.grow}</div>
          <div style="color:#666">${escapeHtml(v.date)}</div>
        </div>`;
      }).join('');
      return `${headHtml}<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:10px">${cards}</div>`;
    }
  }

  if (fmt === 'md') {
    const header = ch ? `## [${ch.title||''}](${ch.url || (ch.id?`https://www.youtube.com/channel/${ch.id}`:'')})
ç™»éŒ²è€…æ•°ï¼š${fmtNum(ch.subscriberCount)}ã€€ç·å†ç”Ÿå›æ•°ï¼š${fmtNum(ch.viewCount)}ã€€å‹•ç”»æ•°ï¼š${fmtNum(ch.videoCount)}
` : '';
    const lines = rows.map((r,i)=>{
      const v = viewLine(r);
      return `${num(i)}. [${r.title}](${r.url}) â€” [${v.views}](${r.url}) â€” ğŸ‘ ${v.likes} â€” ğŸ’¬ ${v.comms} â€” å¹³å‡/æ—¥ ${v.avg} â€” æ¨å®šå¢—åˆ† ${v.grow} â€” ${v.date}`;
    }).join('\n');
    return header + lines;
  }

  // TSV / CSV
  const sep = (fmt==='csv') ? ',' : '\t';
  const esc = (s)=> {
    s = String(s??'');
    if (fmt==='csv' && /[",\n]/.test(s)) s = `"${s.replace(/"/g,'""')}"`;
    return s;
  };
  const head = ['No','URL','è¦–è´å›æ•°','é«˜è©•ä¾¡','ã‚³ãƒ¡ãƒ³ãƒˆ','å¹³å‡/æ—¥','æ¨å®šå¢—åˆ†(Næ—¥)','å…¬é–‹æ—¥','ã‚¿ã‚¤ãƒˆãƒ«'];
  const channelRows = ch ? [
    ['Channel Title', ch.title || ''],
    ['Channel URL', ch.url || (ch.id?`https://www.youtube.com/channel/${ch.id}`:'')],
    ['Subscribers', ch.subscriberCount!=null? Number(ch.subscriberCount).toLocaleString('ja-JP') : ''],
    ['Total Views', ch.viewCount!=null? Number(ch.viewCount).toLocaleString('ja-JP') : ''],
    ['Video Count', ch.videoCount!=null? Number(ch.videoCount).toLocaleString('ja-JP') : ''],
    ['',''], // ç©ºè¡Œ
    head
  ] : [head];

  const lines = channelRows.map(r=>r.map(esc).join(sep));
  rows.forEach((r,i)=>{
    const v = viewLine(r);
    lines.push([num(i), r.url, v.views.replace('å›',''), v.likes, v.comms, v.avg.replace('/æ—¥',''), v.grow.replace('å›/æ¨å®š'+winDays+'æ—¥',''), v.date, r.title].map(esc).join(sep));
  });
  return lines.join('\n');
}

/* ==== HTMLç”¨è£œåŠ© ==== */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

/* ==== ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰å‹•ç”»IDæŠ½å‡ºï¼ˆæ•´å½¢ãƒ¢ãƒ¼ãƒ‰ï¼‰ ==== */
function extractVideoIds(text){
  const set = new Set();
  const tokens = String(text||'').split(/[\s\n\r\t]+/).filter(Boolean);
  const re = /(?:v=|vi=|v%3D|youtu\.be\/|shorts\/|embed\/)([0-9A-Za-z_-]{11})/;
  for (const tk of tokens){
    if (/^https?:\/\//i.test(tk)) {
      try {
        const u = new URL(tk);
        const host = u.hostname.replace(/^www\./,'');
        const parts = u.pathname.replace(/\/+$/,'').split('/').filter(Boolean);
        let id = u.searchParams.get('v');
        if (!id && host==='youtu.be') id = parts[0];
        if (!id && ['shorts','embed','live'].includes(parts[0])) id = parts[1];
        if (id && /^[0-9A-Za-z_-]{11}$/.test(id)) { set.add(id); continue; }
      } catch {}
      const m = tk.match(re);
      if (m && m[1]) { set.add(m[1]); continue; }
    }
    if (/^[0-9A-Za-z_-]{11}$/.test(tk)) set.add(tk);
    else { const m = tk.match(re); if (m && m[1]) set.add(m[1]); }
  }
  return Array.from(set);
}

/* ==== Web API ==== */
async function fetchJson(u){
  const res = await fetch(u, {cache:'no-store',mode:'cors',credentials:'omit'});
  const ct  = (res.headers.get('content-type')||'').toLowerCase();
  const txt = await res.text();
  if (!res.ok) throw new Error(`HTTP ${res.status} / ${txt.slice(0,200)}`);
  if (!ct.includes('application/json')) throw new Error(`JSONä»¥å¤–ã®å¿œç­”: ${ct} / ${txt.slice(0,160)}`);
  return JSON.parse(txt);
}
function jsonpFetch(urlObj){
  return new Promise((resolve,reject)=>{
    const u = new URL(urlObj.toString());
    const cb = '__jsonp_cb_' + Date.now() + '_' + Math.floor(Math.random()*1e6);
    u.searchParams.set('callback', cb);
    const timer = setTimeout(()=>{cleanup();reject(new Error('JSONPã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ'));},15000);
    function cleanup(){clearTimeout(timer);try{delete window[cb];}catch{} if (script&&script.parentNode) script.parentNode.removeChild(script);}
    window[cb] = data => {cleanup();resolve(data);};
    const script = document.createElement('script');
    script.src = u.toString();
    script.onerror = ()=>{cleanup();reject(new Error('JSONPèª­è¾¼å¤±æ•—'));};
    document.head.appendChild(script);
  });
}

/* ==== YouTube API å‘¼ã³å‡ºã— ==== */
async function fetchChannelInfo(channelId, key){
  const ep = new URL('https://www.googleapis.com/youtube/v3/channels');
  ep.searchParams.set('part','snippet,statistics');
  ep.searchParams.set('id', channelId);
  ep.searchParams.set('key', key);
  const r = await fetch(ep); await assertOk_(r, 'channels(stats) API');
  const j = await r.json();
  const it = j.items?.[0];
  if (!it) return null;
  const sn = it.snippet || {}, st = it.statistics || {};
  return {
    id: it.id,
    title: sn.title || '',
    url: `https://www.youtube.com/channel/${it.id}`,
    avatar: sn.thumbnails?.default?.url || '',
    subscriberCount: st.subscriberCount!=null ? Number(st.subscriberCount) : null,
    viewCount:       st.viewCount!=null ? Number(st.viewCount) : null,
    videoCount:      st.videoCount!=null ? Number(st.videoCount) : null
  };
}

async function getChannelIdFromVideo(videoId, key) {
  const ep = new URL('https://www.googleapis.com/youtube/v3/videos');
  ep.searchParams.set('part','snippet');
  ep.searchParams.set('id', videoId);
  ep.searchParams.set('key', key);
  const r = await fetch(ep); await assertOk_(r, 'videos API');
  const j = await r.json();
  return j.items?.[0]?.snippet?.channelId || null;
}
async function getChannelIdFromPlaylist(playlistId, key) {
  const ep = new URL('https://www.googleapis.com/youtube/v3/playlists');
  ep.searchParams.set('part','snippet');
  ep.searchParams.set('id', playlistId);
  ep.searchParams.set('key', key);
  const r = await fetch(ep); await assertOk_(r, 'playlists API');
  const j = await r.json();
  return j.items?.[0]?.snippet?.channelId || null;
}
async function searchChannelIdByHandle(handle, key) {
  const ep = new URL('https://www.googleapis.com/youtube/v3/search');
  ep.searchParams.set('part','snippet');
  ep.searchParams.set('type','channel');
  ep.searchParams.set('q', handle);
  ep.searchParams.set('maxResults','1');
  ep.searchParams.set('key', key);
  const r = await fetch(ep); await assertOk_(r, 'search(handle) API');
  const j = await r.json();
  return j.items?.[0]?.id?.channelId || null;
}
async function searchChannelIdByQuery(query, key) {
  const ep = new URL('https://www.googleapis.com/youtube/v3/search');
  ep.searchParams.set('part','snippet');
  ep.searchParams.set('type','channel');
  ep.searchParams.set('q', query);
  ep.searchParams.set('maxResults','1');
  ep.searchParams.set('key', key);
  const r = await fetch(ep); await assertOk_(r, 'search(query) API');
  const j = await r.json();
  return j.items?.[0]?.id?.channelId || null;
}
async function getUploadsPlaylistId(channelId, key) {
  const ep = new URL('https://www.googleapis.com/youtube/v3/channels');
  ep.searchParams.set('part', 'contentDetails');
  ep.searchParams.set('id', channelId);
  ep.searchParams.set('key', key);
  const r = await fetch(ep); await assertOk_(r, 'channels API');
  const j = await r.json();
  return j.items?.[0]?.contentDetails?.relatedPlaylists?.uploads || null;
}
async function listPlaylistVideoIds(playlistId, key, maxCount) {
  let ids = []; let pageToken = '';
  while (ids.length < maxCount) {
    const ep = new URL('https://www.googleapis.com/youtube/v3/playlistItems');
    ep.searchParams.set('part', 'contentDetails');
    ep.searchParams.set('playlistId', playlistId);
    ep.searchParams.set('maxResults', '50');
    if (pageToken) ep.searchParams.set('pageToken', pageToken);
    ep.searchParams.set('key', key);
    const r = await fetch(ep); await assertOk_(r, 'playlistItems API');
    const j = await r.json();
    for (const it of (j.items || [])) {
      const id = it.contentDetails?.videoId;
      if (id) ids.push(id);
      if (ids.length >= maxCount) break;
    }
    pageToken = j.nextPageToken || '';
    if (!pageToken) break;
    setBusy(true, `å–å¾—ä¸­â€¦ ${ids.length}ä»¶`);
  }
  return ids;
}
async function fetchVideosDetails(videoIds, key) {
  const map = new Map();
  for (let i = 0; i < videoIds.length; i += 50) {
    const chunk = videoIds.slice(i, i + 50);
    const ep = new URL('https://www.googleapis.com/youtube/v3/videos');
    ep.searchParams.set('part', 'snippet,statistics');
    ep.searchParams.set('id', chunk.join(','));
    ep.searchParams.set('key', key);
    const r = await fetch(ep); await assertOk_(r, 'videos(details) API');
    const j = await r.json();
    for (const it of (j.items || [])) {
      map.set(it.id, {
        title: it.snippet?.title ?? '',
        viewCount: it.statistics?.viewCount != null ? Number(it.statistics.viewCount) : null,
        likeCount: it.statistics?.likeCount != null ? Number(it.statistics.likeCount) : null,
        commentCount: it.statistics?.commentCount != null ? Number(it.statistics.commentCount) : null,
        publishedAt: it.snippet?.publishedAt ?? '',
        channelId: it.snippet?.channelId || ''
      });
    }
  }
  return map;
}

/* ==== ãƒãƒ£ãƒ³ãƒãƒ«IDè§£æ±º ==== */
function looksLikeUrl(s){ return /^https?:\/\//i.test(String(s||'')); }
async function resolveChannelIdSmart(input, key) {
  const raw = String(input||'').trim(); if (!raw) return null;
  if (/^UC[0-9A-Za-z_-]{22}$/.test(raw)) return raw;
  if (/^[0-9A-Za-z_-]{11}$/.test(raw)) { const cid = await getChannelIdFromVideo(raw, key); if (cid) return cid; }
  if (raw.startsWith('@')) { const cid = await searchChannelIdByHandle(raw.slice(1), key); if (cid) return cid; }
  if (looksLikeUrl(raw)) {
    try {
      const u = new URL(raw);
      const host = u.hostname.replace(/^www\./,'');
      const parts = u.pathname.replace(/\/+$/,'').split('/').filter(Boolean);
      const vid = u.searchParams.get('v') || (['shorts','embed','live'].includes(parts[0]) ? parts[1] : null);
      if (host==='youtu.be' && parts[0]) { const cid = await getChannelIdFromVideo(parts[0].slice(0,11), key); if (cid) return cid; }
      if (vid) { const cid = await getChannelIdFromVideo(vid.slice(0,11), key); if (cid) return cid; }
      const list = u.searchParams.get('list'); if (list) { const cid = await getChannelIdFromPlaylist(list, key); if (cid) return cid; }
      const mCh = u.pathname.match(/\/channel\/(UC[0-9A-Za-z_-]{22})$/); if (mCh) return mCh[1];
      const mHandle = u.pathname.match(/\/@([^/]+)$/); if (mHandle) { const cid = await searchChannelIdByHandle(mHandle[1], key); if (cid) return cid; }
      const mCustom = u.pathname.match(/\/(c|user)\/([^/]+)$/); if (mCustom) { const cid = await searchChannelIdByQuery(mCustom[2], key); if (cid) return cid; }
    } catch {}
  }
  return await searchChannelIdByQuery(raw, key);
}

/* ==== ãƒ˜ãƒ«ãƒ‘ ==== */
async function assertOk_(res, label){
  if (res.ok) return;
  let detail=''; try{ detail=' / '+(await res.text()).slice(0,200);}catch{}
  throw new Error(`${label} ã‚¨ãƒ©ãƒ¼: ${res.status}${detail}`);
}
function validateExecUrlOrThrow(s){
  const m = String(s||'').match(/https?:\/\/script\.google\.com\/macros\/s\/[A-Za-z0-9_-]+\/exec/);
  if (!m) throw new Error('GASã® APP_URLï¼ˆ/execï¼‰ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
  return m[0];
}

/* ==== ä¾¿åˆ©ãƒœã‚¿ãƒ³ ==== */
copyBtn.onclick = async () => {
  try { await navigator.clipboard.writeText(outTA.value); flash('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); }
  catch { alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
};
dlCsvBtn.onclick = () => {
  const text = outTA.value || '';
  const blob = new Blob([new Uint8Array([0xEF,0xBB,0xBF]), text.replace(/\t/g, ',')], { type: 'text/csv' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `youtube_${Date.now()}.csv`; document.body.appendChild(a); a.click(); a.remove();
};
</script>
