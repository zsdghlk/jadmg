<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>YouTube 全件取得 — 見やすいテキスト出力（安全プロキシ版）</title>
<style>
  :root{
    --bg: #0b0c10;
    --panel: #121317cc;
    --panel-strong:#161821;
    --text: #eef2f7;
    --muted:#9aa0a6;
    --bd:#1f2128;
    --accent:#6ea8fe;
    --accent-2:#4f8cff;
    --ok:#1db954;
    --warn:#ffb020;
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#f6f7fb;
      --panel:#ffffffcc;
      --panel-strong:#ffffff;
      --text:#0a0b0f;
      --muted:#5d6269;
      --bd:#e6e8ee;
      --accent:#1e88e5;
      --accent-2:#1565c0;
      --ok:#0aa84f;
      --warn:#f5a623;
    }
  }
  *{ box-sizing: border-box }
  html,body{ height:100% }
  body{
    margin:0;
    background:
      radial-gradient(1200px 500px at 20% -10%, #2a3345 0%, transparent 60%),
      radial-gradient(1200px 500px at 100% 0%, #1a2233 0%, transparent 50%),
      var(--bg);
    color:var(--text);
    font: 16px/1.75 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .wrap{ max-width:1000px; margin:0 auto; padding:22px 18px 48px }
  header h1{
    margin: 6px 0 6px;
    font-size: clamp(18px, 4.5vw, 28px);
    letter-spacing:.2px;
  }
  header p{ margin: 6px 0 0; color:var(--muted); font-size: .95rem }
  .panel{
    background: var(--panel);
    border: 1px solid var(--bd);
    border-radius: 16px;
    padding: 16px;
    margin: 14px 0 18px;
    backdrop-filter: blur(8px) saturate(1.2);
  }
  .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center }
  .grid{ display:grid; gap:12px; grid-template-columns: 1fr }
  @media (min-width: 760px){ .grid.cols-2{ grid-template-columns: 1.4fr 1fr } }
  label{ display:block; font-weight:700; margin:2px 0 6px; font-size: .92rem }
  input,select,button{
    width:100%; padding:12px 13px;
    border-radius: 12px; outline: none;
    border:1px solid var(--bd);
    background: #0d0f14;
    color:var(--text);
  }
  @media (prefers-color-scheme: light){
    input,select,button{ background:#fff }
  }
  input::placeholder{ color: color-mix(in oklab, var(--muted) 85%, transparent) }
  .btn{
    background: linear-gradient(180deg, var(--accent), var(--accent-2));
    color:#fff; border: none; cursor: pointer; font-weight: 800;
    box-shadow: 0 6px 18px color-mix(in oklab, var(--accent-2) 35%, transparent);
    transition: transform .06s ease, filter .15s ease;
  }
  .btn:active{ transform: translateY(1px) scale(.998) }
  .btn:hover{ filter: brightness(1.03) }
  .status{ color:var(--muted); min-height:1.2em }
  .statbar{
    display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
    padding:12px 12px; border-radius:14px; border:1px dashed var(--bd);
    background: color-mix(in oklab, var(--panel-strong) 70%, transparent);
  }
  .ch-title{
    font-weight:900; font-size: clamp(16px, 3.8vw, 20px);
    display:flex; align-items:center; gap:10px;
  }
  .ch-title a{ color:inherit; text-decoration:none; border-bottom:1px dotted color-mix(in oklab, var(--text) 30%, transparent) }
  .chips{ display:flex; flex-wrap:wrap; gap:8px }
  .chip{
    border:1px solid var(--bd); border-radius:999px; padding:.4em .8em; background: transparent;
    font-weight:700; color:var(--muted);
  }
  .count{ background: color-mix(in oklab, var(--accent) 20%, transparent); color:#fff; border-color: transparent }
  ol.video-list{ list-style:none; margin: 10px 0 0; padding:0; counter-reset: vid }
  .v{
    position:relative; border:1px solid var(--bd); border-radius:14px; padding:12px 12px 10px; margin:12px 0;
    background: color-mix(in oklab, var(--panel-strong) 80%, transparent); display:grid; gap:6px
  }
  .v::before{
    counter-increment: vid; content: counter(vid);
    position:absolute; inset: -12px auto auto -12px;
    background: var(--ok); color:#fff; height:28px; min-width:28px; padding:0 8px;
    border-radius: 999px; display:grid; place-items:center; font-weight:900; font-size:.9rem;
    box-shadow: 0 6px 14px color-mix(in oklab, var(--ok) 40%, transparent);
  }
  .v a{ color: var(--accent); font-weight: 800; text-decoration: none; }
  .meta{ color: var(--muted); font-size:.92rem; display:flex; gap:10px; flex-wrap:wrap }
  .sep::before{ content:'•'; margin: 0 .5em; color: color-mix(in oklab, var(--muted) 70%, transparent) }
  .muted{ color:var(--muted) }
  .kbd{ font: 600 .85rem/1.1 ui-monospace, SFMono-Regular, Menlo, Consolas, "Noto Sans Mono", monospace; background:#07090d; color:#dbe6ff; padding: .35em .55em; border-radius: .5rem; border:1px solid var(--bd) }
  @media (prefers-color-scheme: light){ .kbd{ background:#fafafa; color:#001b4d } }
  .help{ font-size:.92rem }
  .fade-in{ animation: fade .24s ease both }
  @keyframes fade{ from{ opacity:0; transform: translateY(3px)} to{opacity:1; transform: translateY(0)} }
</style>

<div class="wrap">
  <header>
    <h1>YouTube 全件取得（安全プロキシ利用）</h1>
    <p class="help">URL を 1つ貼り付け → <span class="kbd">取得</span>。@ハンドル / UCID / チャンネルURL / 動画URL / プレイリストURL すべてOK。APIキーはサーバー保管なので表示されません。</p>
  </header>

  <!-- 入力とコントロール -->
  <section class="panel fade-in">
    <div class="grid cols-2">
      <div>
        <label>URL（チャンネル / 動画 / プレイリスト / @ハンドル / UCID）</label>
        <input id="inputUrl" placeholder="例）https://www.youtube.com/@Google | https://youtu.be/XXXXXXXXXXX | https://www.youtube.com/playlist?list=PL..." />
      </div>
      <div>
        <label>並び替え</label>
        <select id="postSort">
          <option value="none" selected>取得順のまま</option>
          <option value="viewsDesc">視聴回数 多い順</option>
          <option value="viewsAsc">視聴回数 少ない順</option>
          <option value="likesDesc">高評価 多い順</option>
          <option value="likesAsc">高評価 少ない順</option>
          <option value="commentsDesc">コメント 多い順</option>
          <option value="commentsAsc">コメント 少ない順</option>
          <option value="avgDesc">平均/日 多い順</option>
          <option value="avgAsc">平均/日 少ない順</option>
          <option value="newest">公開日 新しい順</option>
          <option value="oldest">公開日 古い順</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="run" class="btn" style="flex:1">取得</button>
      <div id="status" class="status" style="flex:2 1 200px"></div>
    </div>
  </section>

  <!-- チャンネル統計 / 件数 -->
  <section id="chPanel" class="panel fade-in" style="display:none">
    <div class="statbar">
      <div class="ch-title" id="chTitle">-</div>
      <div class="chips">
        <span class="chip" id="chipSubs">登録者数：-</span>
        <span class="chip" id="chipViews">総再生回数：-</span>
        <span class="chip" id="chipCount">動画数：-</span>
        <span class="chip count" id="chipGot">取得件数：0</span>
      </div>
    </div>
  </section>

  <!-- 出力 -->
  <section class="panel fade-in">
    <ol id="list" class="video-list"></ol>
  </section>

  <!-- ヘルプ -->
  <section class="panel fade-in help">
    <details>
      <summary class="muted">ヒント / セキュリティ</summary>
      <ul>
        <li>動画URLを貼ると、その動画の<strong>所属チャンネルの全動画</strong>を取得します。</li>
        <li>プレイリストURL/IDを貼ると、その<strong>プレイリストの全動画</strong>を取得します（チャンネル統計は表示されません）。</li>
        <li>上限は最大 5,000 本（APIクォータに注意）。</li>
        <li>APIキーはサーバー側のプロパティに保管し、フロント・ネットワークに露出しません。</li>
      </ul>
    </details>
  </section>
</div>

<script>
/* ========= 設定 ========= */
/** あなたの GAS WebアプリURL（末尾 /exec）に置き換えてください */
const API_BASE = '<<YOUR_GAS_WEBAPP_EXEC_URL>>';

/* ========= DOM ========= */
const inputUrl = document.getElementById('inputUrl');
const postSort = document.getElementById('postSort');
const runBtn   = document.getElementById('run');
const statusEl = document.getElementById('status');

const chPanel  = document.getElementById('chPanel');
const chTitle  = document.getElementById('chTitle');
const chipSubs = document.getElementById('chipSubs');
const chipViews= document.getElementById('chipViews');
const chipCount= document.getElementById('chipCount');
const chipGot  = document.getElementById('chipGot');
const listEl   = document.getElementById('list');

/* ========= 状態 ========= */
let lastRows = [];
let lastChannel = null;
const MAX_FETCH = 5000;

/* ========= JSONPユーティリティ ========= */
function jsonp(endpoint, params={}){
  const cbName = '__jp' + Math.random().toString(36).slice(2);
  return new Promise((resolve, reject)=>{
    const scr = document.createElement('script');
    const u = new URL(https://script.google.com/macros/s/AKfycbxhlGspw8fqZw9lZb340C6PV2N0OjtJgUq_4lfBjPwMAELQrgB0th-DeMPhRdAVjibA2g/exec);
    u.searchParams.set('op', endpoint);
    for (const [k,v] of Object.entries(params)) if (v!=null) u.searchParams.set(k, String(v));
    u.searchParams.set('callback', cbName);

    const timer = setTimeout(()=>{
      cleanup(); reject(new Error('JSONP timeout'));
    }, 30000);

    function cleanup(){
      clearTimeout(timer);
      delete window[cbName];
      scr.remove();
    }
    window[cbName] = (data)=>{
      cleanup();
      if (data && data.error) reject(new Error(data.error));
      else resolve(data);
    };
    scr.onerror = ()=>{ cleanup(); reject(new Error('JSONP network error')); };
    scr.src = u.toString();
    document.body.appendChild(scr);
  });
}

/* ========= UIハンドラ ========= */
runBtn.onclick = async () => {
  const raw = inputUrl.value.trim();
  if (!raw) return alert('URL を入力してください');
  try{
    busy(true, '解析中…');
    setChannel(null);
    renderRows([]);

    const {rows, channel} = await runViaProxy(raw);

    const sorted = sortAfter(rows, postSort.value);
    lastRows = sorted; lastChannel = channel;
    setChannel(channel, sorted.length);
    renderRows(sorted);
    toast(`${sorted.length} 件 取得しました`);
  }catch(err){
    console.error(err);
    setChannel(null);
    renderRows([]);
    alert('エラー: ' + (err?.message || err));
  }finally{
    busy(false);
  }
};

postSort.addEventListener('change', () => {
  if (!lastRows.length) return;
  const rows = sortAfter([...lastRows], postSort.value);
  renderRows(rows);
});

/* ========= プロキシ経由の処理 ========= */
async function runViaProxy(raw){
  const type = detectInputType(raw);

  // プレイリスト → そのまま全件
  if (type.kind === 'playlist'){
    const ids = await listPlaylistVideoIds_Proxy(type.playlistId, MAX_FETCH);
    const details = await fetchVideosDetails_Proxy(ids);
    const rows = ids.map((id,i)=> toRowFromDetail(details.get(id), id, i));
    return { rows, channel: null };
  }

  // チャンネル or 動画 → チャンネルIDへ
  let channelId = null;
  if (type.kind === 'channel') channelId = type.channelId;
  if (type.kind === 'video')   channelId = await getChannelIdFromVideo_Proxy(type.videoId);
  if (type.kind === 'channelQuery'){
    channelId = await searchChannelIdByQuery_Proxy(type.q);
  }
  if (!channelId) throw new Error('チャンネルIDを解決できませんでした');

  const [uploadsInfo, channel] = await Promise.all([
    getUploadsPlaylistId_Proxy(channelId),
    fetchChannelInfo_Proxy(channelId)
  ]);
  if (!uploadsInfo?.uploads) throw new Error('アップロード済みプレイリストが見つかりませんでした');

  const ids = await listPlaylistVideoIds_Proxy(uploadsInfo.uploads, MAX_FETCH);
  const details = await fetchVideosDetails_Proxy(ids);
  const rows = ids.map((id,i)=> toRowFromDetail(details.get(id), id, i));
  return { rows, channel };
}

/* ========= 入力タイプ検出（そのまま流用） ========= */
function detectInputType(raw){
  const s = String(raw||'').trim();
  if (!s) return { kind:'unknown' };
  if (/^UC[0-9A-Za-z_-]{22}$/.test(s)) return { kind:'channel', channelId:s };
  if (s.startsWith('@')) return { kind:'channelQuery', q:s.slice(1) };
  if (/^https?:\/\//i.test(s)){
    try{
      const u = new URL(s);
      const host = u.hostname.replace(/^www\./,'');
      const parts = u.pathname.replace(/\/+$/,'').split('/').filter(Boolean);
      const vid = u.searchParams.get('v') || (['shorts','embed','live'].includes(parts[0]) ? parts[1] : null);
      const list = u.searchParams.get('list');
      if (host==='youtu.be' && parts[0]) return { kind:'video', videoId: parts[0].slice(0,11) };
      if (vid) return { kind:'video', videoId: vid.slice(0,11) };
      if (list) return { kind:'playlist', playlistId: list };
      const mCh = u.pathname.match(/\/channel\/(UC[0-9A-Za-z_-]{22})$/);
      if (mCh) return { kind:'channel', channelId:mCh[1] };
      const mHandle = u.pathname.match(/\/@([^/]+)$/);
      if (mHandle) return { kind:'channelQuery', q:mHandle[1] };
      const mCustom = u.pathname.match(/\/(c|user)\/([^/]+)$/);
      if (mCustom) return { kind:'channelQuery', q:mCustom[2] };
    }catch{}
  }
  if (/^[0-9A-Za-z_-]{11}$/.test(s)) return { kind:'video', videoId:s };
  return { kind:'channelQuery', q:s };
}

/* ========= プロキシAPI呼び出し ========= */
async function fetchChannelInfo_Proxy(channelId){
  const r = await jsonp('channelInfo', { id: channelId });
  return r?.data || null;
}
async function getChannelIdFromVideo_Proxy(videoId){
  const r = await jsonp('channelFromVideo', { id: videoId });
  return r?.channelId || null;
}
async function getUploadsPlaylistId_Proxy(channelId){
  const r = await jsonp('uploads', { id: channelId });
  return r?.data || null; // { uploads: 'UU...' }
}
async function listPlaylistVideoIds_Proxy(playlistId, maxCount){
  let ids = [], pageToken = '';
  while (ids.length < Math.min(maxCount, MAX_FETCH)){
    const r = await jsonp('playlistItems', { playlistId, pageToken });
    const chunk = (r?.items||[]).map(it=> it?.contentDetails?.videoId).filter(Boolean);
    ids.push(...chunk);
    pageToken = r?.nextPageToken || '';
    if (!pageToken) break;
    busy(true, `取得中… ${ids.length}件`);
  }
  return ids.slice(0, Math.min(maxCount, MAX_FETCH));
}
async function fetchVideosDetails_Proxy(videoIds){
  const map = new Map();
  for (let i=0;i<videoIds.length;i+=50){
    const chunk = videoIds.slice(i,i+50).join(',');
    const r = await jsonp('videos', { ids: chunk });
    for (const it of (r?.items||[])){
      map.set(it.id, {
        title: it.snippet?.title ?? '',
        viewCount: it.statistics?.viewCount!=null? Number(it.statistics.viewCount):null,
        likeCount: it.statistics?.likeCount!=null? Number(it.statistics?.likeCount):null,
        commentCount: it.statistics?.commentCount!=null? Number(it.statistics?.commentCount):null,
        publishedAt: it.snippet?.publishedAt ?? ''
      });
    }
  }
  return map;
}
async function searchChannelIdByQuery_Proxy(query){
  const r = await jsonp('searchChannel', { q: query });
  return r?.channelId || null;
}

/* ========= 並び替えロジック（流用） ========= */
function sortAfter(rows, key){
  const byNum = (field, asc=true)=>(a,b)=>{
    const av=Number(a[field]), bv=Number(b[field]);
    const aNaN=isNaN(av), bNaN=isNaN(bv);
    if (aNaN && bNaN) return a.__idx-b.__idx;
    if (aNaN) return 1; if (bNaN) return -1;
    return asc? (av-bv):(bv-av);
  };
  switch(key){
    case 'viewsDesc': return rows.sort(byNum('viewCount', false));
    case 'viewsAsc' : return rows.sort(byNum('viewCount', true ));
    case 'likesDesc': return rows.sort(byNum('likeCount', false));
    case 'likesAsc' : return rows.sort(byNum('likeCount', true ));
    case 'commentsDesc': return rows.sort(byNum('commentCount', false));
    case 'commentsAsc' : return rows.sort(byNum('commentCount', true ));
    case 'avgDesc' : return rows.sort(byNum('__avgPerDay', false));
    case 'avgAsc'  : return rows.sort(byNum('__avgPerDay', true ));
    case 'newest'  : return rows.sort((a,b)=> new Date(b.publishedAt) - new Date(a.publishedAt));
    case 'oldest'  : return rows.sort((a,b)=> new Date(a.publishedAt) - new Date(b.publishedAt));
    default        : return rows.sort((a,b)=> a.__idx - b.__idx);
  }
}

/* ========= 描画 ========= */
function renderRows(rows){
  const now = Date.now();
  rows = rows.map(r=>{
    const t = new Date(r.publishedAt||0).getTime();
    const ageDays = isFinite(t)? Math.max((now - t)/86400000, 1/24): NaN;
    const views = (r.viewCount==null||isNaN(r.viewCount))? NaN : Number(r.viewCount);
    const avg = (isNaN(views)||isNaN(ageDays)) ? NaN : Math.round((views/ageDays)*10)/10;
    return {...r, __avgPerDay: avg};
  });

  listEl.innerHTML = '';
  chipGot.textContent = `取得件数：${rows.length}`;

  const frag = document.createDocumentFragment();
  rows.forEach((r, i) => {
    const li = document.createElement('li');
    li.className = 'v';

    const a = document.createElement('a');
    a.href = r.url;
    a.target = '_blank';
    a.rel = 'noopener';
    a.textContent = r.title || '(no title)';
    li.appendChild(a);

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.innerHTML = [
      `${fmtNum(r.viewCount)}回 再生`,
      (r.likeCount==null? '-' : `${fmtNum(r.likeCount)} 高評価`),
      (r.commentCount==null? '-' : `${fmtNum(r.commentCount)} コメント`),
      (r.__avgPerDay!=null && !isNaN(r.__avgPerDay) ? `平均/日 ${fmtNum(r.__avgPerDay)}` : '-'),
      (r.publishedAt ? new Date(r.publishedAt).toLocaleDateString('ja-JP') : '-')
    ].map((t,idx)=> idx===0 ? t : `<span class="sep"></span>${t}`).join('');
    li.appendChild(meta);

    frag.appendChild(li);
  });
  listEl.appendChild(frag);
}

function setChannel(ch, got=0){
  if (!ch){
    chPanel.style.display = 'none';
    chipGot.textContent = '取得件数：0';
    return;
  }
  chPanel.style.display = '';
  chTitle.innerHTML = `<a href="${ch.url}" target="_blank" rel="noopener">${esc(ch.title||'')}</a>`;
  chipSubs.textContent = `登録者数：${fmtNum(ch.subscriberCount)}人`;
  chipViews.textContent = `総再生回数：${fmtNum(ch.viewCount)}回`;
  chipCount.textContent = `動画数：${fmtNum(ch.videoCount)}本`;
  chipGot.textContent = `取得件数：${got}`;
}

/* ========= 小物 ========= */
function toRowFromDetail(d, id, i){
  return {
    url: `https://www.youtube.com/watch?v=${id}`,
    title: d?.title ?? '',
    viewCount: d?.viewCount ?? null,
    likeCount: d?.likeCount ?? null,
    commentCount: d?.commentCount ?? null,
    publishedAt: d?.publishedAt ?? '',
    videoId: id,
    __idx: i
  };
}
function busy(b, msg){
  runBtn.disabled = b;
  statusEl.textContent = b ? (msg || '取得中…') : '';
}
function toast(msg){
  statusEl.textContent = msg;
  setTimeout(()=> statusEl.textContent = '', 1600);
}
function fmtNum(n){ return (n==null || isNaN(n)) ? '-' : Number(n).toLocaleString('ja-JP'); }
function esc(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
</script>
